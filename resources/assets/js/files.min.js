(function(e,t){e.Koowa||(e.Koowa={}),typeof exports=="object"?module.exports=t():typeof define=="function"&&define.amd?define(t):e.Koowa.Spinner=t()})(this,function(){"use strict";function r(e,t){var n=document.createElement(e||"div"),r;for(r in t)n[r]=t[r];return n}function i(e){for(var t=1,n=arguments.length;t<n;t++)e.appendChild(arguments[t]);return e}function o(e,r,i,o){var u=["opacity",r,~~(e*100),i,o].join("-"),a=.01+i/o*100,f=Math.max(1-(1-e)/r*(100-a),e),l=n.substring(0,n.indexOf("Animation")).toLowerCase(),c=l&&"-"+l+"-"||"";return t[u]||(s.insertRule("@"+c+"keyframes "+u+"{"+"0%{opacity:"+f+"}"+a+"%{opacity:"+e+"}"+(a+.01)+"%{opacity:1}"+(a+r)%100+"%{opacity:"+e+"}"+"100%{opacity:"+f+"}"+"}",s.cssRules.length),t[u]=1),u}function u(t,n){var r=t.style,i,s;n=n.charAt(0).toUpperCase()+n.slice(1);for(s=0;s<e.length;s++){i=e[s]+n;if(r[i]!==undefined)return i}if(r[n]!==undefined)return n}function a(e,t){for(var n in t)e.style[u(e,n)||n]=t[n];return e}function f(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)e[r]===undefined&&(e[r]=n[r])}return e}function l(e){var t={x:e.offsetLeft,y:e.offsetTop};while(e=e.offsetParent)t.x+=e.offsetLeft,t.y+=e.offsetTop;return t}function c(e,t){return typeof e=="string"?e:e[t%e.length]}function p(e){if(typeof this=="undefined")return new p(e);this.opts=f(e||{},p.defaults,h)}function d(){function e(e,t){return r("<"+e+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',t)}s.addRule(".spin-vml","behavior:url(#default#VML)"),p.prototype.lines=function(t,n){function o(){return a(e("group",{coordsize:s+" "+s,coordorigin:-r+" "+ -r}),{width:s,height:s})}function h(t,s,u){i(f,i(a(o(),{rotation:360/n.lines*t+"deg",left:~~s}),i(a(e("roundrect",{arcsize:n.corners}),{width:r,height:n.width,left:n.radius,top:-n.width>>1,filter:u}),e("fill",{color:c(n.color,t),opacity:n.opacity}),e("stroke",{opacity:0}))))}var r=n.length+n.width,s=2*r,u=-(n.width+n.length)*2+"px",f=a(o(),{position:"absolute",top:u,left:u}),l;if(n.shadow)for(l=1;l<=n.lines;l++)h(l,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(l=1;l<=n.lines;l++)h(l);return i(t,f)},p.prototype.opacity=function(e,t,n,r){var i=e.firstChild;r=r.shadow&&r.lines||0,i&&t+r<i.childNodes.length&&(i=i.childNodes[t+r],i=i&&i.firstChild,i=i&&i.firstChild,i&&(i.opacity=n))}}var e=["webkit","Moz","ms","O"],t={},n,s=function(){var e=r("style",{type:"text/css"});return i(document.getElementsByTagName("head")[0],e),e.sheet||e.styleSheet}(),h={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:"#000",direction:1,speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto",position:"relative"};p.defaults={},f(p.prototype,{spin:function(e){this.stop();var t=this,i=t.opts,s=t.el=a(r(0,{className:i.className}),{position:i.position,width:0,zIndex:i.zIndex}),o=i.radius+i.length+i.width,u,f;e&&(e.insertBefore(s,e.firstChild||null),f=l(e),u=l(s),a(s,{left:(i.left=="auto"?f.x-u.x+(e.offsetWidth>>1):parseInt(i.left,10)+o)+"px",top:(i.top=="auto"?f.y-u.y+(e.offsetHeight>>1):parseInt(i.top,10)+o)+"px"})),s.setAttribute("role","progressbar"),t.lines(s,t.opts);if(!n){var c=0,h=(i.lines-1)*(1-i.direction)/2,p,d=i.fps,v=d/i.speed,m=(1-i.opacity)/(v*i.trail/100),g=v/i.lines;(function y(){c++;for(var e=0;e<i.lines;e++)p=Math.max(1-(c+(i.lines-e)*g)%v*m,i.opacity),t.opacity(s,e*i.direction+h,p,i);t.timeout=t.el&&setTimeout(y,~~(1e3/d))})()}return t},stop:function(){var e=this.el;return e&&(clearTimeout(this.timeout),e.parentNode&&e.parentNode.removeChild(e),this.el=undefined),this},lines:function(e,t){function l(e,n){return a(r(),{position:"absolute",width:t.length+t.width+"px",height:t.width+"px",background:e,boxShadow:n,transformOrigin:"left",transform:"rotate("+~~(360/t.lines*s+t.rotate)+"deg) translate("+t.radius+"px"+",0)",borderRadius:(t.corners*t.width>>1)+"px"})}var s=0,u=(t.lines-1)*(1-t.direction)/2,f;for(;s<t.lines;s++)f=a(r(),{position:"absolute",top:1+~(t.width/2)+"px",transform:t.hwaccel?"translate3d(0,0,0)":"",opacity:t.opacity,animation:n&&o(t.opacity,t.trail,u+s*t.direction,t.lines)+" "+1/t.speed+"s linear infinite"}),t.shadow&&i(f,a(l("#000","0 0 4px #000"),{top:"2px"})),i(e,i(f,l(c(t.color,s),"0 0 1px rgba(0,0,0,.1)")));return e},opacity:function(e,t,n){t<e.childNodes.length&&(e.childNodes[t].style.opacity=n)}});var v=a(r("group"),{behavior:"url(#default#VML)"});return!u(v,"transform")&&v.adj?d():n=u(v,"animation"),p});if(!Files)var Files={};Files.Filesize=function(e){this.size=e},Files.Filesize.prototype.units=["B","KB","MB","GB","TB","PB"],Files.Filesize.prototype.humanize=function(){var e=0,t=this.size;while(t>=1024)t/=1024,e++;return(e===0||t%1===0?t:t.toFixed(2))+" "+Koowa.translate(this.units[e])},Files.FileTypes={},Files.FileTypes.map={audio:["aif","aiff","alac","amr","flac","ogg","m3u","m4a","mid","mp3","mpa","wav","wma"],video:["3gp","avi","flv","mkv","mov","mp4","mpg","mpeg","rm","swf","vob","wmv"],image:["bmp","gif","jpg","jpeg","png","psd","tif","tiff"],document:["doc","docx","rtf","txt","xls","xlsx","pdf","ppt","pptx","pps","xml"],archive:["7z","gz","rar","tar","zip"]},Files.getFileType=function(e){var t="document",n=Files.FileTypes.map;e=e.toLowerCase();for(var r in n)if(n.hasOwnProperty(r)){var i=n[r];if(i.indexOf(e)!=-1){t=r;break}}return t};if(!Files)var Files={};Files.State=new Class({Implements:Options,data:{},defaults:{},options:{defaults:{}},initialize:function(e){this.setOptions(e),this.options.data&&Object.append(this.data,this.options.data),this.options.defaults&&(Object.append(this.defaults,this.options.defaults),Object.append(this.data,this.defaults))},getData:function(){return this.data},setDefaults:function(){return this.set(this.defaults),this},set:function(e,t){return typeOf(e)=="object"?Object.append(this.data,e):this.data[e]=t,this},get:function(e,t){return this.data[e]||t},unset:function(e){delete this.data[e]}});if(!Files)var Files={};(function(){var e={};Files.Template=new Class({Implements:[Events],render:function(e){var t=this.template;e=e||"default",e!=="default"&&(t=e+"_"+t),this.fireEvent("beforeRender",{layout:e,template:t});var n=(new EJS({element:t})).render(this),r=new(Files.Template[e.capitalize()])(n);return this.fireEvent("afterRender",{layout:e,template:t,result:r}),r}}),Files.Template.Details=new Class({initialize:function(e){var t=(new Element("div",{html:e})).getElement("table");if(t)return t;var n="<table><tbody>"+e+"</tbody></table>";return(new Element("div",{html:n})).getElement("tr")}}),Files.Template.Default=new Class({initialize:function(e){return(new Element("div",{html:e})).getFirst()}}),Files.Template.Icons=new Class({initialize:function(e){return(new Element("div",{html:e})).getFirst()}}),Files.Template.Compact=new Class({initialize:function(e){return(new Element("div",{html:e})).getFirst()}})})();if(!Files)var Files={};Files.Grid=new Class({Implements:[Events,Options],layout:"icons",options:{onClickFolder:function(){},onClickFile:function(){},onClickImage:function(){},onDeleteNode:function(){},onSwitchLayout:function(){},switchers:".files-layout-switcher",layout:!1,batch_delete:!1,icon_size:150,types:null},initialize:function(e,t){this.setOptions(t),this.nodes=new Hash,this.container=document.id(e),this.options.switchers&&(this.options.switchers=document.getElements(this.options.switchers)),this.options.batch_delete&&(this.options.batch_delete=document.getElement(this.options.batch_delete)),this.options.layout&&this.setLayout(this.options.layout),this.render(),this.attachEvents()},attachEvents:function(){var e=this,t=function(t,n){e.container.addEvent(t,function(t){t.stop(),e.fireEvent(n,arguments)})};t("click:relay(.files-folder a.navigate)","clickFolder"),t("click:relay(.files-file a.navigate)","clickFile"),t("click:relay(.files-image a.navigate)","clickImage");var n=function(t){if(t.target.match("a.navigate"))return;t.target.get("tag")=="input"&&t.target.setProperty("checked",!t.target.getProperty("checked"));var n=t.target.getParent(".files-node-shadow");n||(n=t.target.match(".files-node")?t.target:t.target.getParent(".files-node")),e.checkNode(n.retrieve("row"))};this.container.addEvent("click:relay(div.imgOutline)",n.bind(this)),this.container.addEvent("click:relay(input.files-select)",n.bind(this)),this.container.addEvent("click",function(t){if(e.layout!=="details")return;var n=t.target;if(n.get("tag")==="a"||n.get("tag")==="input")return;if(n.get("tag")==="i"&&n.hasClass("icon-download"))return;var r=n.getParent(".files-node-shadow")||n.getParent(".files-node");r&&(row=r.retrieve("row"),row&&e.checkNode(row))});var r=function(e){e.stop&&e.stop();var t=e.target.getParent(".files-node-shadow");t||(t=e.target.match(".files-node")?e.target:e.target.getParent(".files-node")),this.erase(t.retrieve("row").path)}.bind(this);this.container.addEvent("click:relay(.delete-node)",r),e.addEvent("afterDeleteNodeFail",function(e){var t=e.xhr,n=JSON.decode(t.responseText,!0);n&&n.error&&alert(n.error)});if(this.options.batch_delete){var i=new Chain,s=function(){i.callChain()};this.addEvent("afterCheckNode",function(){var e=this.container.getElements("input[type=checkbox]:checked");this.options.batch_delete.setProperty("disabled",!e.length)}.bind(this)),this.options.batch_delete.addEvent("click",function(t){t.stop();var n=0,o=[],u=0,a=[],f=this.container.getElements("input[type=checkbox]:checked.files-select").filter(function(e){if(e.checked){var t=e.getParent(".files-node-shadow")||e.getParent(".files-node"),r=t.retrieve("row").name;return e.getParent(".files-node").hasClass("files-folder")?(u++,a.push(r)):(n++,o.push(r)),!0}}),l="";if(n+u===1)l=Koowa.translate("You are deleting {item}. Are you sure?",{item:u?a[0]:o[0]});else{var c=n+u,h=Koowa.translate("{count} files and folders");l=Koowa.translate("You are deleting {items}. Are you sure?"),!u&&n?h=Koowa.translate("{count} files"):u&&!n&&(h=Koowa.translate("{count} folders")),h=h.replace("{count}",c),l=l.replace("{items}",h)}if(!f.length||!confirm(l))return!1;e.addEvent("afterDeleteNode",s),e.addEvent("afterDeleteNodeFail",s),f.each(function(e){if(!e.checked)return;i.chain(function(){r({target:e})})}),i.chain(function(){e.removeEvent("afterDeleteNode",s),e.removeEvent("afterDeleteNodeFail",s),i.clearChain()}),i.callChain()}.bind(this))}this.options.switchers&&this.options.switchers.addEvent("click",function(t){t.stop();var n=this.get("data-layout");e.setLayout(n),e._updateSwitchers(n)});if(this.options.icon_size){var o=this.options.icon_size;this.addEvent("beforeRenderObject",function(e){e.object.icon_size=o})}this.container.addEvent("click:relay(th.files__sortable)",function(t){var n=t.target.match("th")?t.target:t.target.getParent("th"),r={sort:n.get("data-name"),direction:"asc"};n.hasClass("files__sortable--sorted")&&(r.direction="desc"),e.setState(r),e.fireEvent("setState",r)});var u=kQuery(".search_button","#files-canvas"),a=function(t){var n={search:typeof t=="undefined"?u.val():t};e.setState(n),e.fireEvent("setState",n)};u.blur(function(){a()}).keypress(function(e){e.which===13&&a()}),kQuery(".search_button--empty","#files-canvas").click(function(){u.val()&&a("")})},setState:function(e){if(typeof e.search!="undefined"){var t=document.id("files-canvas").getElement(".search_button");t&&t.set("value",e.search)}var n=this.container.getElements("th.files__sortable"),r=n.filter('[data-name="'+e.sort+'"]')[0];if(!r)return;n.removeClass("files__sortable--sorted").removeClass("files__sortable--sorted-desc"),r.addClass("files__sortable--sorted"+(e.direction==="asc"?"":"-desc"))},checkNode:function(e,t){var n=e.element,r=e.element.match(".files-node")?e.element:e.element.getElement(".files-node"),i=n.getElement("input[type=checkbox]");t!==!1&&this.fireEvent("beforeCheckNode",{row:e,checkbox:i});var s=i.getProperty("checked");s?r.removeClass("selected"):r.addClass("selected"),e.checked=!s,i.setProperty("checked",!s);var o=r.getParent("tbody");if(o){var u=o.getElements(".selected").length;u===1?o.addClass("selected-single").removeClass("selected-multiple"):u>1?o.addClass("selected-multiple").removeClass("selected-single"):o.removeClass("selected-multiple").removeClass("selected-single")}t!==!1&&this.fireEvent("afterCheckNode",{row:e,checkbox:i})},erase:function(e){typeof e=="string"&&(e=this.nodes.get(e));if(e){this.fireEvent("beforeDeleteNode",{node:e});var t=function(){e.element&&e.element.dispose(),this.nodes.erase(e.path),this.fireEvent("afterDeleteNode",{node:e})}.bind(this),n=function(t){this.fireEvent("afterDeleteNodeFail",{node:e,xhr:t})}.bind(this);e["delete"](t,n)}},render:function(){this.fireEvent("beforeRender"),this.container.empty(),this.root=new Files.Grid.Root(this.layout),this.container.adopt(this.root.element),this.renew(),this.fireEvent("afterRender")},renderObject:function(e,t){t=t||"alphabetical",this.fireEvent("beforeRenderObject",{object:e,position:t}),e.element=e.render(this.layout),e.element.store("row",e);if(t=="last")this.root.adopt(e.element,"bottom");else if(t=="first")this.root.adopt(e.element);else{var n=this.nodes.filter(function(t){return t.type==e.type}).getKeys();if(n.length===0)if(e.type==="folder"){var r=this.nodes.getKeys();if(r.length){var i=this.nodes.get(r[0]);e.element.inject(i.element,"before")}else this.root.adopt(e.element,"bottom")}else this.root.adopt(e.element,"bottom");else{n.push(e.path),n=n.sort();var s=n.indexOf(e.path),o=n.length;if(s===0){var i=this.nodes.get(n[1]);e.element.inject(i.element,"before")}else{var i=s+1===o?n[o-2]:n[s-1];i=this.nodes.get(i),e.element.inject(i.element,"after")}}}return this.fireEvent("afterRenderObject",{object:e,position:t}),e.element},reset:function(){this.fireEvent("beforeReset"),this.nodes.each(function(e){e.element&&e.element.dispose(),this.nodes.erase(e.path)}.bind(this)),this.fireEvent("afterReset")},insert:function(e,t){this.fireEvent("beforeInsertNode",{object:e,position:t});if(!this.options.types||this.options.types.contains(e.type))this.renderObject(e,t),this.nodes.set(e.path,e),this.fireEvent("afterInsertNode",{node:e,position:t})},insertRows:function(e){this.fireEvent("beforeInsertRows",{rows:e}),Object.each(e,function(e){var t=Files[e.type.capitalize()],n=new t(e);this.insert(n,"last")}.bind(this)),this.options.icon_size&&this.setIconSize(this.options.icon_size),this.fireEvent("afterInsertRows",{rows:e})},renew:function(){this.fireEvent("beforeRenew");var e=this.getFolders(),t=this.getFiles(),n=this,r=function(e){var e=n.nodes.get(e);e.element&&e.element.dispose(),n.renderObject(e,"last"),e.checked&&n.checkNode(e,!1)};e.each(r),t.each(r),this.fireEvent("afterRenew")},setLayout:function(e){e&&(this.fireEvent("beforeSetLayout",{layout:e}),this.layout=e,this.options.switchers&&this._updateSwitchers(e),this.fireEvent("afterSetLayout",{layout:e}),this.render())},getFolders:function(){return this.nodes.filter(function(e){return e.type==="folder"}).getKeys().sort()},getFiles:function(){return this.nodes.filter(function(e){return e.type==="file"||e.type=="image"}).getKeys().sort()},setIconSize:function(e){this.fireEvent("beforeSetIconSize",{size:e}),this.options.icon_size=e,this.nodes.getKeys().length&&this.layout=="icons"&&(this.container.getElements(".imgTotal").setStyles({width:e+"px",height:e*.75+"px"}),this.container.getElements(".imgOutline .ellipsis").setStyle("width",e+"px")),this.fireEvent("afterSetIconSize",{size:e})},spin:function(){if(this.is_spinning)return;var e=document.getElementById("spinner_container"),t={lines:12,length:7,width:4,radius:10,color:"#666",speed:1,trail:60};this.spinner=new Koowa.Spinner(t),this.is_spinning=!0;var n=this.spinner.spin(e);return n},unspin:function(){this.spinner&&(this.is_spinning=!1,this.spinner.stop())},_updateSwitchers:function(e){this.options.switchers.removeClass("active").filter(function(t){return t.get("data-layout")==e}).addClass("active")}}),Files.Grid.Root=new Class({Implements:Files.Template,template:"container",initialize:function(e){this.element=this.render(e)},adopt:function(e,t){t=t||"top";var n=this.element;this.element.get("tag")=="table"&&(n=this.element.getElement("tbody")),e.injectInside||(e.injectInside=e.inject),e.injectInside(n,t)}});if(!Files)var Files={};(function(e){Files.Tree=Koowa.Tree.extend({getDefaults:function(){var t=this,n={initial_response:!1,autoOpen:0,onSelectNode:function(){},dataFilter:function(e){return t.filterData(e)}};return e.extend(!0,{},this.supr(),n)},filterData:function(e){var t=e.data,n=function(e,t){typeof e.attributes!="undefined"&&(e=e.attributes),delete e.attributes;var r=t&&t.path?t.path+"/":"";r+=e.name,e.id=r,e.path=r,e.url="#"+r,e.type="folder";if(e.children){var i=[];Object.each(e.children,function(t){i.push(n(t,e))}),e.children=i}return e};return e.meta.total&&Object.each(t,function(e,r){t[r]=n(e)}),this.parseData(t)},parseData:function(e){return[{label:this.options.root.text,url:"#",children:e}]},fromUrl:function(e){var t=this;this.tree("loadDataFromUrl",e,null,function(e){Files.app&&Files.app.hasOwnProperty("active")&&t.selectPath(Files.app.active)})},selectPath:function(e){var t=this.tree("getNodeById",e);if(!t){var n=this.tree("getTree");t=n.children.length?n.children[0]:null}this.tree("selectNode",t)},appendNode:function(t,n){n===undefined&&(n=this.tree("getSelectedNode")),n===!1&&(n=this.tree("getTree").children[0]);var r,i=e.extend(!0,{},t,{path:t.id,url:"#"+t.id,type:"folder"});if(n&&n.children&&n.children.length){var s=i.label.toLowerCase();if(n.children[0].name.toLowerCase()>s)r=this.tree("addNodeBefore",i,n.children[0]);else if(n.children[n.children.length-1].name.toLowerCase()<s)r=this.tree("appendNode",i,n);else{var o=0;while(n.children[o].name.toLowerCase()<s)o++;r=this.tree("addNodeBefore",i,n.children[o])}}else r=this.tree("appendNode",i,n);return this.tree("selectNode",r),this},removeNode:function(e){var t=this.tree("getNodeById",e);t&&this.tree("removeNode",t)},attachHandlers:function(){this._attachHandlers();var t=this.options,n=this,r=this.options.initial_response;this.element.bind({"tree.init":function(){n.element.on("tree.select",function(i){var s;i.node&&(s=e(i.node.element),n.tree("openNode",i.node),r?r=!1:t.onSelectNode(i.node)),i.node&&!i.node.hasOwnProperty("is_open")&&i.node.getLevel()===2&&n.scrollIntoView(i.node,n.element,300),n.element.one("resize",function(){n.tree("getSelectedNode")&&n.scrollIntoView(n.tree("getSelectedNode"),n.element,900)})})},"tree.open":function(e){n.scrollIntoView(e.node,n.element,300)}})}})})(window.kQuery);if(!Files)var Files={};Files.Row=new Class({Implements:[Options,Events,Files.Template],initialize:function(e,t){this.setOptions(t),Object.each(e,function(e,t){this[t]=e}.bind(this)),typeof this.name!="string"&&(this.name=""),this.path||(this.path=(e.folder?e.folder+"/":"")+e.name),this.identifier=this.path,this.filepath=(e.folder?this.encodePath(e.folder)+"/":"")+this.encode(e.name)},encodePath:function(e,t){var n=e.split("/");return t||(t=this.encode),n=n.map(function(e){return t(e)}),n.join("/")},encode:function(e){return e},realpath:function(e){return e}}),Files.File=new Class({Extends:Files.Row,type:"file",template:"file",initialize:function(e,t){this.parent(e,t),Files.app&&(this.baseurl=Files.app.baseurl),this.size=new Files.Filesize(this.metadata.size),this.filetype=Files.getFileType(this.metadata.extension)},getModifiedDate:function(e){if(this.metadata.modified_date){var t=new Date;return t.setTime(this.metadata.modified_date*1e3),e?t.getDate()+" "+Koowa.Date.getMonthName(t.getMonth()+1,!0)+" "+t.getFullYear():t}return null},"delete":function(e,t){this.fireEvent("beforeDeleteRow");var n=this,r=new Request.JSON({url:Files.app.createRoute({view:"file",folder:n.folder,name:n.name}),method:"post",data:{_action:"delete",csrf_token:Files.token},onSuccess:function(t){typeof e=="function"&&e(t),n.fireEvent("afterDeleteRow",{status:!0,response:t,request:this})},onFailure:function(e){if(e.status==204||e.status==1223)return this.onSuccess();response=e.responseText,typeof t=="function"?t(e):(response=JSON.decode(e.responseText,!0),error=response&&response.error?response.error:Koowa.translate("An error occurred during request"),alert(error)),n.fireEvent("afterDeleteRow",{status:!1,response:response,request:this,xhr:e})}});r.send()}}),Files.Image=new Class({Extends:Files.File,type:"image",template:"image",initialize:function(e,t){this.parent(e,t),this.image=this.baseurl+"/"+this.encodePath(this.filepath,this.realpath),this.client_cache=!1,window.sessionStorage&&sessionStorage[this.image.toString()]&&(this.client_cache=sessionStorage[this.image.toString()])},getThumbnail:function(e,t){var n=this,r=new Request.JSON({url:Files.app.createRoute({view:"thumbnail",filename:n.name,folder:n.folder}),method:"get",onSuccess:function(t,n){typeof e=="function"&&e(t)},onFailure:function(e){response=e.responseText,typeof t=="function"?t(e):(response=JSON.decode(e.responseText,!0),error=response&&response.error?response.error:Koowa.translate("An error occurred during request"),alert(error))}});r.send()}}),Files.Folder=new Class({Extends:Files.Row,type:"folder",template:"folder",add:function(e,t,n){this.fireEvent("beforeAddRow");var r=this;request=new Request.JSON({url:Files.app.createRoute({view:"folder",name:r.name,folder:Files.app.getPath()}),method:"post",data:{_action:"add",csrf_token:Files.token},onSuccess:function(t){typeof e=="function"&&e(t),r.fireEvent("afterAddRow",{status:!0,response:t,request:this})},onFailure:function(e){response=e.responseText,typeof t=="function"?t(e):(response=JSON.decode(e.responseText,!0),error=response&&response.error?response.error:Koowa.translate("An error occurred during request"),alert(error)),r.fireEvent("afterAddRow",{status:!1,response:response,request:this,xhr:e})},onComplete:function(e){typeof n=="function"&&n(e)}}),request.send()},"delete":function(e,t){var n=this,r=new Request.JSON({url:Files.app.createRoute({view:"folder",folder:Files.app.getPath(),name:n.name}),method:"post",data:{_action:"delete",csrf_token:Files.token},onSuccess:function(t){typeof e=="function"&&e(t),n.fireEvent("afterDeleteRow",{status:!0,response:t,request:this})},onFailure:function(e){if(e.status==204||e.status==1223)return this.onSuccess();response=e.responseText,typeof t=="function"?t(e):(response=JSON.decode(e.responseText,!0),error=response&&response.error?response.error:Koowa.translate("An error occurred during request"),alert(error)),n.fireEvent("afterDeleteRow",{status:!1,response:response,request:this,xhr:e})}});r.send()}}),Files.Paginator=new Class({Implements:[Options,Events],state:null,values:{total:0,limit:0,offset:0,page_total:0,page_current:0},initialize:function(e,t){t.state&&(this.state=t.state,this.setData(this.state.getData())),this.setOptions(t);var e=document.id(e);this.element=e,this.elements={page_total:e.getElement(".page-total"),page_current:e.getElement(".page-current"),page_start:e.getElement(".start a"),page_next:e.getElement(".next a"),page_prev:e.getElement(".prev a"),page_end:e.getElement(".end a"),page_container:e.getElement(".page"),pages:{},limit_box:e.getElement("select")},this.setValues(),this.element.addEvent("click:relay(a)",function(e){e.stop();if(e.target.get("data-enabled")=="0")return;this.fireEvent("clickPage",e.target)}.bind(this)),this.elements.limit_box.addEvent("change",function(e){e.stop(),this.fireEvent("changeLimit",this.elements.limit_box.get("value"))}.bind(this))},setValues:function(){this.fireEvent("beforeSetValues");var e=this.values,t=this.elements;this.setPageData(t.page_start,{offset:0}),this.setPageData(t.page_end,{offset:(e.page_total-1)*e.limit}),this.setPageData(t.page_prev,{offset:Math.max(0,(e.page_current-2)*e.limit)});var n=Math.min((e.page_total-1)*e.limit,e.page_current*e.limit);this.setPageData(t.page_next,{offset:n}),t.page_container.empty();var r=1;while(r<=e.page_total){var i=null;r==e.page_current?i=new Element("span",{text:r}):r<3||Math.abs(r-e.page_total)<2||Math.abs(r-e.page_current)<2?i=new Element("a",{href:"#",text:r,"data-limit":e.limit,"data-offset":(r-1)*e.limit}):Math.abs(r-e.page_current)<3&&(i=new Element("span",{html:"&hellip;"})),i&&(t.pages[r]=i,i.inject(t.page_container)),r++}t.page_current.set("text",e.page_current),t.page_total.set("text",e.page_total),t.limit_box.set("value",e.limit),this.fireEvent("afterSetValues")},setPageData:function(e,t){this.fireEvent("beforeSetPageData",{page:e,data:t});var n=t.limit||this.values.limit;e.set("data-limit",n),e.set("data-offset",t.offset);var r=t.offset==this.values.offset?"addClass":"removeClass",i=e;i.getParent()!==this.elements.page_container&&i.getParent()!==this.element&&!i.getParent().match("ul")&&(i=i.getParent(),i.getParent()!==this.elements.page_container&&i.getParent()!==this.element&&!i.getParent().match("ul")&&(i=i.getParent())),i[r]("off disabled"),e.set("data-enabled",(t.offset!=this.values.offset)-0),this.fireEvent("afterSetPageData",{page:e,data:t})},setData:function(e){this.fireEvent("beforeSetData",{data:e});var t=this.values;e.total==0?(t.limit=this.state.get("limit"),t.offset=this.state.get("offset"),t.total=0,t.page_total=1,t.page_current=1):(Object.each(e,function(e,n){t[n]=e}),t.limit=Math.max(t.limit,1),t.offset=Math.max(t.offset,0),t.limit>t.total&&(t.offset=0),t.limit||(t.offset=0,t.limit=t.total),t.page_total=Math.ceil(t.total/t.limit),t.offset>t.total&&(t.offset=(t.page_total-1)*t.limit),t.page_current=Math.floor(t.offset/t.limit)+1),this.fireEvent("afterSetData",{data:e})}}),function(){var e=function(e,t,n,r,i){var s=r-i,o=n[s]||n.max,u=e.getChildren().length-1;e.getChildren().each(function(e,t){t>0&&t<u&&(e.setStyle("width",o[t].value),o[t].value<=48?e.removeClass("overflow-ellipsis"):e.addClass("overflow-ellipsis"))})};this.Files||(this.Files={}),Files.Pathway=new Class({Implements:[Options],element:!1,options:{element:"files-pathway",offset:8},initialize:function(e){this.setOptions(e)},setPath:function(t){this.element||(this.element=document.id(this.options.element)),this.element.getParent().setStyle("position","relative");var n=this.element;n.setStyles({overflow:"visible","text-overflow":"ellipsis","white-space":"nowrap",bottom:0,top:0,left:(n.getPrevious()?n.getPrevious().getSize().x:0)+this.options.offset,right:n.getNext().getSize().x+this.options.offset,position:"absolute"}),n.empty();var r=new Element("ul",{"class":"breadcrumb breadcrumb-resizable"}),i=function(e,t,n,r){var i=new Element("li",{title:t,events:{click:function(){e.navigate(n)}}}),s=new Element("span",{text:t});return i.grab(s),r&&s.grab(new Element("span",{"class":"divider"}),"top"),i},s=i(t," "+t.container.title,"",!1).getElement("span").grab(new Element("i",{"class":"icon-database icon-hdd"}),"top").getParent();r.adopt(s);var o=t.getPath().split("/"),u="";o.each(function(e){e.trim()&&(u+=u?"/"+e:e,r.adopt(i(t,e,u,!0)))}),r.getLast().addClass("active"),n.setStyle("visibility","hidden"),n.adopt(r),this.pathway&&(window.removeEvent("resize",this.pathway),this.pathway=!1);if(r.getChildren().length>2){var a={},f=0,l=r.getFirst().getSize().x+r.getLast().getSize().x;r.getChildren().each(function(e,t){if(e.match(":first-child")||e.match(":last-child"))return;var n=e.getSize().x;a[t]={key:t,value:n},f+=n});var c={},h=f;c[f]=c.max=a;while(h>0){--h;var p={key:null,value:0},d={};for(var v in a)if(a.hasOwnProperty(v)){var m=a[v];m.value>p.value&&(p=m),d[v]={key:m.key,value:m.value}}--d[p.key].value,c[h]=d,a=d}e(r,n,c,n.getSize().x,l),n.setStyle("visibility","visible"),this.pathway=function(){e(r,n,c,n.getSize().x,l)},window.addEvent("resize",this.pathway)}else n.setStyle("visibility","visible")}})}();if(!Files)var Files={};Files.blank_image="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAMAAAAoyzS7AAAABGdBTUEAALGPC/xhBQAAAAd0SU1FB9MICA0xMTLhM9QAAAADUExURf///6fEG8gAAAABdFJOUwBA5thmAAAACXBIWXMAAAsSAAALEgHS3X78AAAACklEQVQIHWNgAAAAAgABz8g15QAAAABJRU5ErkJggg==",Files.App=new Class({Implements:[Events,Options],_tmpl_cache:{},active:null,title:"",cookie:null,options:{root_text:"Root folder",cookie:{path:"/"},persistent:!0,thumbnails:!0,types:null,container:null,active:null,pathway:{element:"files-pathway"},state:{defaults:{}},tree:{enabled:!0,element:"#files-tree"},grid:{element:"files-grid",batch_delete:"#toolbar-delete a",icon_size:150},paginator:{element:"files-paginator"},folder_dialog:{view:"#files-new-folder-modal",input:"#files-new-folder-input",open_button:"#toolbar-newfolder a",create_button:"#files-new-folder-create",onSubmit:function(){},onCreate:function(e){e.input.set("value",""),e.create_button.removeClass("valid").setProperty("disabled","disabled")},onOpen:function(e){kQuery.magnificPopup.open({items:{src:kQuery(e.view),type:"inline"},callbacks:{open:function(){setTimeout(function(){e.input.focus()},100)}}})},onClose:function(){kQuery.magnificPopup.close()},onInit:function(e){var t=kQuery(e.input),n=kQuery(e.create_button),r=function(){kQuery.trim(kQuery(this).val())?n.addClass("valid").prop("disabled",!1):n.removeClass("valid").prop("disabled",!0)};t.on("change",r),window.addEventListener?t.on("input",r):t.on("keyup",r)}},uploader_dialog:{view:"#files-upload",button:"#toolbar-upload"},move_dialog:{view:"#files-move-modal",button:".btn-primary",open_button:"#toolbar-move"},copy_dialog:{view:"#files-copy-modal",button:".btn-primary",open_button:"#toolbar-copy"},history:{enabled:!0},router:{defaults:{option:"com_files",view:"files",format:"json"}},initial_response:null,refresh_button:"#toolbar-refresh",onAfterSetGrid:function(){window.addEvent("resize",function(){this.setDimensions(!0)}.bind(this)),this.grid.addEvent("onAfterRenew",function(){this.setDimensions(!0)}.bind(this)),this.addEvent("onUploadFile",function(){this.setDimensions(!0)}.bind(this))},onAfterNavigate:function(e){e!==undefined&&(this.setTitle(this.folder.name||this.container.title),kQuery("#upload-files-to, .upload-files-to").text(e?e:this.container.title))},onBeforeSetContainer:function(e){typeof e.container!="undefined"&&(e.container.title=this.options.root_text)}},initialize:function(e){this.setOptions(e);if(this.options.persistent&&this.options.container){var t=typeof this.options.container=="string"?this.options.container:this.options.container.slug;this.cookie="com.files.container."+t}this.options.pathway&&this.setPathway(),this.setState(),this.setHistory(),this.setGrid(),this.setPaginator();var n=this.getUrl();n.getData("container")&&!this.options.container&&(this.options.container=n.getData("container")),n.getData("folder")&&(this.options.active=n.getData("folder")),this.options.thumbnails&&this.addEvent("afterSelect",function(e){this.setThumbnails()}),this.options.uploader_dialog&&this.setUploaderDialog(),this.options.container&&this.setContainer(this.options.container);if(this.options.refresh_button){var r=document.getElement(this.options.refresh_button),i=this;r&&r.addEvent("click",function(e){e.stop(),i.navigate(undefined,"stateless",!0),i.setTree()})}},setState:function(){this.fireEvent("beforeSetState");if(this.cookie){var e=Cookie.read(this.cookie+".state"),t=JSON.decode(e,!0);t&&(typeof this.getUrl().getData("folder")=="undefined"&&(this.options.active=t.folder),delete t.folder,this.options.state.defaults=Object.merge({},this.options.state.defaults,t))}var n=this.options.state;this.state=new Files.State(n),this.fireEvent("afterSetState")},setHistory:function(){this.fireEvent("beforeSetHistory");if(this.options.history.enabled){var e=this;this.history=History,window.addEvent("popstate",function(t){t&&t.stop();var n=History.getState(),r=e.state.getData(),i=n.data,s=!1;Object.each(r,function(e,t){if(s===!0)return;i&&i[t]&&e!==i[t]&&(s=!0)});if(e.container&&(s||e.active!==n.data.folder)){var o=Object.append({},n.data);["option","view","layout","folder","container"].each(function(e){delete o[e]}),e.state.set(o),e.navigate(n.data.folder,"stateless")}}),this.addEvent("afterNavigate",function(t,n){if(n!=="stateless"&&e.history){var r={folder:e.active,container:e.container?e.container.slug:null},i=this.state.getData();Object.each(i,function(e,t){typeof e!="function"&&typeof e!="undefined"&&(r[t]=e)});var s=n==="initial"?"replaceState":"pushState",o=e.getUrl().setData(r,!0).set("fragment","").toString();e.history[s](r,null,o)}})}this.fireEvent("afterSetHistory")},navigate:function(e,t,n,r){this.fireEvent("beforeNavigate",[e,t]),e!==undefined&&(this.active&&this.state.set("offset",0),this.active=e=="/"?"":e),this.grid.reset(),this.grid.spin();var i=this.active.split("/"),s=i[i.length?i.length-1:0],o=i.slice(0,i.length-1).join("/"),u=this,a=function(e){return n&&(e.revalidate_cache=1),this.createRoute(e)}.bind(this),f=function(e){if(e)if(e.status!==!1){var t=[];Object.each(e.data,function(e){var n=e.attributes;n.baseurl||(n.baseurl=u.baseurl),t.push(n)}),u.grid.insertRows(t),e.partial||(u.grid.unspin(),u.response=
e,u.fireEvent("afterSelect",e))}else e.error&&alert(e.error)};this.folder=new Files.Folder({folder:o,name:s}),r?(f(r),this.grid.unspin()):this.fetch(this.folder.path,a).done(f).progress(f);if(this.cookie){var l=kQuery.extend(!0,{},this.state.data);l.folder=this.active,Cookie.write(this.cookie+".state",JSON.encode(l),this.options.cookie)}this.fireEvent("afterNavigate",[e,t])},fetch:function(e,t){var n=this,r=kQuery.Deferred(),i=function(e){var t=JSON.decode(e.responseText,!0);t&&t.error&&alert(t.error)},s=Object.append({view:"nodes",folder:e},this.state.getData());this.ajax_cache&&this.ajax_cache.abort();if(typeof s.limit!="undefined"&&s.limit!==0)return this.ajax_cache=kQuery.getJSON(t(s)).fail(i),this.ajax_cache;s.limit=100;var o=function(e){if(!e||typeof e.data=="undefined"||typeof e.meta=="undefined"){r.reject("");return}e.meta.offset+e.data.length<e.meta.total?(e.partial=!0,r.notify(e),s.offset=e.meta.offset+e.meta.limit,n.ajax_cache=kQuery.getJSON(t(s)).done(o).fail(i)):(e.completed=!0,r.resolve(e))};return n.ajax_cache=kQuery.getJSON(t(s)).done(o).fail(i),r.promise()},setContainer:function(e){var t=function(e){this.fireEvent("beforeSetContainer",{container:e}),this.container=e,this.baseurl=Files.sitebase+"/"+e.relative_path,this.active="";if(this.uploader){this.container.parameters.allowed_extensions&&(this.uploader.settings.filters=[{title:Koowa.translate("All Files"),extensions:this.container.parameters.allowed_extensions.join(",")}]);if(this.container.parameters.maximum_size){this.uploader.settings.max_file_size=this.container.parameters.maximum_size;var t=document.id("upload-max-size");t&&t.set("html",(new Files.Filesize(this.container.parameters.maximum_size)).humanize())}}this.container.parameters.thumbnails!==!0?this.options.thumbnails=!1:this.state.set("thumbnails",!0),this.options.types!==null&&(this.options.grid.types=this.options.types,this.state.set("types",this.options.types)),this.options.folder_dialog&&document.getElement(this.options.folder_dialog.view)&&document.getElement(this.options.folder_dialog.view).getElement("form")&&this.setFolderDialog(),this.options.move_dialog&&(this.move_dialog=new Files.MoveDialog(this.options.move_dialog)),this.options.copy_dialog&&(this.copy_dialog=new Files.CopyDialog(this.options.copy_dialog)),this.fireEvent("afterSetContainer",{container:e}),this.setTree(),this.active=this.options.active||"",this.options.active="",typeof this.options.initial_response=="string"&&(this.options.initial_response=JSON.decode(this.options.initial_response)),this.navigate(this.active,"initial",!1,this.options.initial_response)}.bind(this);typeof e=="string"?(new Request.JSON({url:this.createRoute({view:"container",slug:e,container:!1}),method:"get",onSuccess:function(e){t(e.data.attributes)}.bind(this)})).send():t(e)},setPaginator:function(){this.fireEvent("beforeSetPaginator");var e=this.options.paginator,t=this.state;Object.append(e,{state:t,onClickPage:function(e){this.state.set("limit",e.get("data-limit")),this.state.set("offset",e.get("data-offset")),this.navigate()}.bind(this),onChangeLimit:function(e){this.state.set("limit",e);var t=Files.app.paginator.values.total,n=Files.app.paginator.values.offset;t&&(n=e?Math.floor(n/e*e):0),this.state.set("offset",n),this.navigate()}.bind(this)}),this.paginator=new Files.Paginator(e.element,e);var n=this;n.addEvent("afterSelect",function(e){n.paginator.setData({limit:e.meta.limit,offset:e.meta.offset,total:e.meta.total}),n.paginator.setValues()}),this.fireEvent("afterSetPaginator")},setGrid:function(){this.fireEvent("beforeSetGrid");var e=this,t=this.options.grid,n=this.cookie+".grid.layout";this.cookie&&Cookie.read(n)&&(t.layout=Cookie.read(n)),Object.append(t,{onClickFolder:function(e){var t=document.id(e.target),n=t.getParent(".files-node-shadow")||t.getParent(".files-node"),r=n.retrieve("row").path;r&&this.navigate(r)}.bind(this),onClickImage:function(t){var n=document.id(t.target),r=n.getParent(".files-node-shadow")||n.getParent(".files-node"),i=r.retrieve("row"),s=e.createRoute({view:"file",format:"html",name:i.name,folder:i.folder});s&&kQuery.magnificPopup.open({items:{src:s,type:"image"}})},onClickFile:function(e){var t=document.id(e.target),n=t.getParent(".files-node-shadow")||t.getParent(".files-node"),r=n.retrieve("row"),i=Object.append({},r);i.template="file_preview",i=i.render();var s=kQuery(i);s.addClass("mfp-hide koowa"),kQuery.magnificPopup.open({items:{src:s,type:"inline"}})},onBeforeRenderObject:function(t){var n=t.object;n.download_link=e.createRoute({view:"file",format:"html",name:n.name,folder:n.folder})}.bind(this),onAfterSetLayout:function(t){n&&Cookie.write(n,t.layout,e.options.cookie)},onAfterRender:function(){this.setState(e.state.data)},onSetState:function(e){this.state.set(e),this.navigate()}.bind(this)}),this.grid=new Files.Grid(this.options.grid.element,t),this.fireEvent("afterSetGrid")},setTree:function(){this.fireEvent("beforeSetTree");if(this.options.tree.enabled){var e=this.options.tree,t=this;e=kQuery.extend(!0,{},{onSelectNode:function(e){if(e.id||e.url){var n=e&&e.id?e.id:"";n!=t.active&&t.navigate(n)}},root:{text:this.options.root_text},initial_response:!!this.options.initial_response},e),this.tree=new Files.Tree(kQuery(e.element),e),this.tree.fromUrl(this.createRoute({view:"folders",tree:"1",limit:"2000"})),this.addEvent("afterNavigate",function(e,n){e!==undefined&&(!n||n!="initial"&&n!="stateless")&&t.tree.selectPath(e)}),this.grid&&this.grid.addEvent("afterDeleteNode",function(e){var n=e.node;n.type=="folder"&&t.tree.removeNode(n.path)})}this.fireEvent("afterSetTree")},setFolderDialog:function(){var e=this;this._folder_dialog={view:document.getElement(this.options.folder_dialog.view),input:document.getElement(this.options.folder_dialog.input),open_button:document.getElement(this.options.folder_dialog.open_button),create_button:document.getElement(this.options.folder_dialog.create_button)},this.options.folder_dialog.onInit&&this.options.folder_dialog.onInit.call(this,this._folder_dialog),this._folder_dialog.open_button&&this._folder_dialog.open_button.addEvent("click",function(e){e.stop();if(this.hasClass("unauthorized"))return;Files.app.openFolderDialog()}),this._folder_dialog.view.getElement("form")&&this._folder_dialog.view.getElement("form").addEvent("submit",function(t){t.stop(),e._folder_dialog.create_button.setProperty("disabled","disabled"),e.options.folder_dialog.onSubmit&&e.options.folder_dialog.onSubmit.call(e,e._folder_dialog);var n=e._folder_dialog.input,r=n.get("value").trim();if(r.length>0){var i=new Files.Folder({name:r,folder:Files.app.getPath()});i.add(function(t,n){if(t.status===!1)return alert(t.error);var r=t.data.attributes,i=Files[r.type.capitalize()],s=new i(r);Files.app.grid.insert(s),Files.app.tree.appendNode({id:s.path,label:s.name}),e.options.folder_dialog.onCreate&&e.options.folder_dialog.onCreate.call(e,e._folder_dialog),e.closeFolderDialog()},null,function(){e._folder_dialog.create_button.setProperty("disabled",!1)})}})},openFolderDialog:function(){return this.options.folder_dialog&&this.options.folder_dialog.onOpen.call(this,this._folder_dialog),!!this.options.folder_dialog},closeFolderDialog:function(){return this.options.folder_dialog&&this.options.folder_dialog.onClose.call(this,this._folder_dialog),!!this.options.folder_dialog},setUploaderDialog:function(){var e=this,t=document.getElement(this.options.uploader_dialog.button),n=document.getElement(this.options.uploader_dialog.view);n&&(this._tmp_uploader=(new Element("div",{style:"display:none"})).inject(document.body),document.getElement(this.options.uploader_dialog.view).getParent().inject(this._tmp_uploader).setStyle("visibility","")),t&&t.addEvent("click",function(t){t.stop();if(this.hasClass("unauthorized"))return;e.openUploaderDialog()})},openUploaderDialog:function(){if(this.uploader){var e=this,t=function(){document.getElement(e.options.uploader_dialog.view).getParent().inject(e._tmp_uploader),SqueezeBox.removeEvent("close",t)};SqueezeBox.addEvent("close",t),SqueezeBox.open(document.getElement(e.options.uploader_dialog.view).getParent(),{handler:"adopt",size:{x:700,y:document.getElement(e.options.uploader_dialog.view).getParent().measure(function(){this.setStyle("width",700);var e=this.getSize().y;return this.setStyle("width",""),e})}}),window.addEvent("QueueChanged",this._changeUploaderDialogHeight.bind(this))}return!!this.uploader},closeUploaderDialog:function(){return this.uploader&&(SqueezeBox.close(),window.removeEvent("QueueChanged",this._changeUploaderDialogHeight)),!!this.uploader},_changeUploaderDialogHeight:function(){var e=document.getElement(this.options.uploader_dialog.view).getParent().scrollHeight;SqueezeBox.resize({x:700,y:e})},getUrl:function(){return new URI(window.location.href)},getPath:function(){return this.active},setThumbnails:function(){this.setDimensions(!0);var e=this.grid.nodes,t=this;e.getLength()&&e.each(function(e){if(e.filetype!=="image")return;var t=e.name,n=e.element.getElement("img.image-thumbnail");n&&(n.addEvent("load",function(){this.addClass("loaded")}),n.set("src",e.thumbnail?e.thumbnail:Files.blank_image),(e.element.getElement(".files-node")||e.element).addClass("loaded").removeClass("loading"),window.sessionStorage&&(sessionStorage[e.image.toString()]=n.get("src")))})},setDimensions:function(e){this._cached_grid_width||(this._cached_grid_width=0);if(this._cached_grid_width!=this.grid.root.element.getSize().x||e){var t=this.grid.root.element.getSize().x,n=t/(this.grid.options.icon_size.toInt()+40),r=Math.min(Math.floor(n),this.grid.nodes.getLength());this.grid.root.element.getElements(".files-node-shadow").each(function(e,t,n){e.setStyle("width",100/r+"%")},this),this._cached_grid_width=this.grid.root.element.getSize().x}},setPathway:function(){this.fireEvent("beforeSetPathway");var e=new Files.Pathway(this.options.pathway);this.addEvent("afterSetTitle",e.setPath.bind(e,this)),this.fireEvent("afterSetPathway")},setTitle:function(e){this.fireEvent("beforeSetTitle",{title:e}),this.title=e,this.fireEvent("afterSetTitle",{title:e})},createRoute:function(e){e=Object.merge({},this.options.router.defaults,e||{}),e.container!==!1&&!e.container&&this.container?e.container=this.container.slug:delete e.container,e.format=="html"&&delete e.format;var t="?"+(new Hash(e)).filter(function(e,t){return typeof e!="function"}).toQueryString();return this.options.base_url?this.options.base_url+t:t}});if(!Files)var Files={};(function(e){var t=function(e){document.id("files-upload").addClass("uploader-files-queued").removeClass("uploader-files-empty"),e.refresh(),e.unbind("QueueChanged",t),window.fireEvent("QueueChanged")},n=function(n){var r,i=function(e){e.preventDefault(),e.stopPropagation(),e.originalEvent.dataTransfer.dropEffect="copy"},s=function(t){var n=e('<div class="dropzone-focusring"></div>'),i=e('<div class="alert alert-success">'+Koowa.translate("Drop your files to upload to {folder}").replace("{folder}",Files.app.title)+"</div>");return n.css({display:"none",position:"absolute",backgroundColor:"hsla(0, 0%, 100%, 0.75)",top:0,left:0,bottom:0,right:0,zIndex:65558,borderStyle:"solid",borderWidth:"5px",opacity:0,transition:"opacity 300ms",paddingTop:10,textAlign:"center"}),t.append(n),e("#files-upload").append(i),["border-radius","color","background","border"].forEach(function(e){i.css(e,i.css(e))}),i.css({display:"inline-block",margin:"0 auto"}),n.append(i),n.css("border-color",i.css("color")),function(t){t.preventDefault(),t.originalEvent.dataTransfer.dropEffect="copy",n.css("display")=="none"&&(i.text(Koowa.translate("Drop your files to upload to {folder}").replace("{folder}",Files.app.title)),n.css("display","block"),setTimeout(function(){n.css("opacity",1),e("#files-upload").is(":visible")||e("#files-canvas").addClass("dropzone-droppable")},1)),clearTimeout(r),r=setTimeout(function(){e(".dropzone-focusring").css("opacity",0).css("display","none"),e("#files-canvas").removeClass("dropzone-droppable")},300)}},o=function(){return function(e){}},u=function(e){var t,r,i=[],s,o={};for(r=0;r<e.length;r++){t=e[r];if(o[t.name])continue;o[t.name]=!0,n.addFile(t)}},a=e("#files-canvas"),f=e(document.body);document.id("files-upload").addClass("uploader-droppable"),e("#files-upload-multi_filelist").bind("drop",function(t){t.stopPropagation(),e(document.body).removeClass("dropzone-dragover")}),f.bind("dragover",s(f)),f.bind("dragleave",o(f)),f.bind("dragenter",i),f.bind("drop",function(t){t.preventDefault(),a.removeClass("dragover");var n=t.originalEvent.dataTransfer;if(n&&n.files&&n.files.length){var r=n.files;e("#files-upload").is(":visible")||document.getElement(Files.app.options.uploader_dialog.button).fireEvent("click","DOMEvent"in window?new DOMEvent:new Event),setTimeout(function(){u(r)},300)}}),f.bind("dragend",function(){e(".dropzone-focusring").css("opacity",0).css("display","none")}),n.bind("QueueChanged",t)},r=function(e,t){var n=1,r=e.substr(e.lastIndexOf(".")+1),i=e.substr(0,e.lastIndexOf("."));for(;;){e=i+" ("+n+")."+r;if(!t(e))break;n++}return e};Files.createUploader=function(i){i=e.extend({},{element:"#files-upload-multi",multi_selection:!0,media_path:""},i);var s=e(i.element);if(s.length===0)return;var o="mushycode"+Math.floor(Math.random()*1e10+1);e('<div id="'+o+'" class="uploader-flash-container" />').appendTo(e(document.body));var u={runtimes:"html5,flash",container:o,browse_button:"pickfiles",multi_selection:i.multi_selection,dragdrop:!0,unique_names:!1,rename:!0,url:"/",flash_swf_url:i.media_path+"koowa/com_files/js/plupload/Moxie.swf",urlstream_upload:!0,multipart_params:{_action:"add",csrf_token:Files.token},filters:{prevent_duplicates:!0},headers:{"X-Requested-With":"XMLHttpRequest"},preinit:{Error:function(e,t){if(t.code==plupload.INIT_ERROR){var n=Koowa.translate("{html5} or {flash} required for uploading files from your computer.",{html5:'<a href="https://google.com/chrome" target="_blank">'+Koowa.translate("HTML5 enabled browser")+"</a>",flash:'<a href="https://get.adobe.com/flashplayer/" target="_blank">'+Koowa.translate("Flash Player")+"<a/>"});setTimeout(function(){s.append('<div class="alert alert-error warning">'+n+"</div>")},100)}}}};if(Files.app&&Files.app.container){if(Files.app.container.parameters.allowed_extensions){var a=Files.app.state.get("types"),f=Files.app.container.parameters.allowed_extensions;typeof a=="object"&&a.length===1&&a[0]==="image"&&(f=e.grep(Files.app.container.parameters.allowed_extensions,function(t){return e.inArray(t,Files.FileTypes.map.image)!==-1})),u.filters.mime_types=[{title:Koowa.translate("All Files"),extensions:f.join(",")}]}u.preinit.Init=function(e){var t=e.runtime==="html5"&&e.features.chunks,n=Files.app.container.parameters.maximum_size,r=Files.app.container.server_upload_limit;if(!t){if(!n||n==0||n>r)n=r-1048576}else{var i=Math.max(1048576,r-1048576);i>33554432&&(i=33554432),e.setOption("chunk_size",i)}if(n>0){e.setOption("max_file_size",n);var s=document.id("upload-max-size");s&&s.set("html",(new Files.Filesize(n)).humanize())}else document.id("upload-max").setStyle("display","none")}}SqueezeBox.addEvent("open",function(){window.fireEvent("refresh")}),window.addEvent("refresh",function(){l.refresh()}),s.pluploadQueue(u);var l=s.pluploadQueue(),c=e(".plupload_start",s),h=function(t){var n=[];return e.each(t,function(e,t){n.push(t.attributes.name)}),n},p=function(){c.hasClass("plupload_disabled")||l.start()},d=function(e){var t="";return e.length===1?t=Koowa.translate("A file with the same name already exists. Would you like to overwrite it?"):e.length>1&&(t=Koowa.translate("Following files already exist. Would you like to overwrite them? {names}",{names:"\n"+e.join("\n")})),t},v=function(t,n){var i=[];typeof n.data=="object"&&n.data.length&&(i=h(n.data)),e.each(l.files,function(e,n){n.id!==t.id&&i.push(n.name)}),t.name=r(t.name,function(t){return e.inArray(t,i)!==-1}),e("#"+t.id).find("div.plupload_file_name span").text(t.name)},m=function(t){l.settings.multipart_params.overwrite=0;if(typeof t.data=="object"&&t.data.length){var n=h(t.data),r=[];if(confirm(d(n)))return l.settings.multipart_params.overwrite=1,p();e.each(l.files,function(t,i){e.inArray(i.name,n)!==-1&&r.push(e.ajax({type:"GET",url:Files.app.createRoute({view:"files",folder:Files.app.getPath(),limit:100,search:i.name.substr(0,i.name.lastIndexOf("."))+" ("})}).done(function(e){return v(i,e)}))}),r&&e.when.apply(kQuery,r).then(function(){p()})}else p()};c.click(function(t){t.preventDefault();var n=[];e.each(l.files,function(e,t){t.loaded==0&&n.push(t.name)}),n.length&&e.ajax({url:Files.app.createRoute({view:"files",limit:100,folder:Files.app.getPath()}),type:"POST",data:{_method:"GET",name:n}}).done(m).fail(p)}),l.bind("FilesAdded",function(e){e.files.length>100&&e.splice(0,e.files.length-100)});if(!i.multi_selection){var g=function(t){var n=t.files.length;n>1&&e.each(t.files,function(e,r){e!==n-1&&t.removeFile(r)}),y=!1},y=!1;l.bind("QueueChanged",function(e){if(y)return;y=!0,g(e)})}l.bind("ChunkUploaded",function(t,n,r){var i=e.parseJSON(r.response);i.status===!1&&(n.status=plupload.FAILED,x[n.id]=i.error,t.stop())});var b=window.navigator.userAgent.indexOf("MSIE "),w=window.navigator.userAgent.indexOf("Trident/"),E=b>0||w>0,S=function(){document.id("files-upload").addClass("uploader-nodroppable").setStyle("position","").addClass("uploader-files-queued").removeClass("uploader-files-empty"),l.refresh()};E?S():setTimeout(function(){l.features.dragdrop?n(l):S()},1500),l.bind("BeforeUpload",function(e,t){e.settings.url=Files.app.createRoute({view:"file",plupload:1,folder:Files.app.getPath()})}),l.bind("UploadComplete",function(t){e("li.plupload_delete a,div.plupload_buttons",s).show(),t.disableBrowse(!1),t.refresh()});var x={};l.bind("FileUploaded",function(e,t,n){var r=JSON.decode(n.response,!0)||{},i,s,o;if(r.status){s=r.data.attributes,o=(s.folder?s.folder+"/":"")+s.name;if(typeof Files.app.grid.nodes[o]=="undefined"){var u=Files[s.type.capitalize()];i=new u(s),Files.app.grid.insert(i)}else i=Files.app.grid.nodes[o],s.metadata&&(i.metadata=s.metadata,i.size=new Files.Filesize(i.metadata.size));if(i.type=="image"&&Files.app.grid.layout=="icons"){var a=i.element.getElement("img");a&&(i.getThumbnail(function(e){e.item.thumbnail&&(a.set("src",e.item.thumbnail).addClass("loaded").removeClass("loading"),i.element.getElement(".files-node").addClass("loaded").removeClass("loading"))}),window.fireEvent("resize"))}Files.app.fireEvent("uploadFile",[i])}else x[t.id]=r.error?r.error:Koowa.translate("Unknown error")}),l.bind("StateChanged",function(t){Object.each(x,function(t,n){icon=e("#"+n).attr("class","plupload_failed").find("a").css("display","block"),t&&icon.attr("title",t)})}),$$(".plupload_clear").addEvent("click",function(e){e.stop();if(confirm(Koowa.translate("Are you sure you want to clear the upload queue? This cannot be undone!"))){var t=l.files.slice(0);t.each(function(e){l.removeFile(e)})}}),Files.app.uploader=l;var T=function(e){$$(".upload-form").setStyle("display","none"),document.id("files-uploader-"+e).setStyle("display","block"),e=="computer"&&s.length&&!l.files.length&&l.features.dragdrop&&(document.id("files-upload").removeClass("uploader-files-queued").addClass("uploader-files-empty"),document.id("files-upload-multi_browse")&&l.bind("QueueChanged",t)),window.fireEvent("refresh")};$$(".upload-form-toggle").addEvent("click",function(e){var t=this.get("href").split("#")[1];$$(".upload-form-toggle").removeClass("active"),e.preventDefault(),this.addClass("active"),T(t)});var N=document.id("remoteForm"),C=document.id("remote-name"),k=N.getElement(".remote-submit"),L=k.get("value"),A=function(){N.getElement(".remote-wrap").setStyle("margin-right",k.measure(function(){return this.getSize().x}))},O=document.id("remote-url"),M,_=new Request.JSON({onRequest:function(){M!=this.options.url&&(k.set("value",L),A(),M=this.options.url)},onSuccess:function(e){if(e.error)return this.fireEvent("failure",this.xhr);var t=e["content-length"].toInt(10);if(t&&t<Files.app.container.parameters.maximum_size){var n=(new Files.Filesize(t)).humanize();k.addClass("btn-primary").set("value",L+" ("+n+")"),A()}else k.removeClass("btn-primary")},onFailure:function(e){var t=JSON.decode(e.responseText,!0);t.code&&parseInt(t.code/100,10)==4?k.removeClass("btn-primary"):k.addClass("btn-primary")}}),D,P=function(){var e=this.value.trim(),t=(new URI(e)).get("host");return e&&t&&e.match(t)?(k.removeProperty("disabled"),!0):(k.setProperty("disabled","disabled"),!1)},H=function(){if(P.call(this)){Files.app.container.parameters.maximum_size?_.setOptions({url:Files.app.createRoute({view:"proxy",url:this.value})}).get():k.addClass("btn-primary");if(!C.get("value")||C.get("value")==D)D=(new URI(this.value)).get("file"),C.set("value",D)}else k.set("value",L).removeClass("btn-primary"),A()};O.addEvent("focus",function(){this.set("placeholder",this.get("title")).removeClass("success")}),O.addEvent("blur",H),O.addEvent("change",P),window.addEventListener?(O.addEventListener("input",P),O.addEventListener("paste",function(){H.delay(0,this)})):O.addEvent("keyup",P);var B=new Request.JSON({url:Files.app.createRoute({view:"file",folder:Files.app.getPath()}),data:{_action:"add",csrf_token:Files.token,file:""},onRequest:function(){k.setProperty("disabled","disabled")},onSuccess:function(e){if(this.status==201&&e.status){var t=e.data.attributes,n=Files[t.type.capitalize()],r=new n(t);Files.app.grid.insert(r);if(r.type=="image"&&Files.app.grid.layout=="icons"){var i=r.element.getElement("img");i&&(r.getThumbnail(function(e){e.item.thumbnail&&(i.set("src",e.item.thumbnail).addClass("loaded").removeClass("loading"),r.element.getElement(".files-node").addClass("loaded").removeClass("loading"))}),window.fireEvent("resize"))}Files.app.fireEvent("uploadFile",[r]),k.removeClass("btn-primary").set("value",L),A(),N.reset(),O.set("placeholder",Koowa.translate("Uploaded successfully!")).addClass("success")}else{var s=e.error?e.error:Koowa.translate("Unknown error");alert(Koowa.translate("An error occurred: {error}",{error:s}))}},onFailure:function(t){k.removeProperty("disabled");var n=e.parseJSON(t.response);n&&n.error?alert(Koowa.translate("An error occurred: {error}",{error:n.error})):alert(Koowa.translate("An error occurred with status code: {code}",{code:t.status}))}});N.addEvent("submit",function(e){e.stop(),B.options.data.file=document.id("remote-url").get("value"),B.options.url=Files.app.createRoute({view:"file",folder:Files.app.getPath(),name:document.id("remote-name").get("value")}),B.send()}),A(),document.id("files-upload").getParent().setStyle("visibility","")}})(kQuery);if(!Files)var Files={};(function(e){var t=Koowa.Class.extend({initialize:function(t){this.supr(),t={view:e(t.view),tree:e(t.view).find(".tree-container"),button:e(t.button,t.view),open_button:e(t.open_button)},this.setOptions(t),this.attachEvents()},attachEvents:function(){var e=this;this.options.open_button&&this.options.open_button.click(function(t){t.preventDefault(),e.show()}),this.options.view.find("form")&&this.options.view.find("form").submit(function(t){t.preventDefault(),e.submit()})},show:function(){var t=this.options,n=Object.getLength(this.getSelectedNodes());if(t.open_button.hasClass("unauthorized")||!n)return;var r=Files.app.tree.tree("toJson"),i=new Koowa.Tree(t.view.find(".tree-container"),{onCanSelectNode:function(e){return e.path!=Files.app.getPath()}});i.tree("loadData",e.parseJSON(r)),this.getSelectedNodes().each(function(e){var t=i.tree("getNodeById",e.path);t&&i.tree("removeNode",t)}),e.magnificPopup.open({items:{src:e(t.view),type:"inline"}})},hide:function(){this.options.tree instanceof e&&this.options.tree.empty(),e.magnificPopup.close()},getSelectedNodes:function(){return Files.app.grid.nodes.filter(function(e){return e.checked})},handleError:function(e){var t=JSON.decode(e.responseText,!0);this.hide(),t&&t.error&&alert(t.error)}});Files.CopyDialog=t.extend({submit:function(){var t=this,n=this.getSelectedNodes(),r=Object.values(n.map(function(e){return e.name})),i=this.options.view.find(".tree-container").tree("getSelectedNode").path,s=Files.app.createRoute({view:"nodes",folder:Files.app.getPath()});if(!r.length)return;this.options.button.prop("disabled",!0),e.ajax(s,{type:"POST",data:{name:r,destination_folder:i||"",_action:"copy",csrf_token:Files.token}}).done(function(e){var r=Files.app.tree,i=!1;n.each(function(e){var t=r.tree("getNodeById",e.path);t&&(i=!0)}),i&&Files.app.tree.fromUrl(Files.app.createRoute({view:"folders",tree:"1",limit:"2000"})),t.hide()}).fail(e.proxy(this.handleError,this)).always(function(){t.options.button.prop("disabled",!1)})}}),Files.MoveDialog=t.extend({submit:function(){var t=this,n=this.getSelectedNodes(),r=Object.values(n.map(function(e){return e.name})),i=this.options.view.find(".tree-container").tree("getSelectedNode").path,s=Files.app.createRoute({view:"nodes",folder:Files.app.getPath()});if(!r.length)return;this.options.button.prop("disabled",!0),e.ajax(s,{type:"POST",data:{name:r,destination_folder:i||"",_action:"move",csrf_token:Files.token}}).done(function(e){var r=Files.app.tree,i=!1;n.each(function(e){e.element&&e.element.dispose(),Files.app.grid.nodes.erase(e.path);var t=r.tree("getNodeById",e.path);t&&(i=!0)}),i&&Files.app.tree.fromUrl(Files.app.createRoute({view:"folders",tree:"1",limit:"2000"})),t.hide()}).fail(e.proxy(this.handleError,this)).always(function(){t.options.button.prop("disabled",!1)})}})})(window.kQuery);