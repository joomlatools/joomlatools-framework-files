if(function(e,t){e.Koowa||(e.Koowa={}),"object"==typeof exports?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Koowa.Spinner=t()}(this,function(){"use strict";function e(e,t){var i,n=document.createElement(e||"div");for(i in t)n[i]=t[i];return n}function t(e){for(var t=1,i=arguments.length;i>t;t++)e.appendChild(arguments[t]);return e}function i(e,t,i,n){var o=["opacity",t,~~(100*e),i,n].join("-"),s=.01+i/n*100,a=Math.max(1-(1-e)/t*(100-s),e),r=c.substring(0,c.indexOf("Animation")).toLowerCase(),l=r&&"-"+r+"-"||"";return p[o]||(u.insertRule("@"+l+"keyframes "+o+"{0%{opacity:"+a+"}"+s+"%{opacity:"+e+"}"+(s+.01)+"%{opacity:1}"+(s+t)%100+"%{opacity:"+e+"}100%{opacity:"+a+"}}",u.cssRules.length),p[o]=1),o}function n(e,t){var i,n,o=e.style;for(t=t.charAt(0).toUpperCase()+t.slice(1),n=0;n<f.length;n++)if(i=f[n]+t,void 0!==o[i])return i;return void 0!==o[t]?t:void 0}function o(e,t){for(var i in t)e.style[n(e,i)||i]=t[i];return e}function s(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)void 0===e[n]&&(e[n]=i[n])}return e}function a(e){for(var t={x:e.offsetLeft,y:e.offsetTop};e=e.offsetParent;)t.x+=e.offsetLeft,t.y+=e.offsetTop;return t}function r(e,t){return"string"==typeof e?e:e[t%e.length]}function l(e){return"undefined"==typeof this?new l(e):void(this.opts=s(e||{},l.defaults,h))}function d(){function i(t,i){return e("<"+t+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',i)}u.addRule(".spin-vml","behavior:url(#default#VML)"),l.prototype.lines=function(e,n){function s(){return o(i("group",{coordsize:c+" "+c,coordorigin:-d+" "+-d}),{width:c,height:c})}function a(e,a,l){t(p,t(o(s(),{rotation:360/n.lines*e+"deg",left:~~a}),t(o(i("roundrect",{arcsize:n.corners}),{width:d,height:n.width,left:n.radius,top:-n.width>>1,filter:l}),i("fill",{color:r(n.color,e),opacity:n.opacity}),i("stroke",{opacity:0}))))}var l,d=n.length+n.width,c=2*d,f=2*-(n.width+n.length)+"px",p=o(s(),{position:"absolute",top:f,left:f});if(n.shadow)for(l=1;l<=n.lines;l++)a(l,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(l=1;l<=n.lines;l++)a(l);return t(e,p)},l.prototype.opacity=function(e,t,i,n){var o=e.firstChild;n=n.shadow&&n.lines||0,o&&t+n<o.childNodes.length&&(o=o.childNodes[t+n],o=o&&o.firstChild,o=o&&o.firstChild,o&&(o.opacity=i))}}var c,f=["webkit","Moz","ms","O"],p={},u=function(){var i=e("style",{type:"text/css"});return t(document.getElementsByTagName("head")[0],i),i.sheet||i.styleSheet}(),h={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:"#000",direction:1,speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto",position:"relative"};l.defaults={},s(l.prototype,{spin:function(t){this.stop();var i,n,s=this,r=s.opts,l=s.el=o(e(0,{className:r.className}),{position:r.position,width:0,zIndex:r.zIndex}),d=r.radius+r.length+r.width;if(t&&(t.insertBefore(l,t.firstChild||null),n=a(t),i=a(l),o(l,{left:("auto"==r.left?n.x-i.x+(t.offsetWidth>>1):parseInt(r.left,10)+d)+"px",top:("auto"==r.top?n.y-i.y+(t.offsetHeight>>1):parseInt(r.top,10)+d)+"px"})),l.setAttribute("role","progressbar"),s.lines(l,s.opts),!c){var f,p=0,u=(r.lines-1)*(1-r.direction)/2,h=r.fps,m=h/r.speed,g=(1-r.opacity)/(m*r.trail/100),v=m/r.lines;!function w(){p++;for(var e=0;e<r.lines;e++)f=Math.max(1-(p+(r.lines-e)*v)%m*g,r.opacity),s.opacity(l,e*r.direction+u,f,r);s.timeout=s.el&&setTimeout(w,~~(1e3/h))}()}return s},stop:function(){var e=this.el;return e&&(clearTimeout(this.timeout),e.parentNode&&e.parentNode.removeChild(e),this.el=void 0),this},lines:function(n,s){function a(t,i){return o(e(),{position:"absolute",width:s.length+s.width+"px",height:s.width+"px",background:t,boxShadow:i,transformOrigin:"left",transform:"rotate("+~~(360/s.lines*d+s.rotate)+"deg) translate("+s.radius+"px,0)",borderRadius:(s.corners*s.width>>1)+"px"})}for(var l,d=0,f=(s.lines-1)*(1-s.direction)/2;d<s.lines;d++)l=o(e(),{position:"absolute",top:1+~(s.width/2)+"px",transform:s.hwaccel?"translate3d(0,0,0)":"",opacity:s.opacity,animation:c&&i(s.opacity,s.trail,f+d*s.direction,s.lines)+" "+1/s.speed+"s linear infinite"}),s.shadow&&t(l,o(a("#000","0 0 4px #000"),{top:"2px"})),t(n,t(l,a(r(s.color,d),"0 0 1px rgba(0,0,0,.1)")));return n},opacity:function(e,t,i){t<e.childNodes.length&&(e.childNodes[t].style.opacity=i)}});var m=o(e("group"),{behavior:"url(#default#VML)"});return!n(m,"transform")&&m.adj?d():c=n(m,"animation"),l}),!Files)var Files={};if(Files.Filesize=function(e){this.size=e},Files.Filesize.prototype.units=["B","KB","MB","GB","TB","PB"],Files.Filesize.prototype.humanize=function(){for(var e=0,t=this.size;t>=1024;)t/=1024,e++;return(0===e||t%1===0?t:t.toFixed(2))+" "+Koowa.translate(this.units[e])},Files.FileTypes={},Files.FileTypes.map={audio:["aif","aiff","alac","amr","flac","ogg","m3u","m4a","mid","mp3","mpa","wav","wma"],video:["3gp","avi","flv","mkv","mov","mp4","mpg","mpeg","rm","swf","vob","wmv"],image:["bmp","gif","jpg","jpeg","png","psd","tif","tiff"],document:["doc","docx","rtf","txt","xls","xlsx","pdf","ppt","pptx","pps","xml"],archive:["7z","gz","rar","tar","zip"]},Files.getFileType=function(e){var t="document",i=Files.FileTypes.map;e=e.toLowerCase();for(var n in i)if(i.hasOwnProperty(n)){var o=i[n];if(-1!=o.indexOf(e)){t=n;break}}return t},!Files)var Files={};if(Files.State=new Class({Implements:Options,data:{},defaults:{},options:{defaults:{}},initialize:function(e){this.setOptions(e),this.options.data&&Object.append(this.data,this.options.data),this.options.defaults&&(Object.append(this.defaults,this.options.defaults),Object.append(this.data,this.defaults))},getData:function(){return this.data},setDefaults:function(){return this.set(this.defaults),this},set:function(e,t){return"object"==typeOf(e)?Object.append(this.data,e):this.data[e]=t,this},get:function(e,t){return this.data[e]||t},unset:function(e){delete this.data[e]}}),!Files)var Files={};if(function(){Files.Template=new Class({Implements:[Events],render:function(e){var t=this.template;e=e||"default","default"!==e&&(t=e+"_"+t),this.fireEvent("beforeRender",{layout:e,template:t});var i=new EJS({element:t}).render(this),n=new(Files.Template[e.capitalize()])(i);return this.fireEvent("afterRender",{layout:e,template:t,result:n}),n}}),Files.Template.Details=new Class({initialize:function(e){var t=new Element("div",{html:e}).getElement("table");if(t)return t;var i="<table><tbody>"+e+"</tbody></table>";return new Element("div",{html:i}).getElement("tr")}}),Files.Template.Default=new Class({initialize:function(e){return new Element("div",{html:e}).getFirst()}}),Files.Template.Icons=new Class({initialize:function(e){return new Element("div",{html:e}).getFirst()}}),Files.Template.Compact=new Class({initialize:function(e){return new Element("div",{html:e}).getFirst()}})}(),!Files)var Files={};if(Files.Grid=new Class({Implements:[Events,Options],layout:"icons",options:{onClickFolder:function(){},onClickFile:function(){},onClickImage:function(){},onDeleteNode:function(){},onSwitchLayout:function(){},switchers:".files-layout-switcher",layout:!1,batch_delete:!1,icon_size:150,types:null},initialize:function(e,t){this.setOptions(t),this.nodes=new Hash,this.container=document.id(e),this.options.switchers&&(this.options.switchers=document.getElements(this.options.switchers)),this.options.batch_delete&&(this.options.batch_delete=document.getElement(this.options.batch_delete)),this.options.layout&&this.setLayout(this.options.layout),this.render(),this.attachEvents()},attachEvents:function(){var e=this,t=function(t,i){e.container.addEvent(t,function(t){t.stop(),e.fireEvent(i,arguments)})};t("click:relay(.files-folder a.navigate)","clickFolder"),t("click:relay(.files-file a.navigate)","clickFile"),t("click:relay(.files-image a.navigate)","clickImage");var i=function(t){if(!t.target.match("a.navigate")){"input"==t.target.get("tag")&&t.target.setProperty("checked",!t.target.getProperty("checked"));var i=t.target.getParent(".files-node-shadow");i||(i=t.target.match(".files-node")?t.target:t.target.getParent(".files-node")),e.checkNode(i.retrieve("row"))}};this.container.addEvent("click:relay(input.files-select)",i.bind(this)),this.container.addEvent("click",function(t){if("details"===e.layout){var i=t.target;if("a"!==i.get("tag")&&"input"!==i.get("tag")&&("i"!==i.get("tag")||!i.hasClass("icon-download"))){var n=i.getParent(".files-node-shadow")||i.getParent(".files-node");n&&(row=n.retrieve("row"),row&&e.checkNode(row))}}});var n=function(e){e.stop&&e.stop();var t=e.target.getParent(".files-node-shadow");t||(t=e.target.match(".files-node")?e.target:e.target.getParent(".files-node")),this.erase(t.retrieve("row").path)}.bind(this);if(this.container.addEvent("click:relay(.delete-node)",n),e.addEvent("afterDeleteNodeFail",function(e){var t=e.xhr,i=JSON.decode(t.responseText,!0);i&&i.error&&alert(i.error)}),this.options.batch_delete){var o=new Chain,s=function(){o.callChain()};this.addEvent("afterCheckNode",function(){var e=this.container.getElements("input[type=checkbox]:checked");this.options.batch_delete.setProperty("disabled",!e.length)}.bind(this)),this.options.batch_delete.addEvent("click",function(t){t.stop();var i=0,a=[],r=0,l=[],d=this.container.getElements("input[type=checkbox]:checked.files-select").filter(function(e){if(e.checked){var t=e.getParent(".files-node-shadow")||e.getParent(".files-node"),n=t.retrieve("row").name;return e.getParent(".files-node").hasClass("files-folder")?(r++,l.push(n)):(i++,a.push(n)),!0}}),c="";if(i+r===1)c=Koowa.translate("You are deleting {item}. Are you sure?",{item:r?l[0]:a[0]});else{var f=i+r,p=Koowa.translate("{count} files and folders");c=Koowa.translate("You are deleting {items}. Are you sure?"),!r&&i?p=Koowa.translate("{count} files"):r&&!i&&(p=Koowa.translate("{count} folders")),p=p.replace("{count}",f),c=c.replace("{items}",p)}return d.length&&confirm(c)?(e.addEvent("afterDeleteNode",s),e.addEvent("afterDeleteNodeFail",s),d.each(function(e){e.checked&&o.chain(function(){n({target:e})})}),o.chain(function(){e.removeEvent("afterDeleteNode",s),e.removeEvent("afterDeleteNodeFail",s),o.clearChain()}),void o.callChain()):!1}.bind(this))}if(this.options.switchers&&this.options.switchers.addEvent("click",function(t){t.stop();var i=this.get("data-layout");e.setLayout(i),e._updateSwitchers(i)}),this.options.icon_size){var a=this.options.icon_size;this.addEvent("beforeRenderObject",function(e){e.object.icon_size=a})}this.container.addEvent("click:relay(th.files__sortable)",function(t){var i=t.target.match("th")?t.target:t.target.getParent("th"),n={sort:i.get("data-name"),direction:"asc"};i.hasClass("files__sortable--sorted")&&(n.direction="desc"),e.setState(n),e.fireEvent("setState",n)});var r=kQuery(".search_button","#files-canvas"),l=function(t){var i={search:"undefined"==typeof t?r.val():t};e.setState(i),e.fireEvent("setState",i)};r.blur(function(){l()}).keypress(function(e){13===e.which&&l()}),kQuery(".search_button--empty","#files-canvas").click(function(){r.val()&&l("")})},setState:function(e){if("undefined"!=typeof e.search){var t=document.id("files-canvas").getElement(".search_button");t&&t.set("value",e.search)}var i=this.container.getElements("th.files__sortable"),n=i.filter('[data-name="'+e.sort+'"]')[0];n&&(i.removeClass("files__sortable--sorted").removeClass("files__sortable--sorted-desc"),n.addClass("files__sortable--sorted"+("asc"===e.direction?"":"-desc")))},checkNode:function(e,t){var i=e.element,n=e.element.match(".files-node")?e.element:e.element.getElement(".files-node"),o=i.getElement("input[type=checkbox]");t!==!1&&this.fireEvent("beforeCheckNode",{row:e,checkbox:o});var s=o.getProperty("checked");s?n.removeClass("selected"):n.addClass("selected"),e.checked=!s,o.setProperty("checked",!s);var a=n.getParent("tbody");if(a){var r=a.getElements(".selected").length;1===r?a.addClass("selected-single").removeClass("selected-multiple"):r>1?a.addClass("selected-multiple").removeClass("selected-single"):a.removeClass("selected-multiple").removeClass("selected-single")}t!==!1&&this.fireEvent("afterCheckNode",{row:e,checkbox:o})},erase:function(e){if("string"==typeof e&&(e=this.nodes.get(e)),e){this.fireEvent("beforeDeleteNode",{node:e});var t=function(){e.element&&e.element.dispose(),this.nodes.erase(e.path),this.fireEvent("afterDeleteNode",{node:e})}.bind(this),i=function(t){this.fireEvent("afterDeleteNodeFail",{node:e,xhr:t})}.bind(this);e["delete"](t,i)}},render:function(){this.fireEvent("beforeRender"),this.container.empty(),this.root=new Files.Grid.Root(this.layout),this.container.adopt(this.root.element),this.renew(),this.fireEvent("afterRender")},renderObject:function(e,t){if(t=t||"alphabetical",this.fireEvent("beforeRenderObject",{object:e,position:t}),e.element=e.render(this.layout),e.element.store("row",e),"last"==t)this.root.adopt(e.element,"bottom");else if("first"==t)this.root.adopt(e.element);else{var i=this.nodes.filter(function(t){return t.type==e.type}).getKeys();if(0===i.length)if("folder"===e.type){var n=this.nodes.getKeys();if(n.length){var o=this.nodes.get(n[0]);e.element.inject(o.element,"before")}else this.root.adopt(e.element,"bottom")}else this.root.adopt(e.element,"bottom");else{i.push(e.path),i=i.sort();var s=i.indexOf(e.path),a=i.length;if(0===s){var o=this.nodes.get(i[1]);e.element.inject(o.element,"before")}else{var o=s+1===a?i[a-2]:i[s-1];o=this.nodes.get(o),e.element.inject(o.element,"after")}}}return this.fireEvent("afterRenderObject",{object:e,position:t}),e.element},reset:function(){this.fireEvent("beforeReset"),this.nodes.each(function(e){e.element&&e.element.dispose(),this.nodes.erase(e.path)}.bind(this)),this.fireEvent("afterReset")},insert:function(e,t){this.fireEvent("beforeInsertNode",{object:e,position:t}),(!this.options.types||this.options.types.contains(e.type))&&(this.renderObject(e,t),this.nodes.set(e.path,e),this.fireEvent("afterInsertNode",{node:e,position:t}))},insertRows:function(e){this.fireEvent("beforeInsertRows",{rows:e}),Object.each(e,function(e){var t=Files[e.type.capitalize()],i=new t(e);this.insert(i,"last")}.bind(this)),this.options.icon_size&&this.setIconSize(this.options.icon_size),this.fireEvent("afterInsertRows",{rows:e})},renew:function(){this.fireEvent("beforeRenew");var e=this.getFolders(),t=this.getFiles(),i=this,n=function(e){var e=i.nodes.get(e);e.element&&e.element.dispose(),i.renderObject(e,"last"),e.checked&&i.checkNode(e,!1)};e.each(n),t.each(n),this.fireEvent("afterRenew")},setLayout:function(e){e&&(this.fireEvent("beforeSetLayout",{layout:e}),this.layout=e,this.options.switchers&&this._updateSwitchers(e),this.fireEvent("afterSetLayout",{layout:e}),this.render())},getFolders:function(){return this.nodes.filter(function(e){return"folder"===e.type}).getKeys().sort()},getFiles:function(){return this.nodes.filter(function(e){return"file"===e.type||"image"==e.type}).getKeys().sort()},setIconSize:function(e){this.fireEvent("beforeSetIconSize",{size:e}),this.options.icon_size=e,this.nodes.getKeys().length&&"icons"==this.layout&&(this.container.getElements(".imgTotal").setStyles({width:e+"px",height:.75*e+"px"}),this.container.getElements(".imgOutline .ellipsis").setStyle("width",e+"px")),this.fireEvent("afterSetIconSize",{size:e})},spin:function(){if(!this.is_spinning){var e=document.getElementById("spinner_container"),t={lines:12,length:7,width:4,radius:10,color:"#666",speed:1,trail:60};this.spinner=new Koowa.Spinner(t),this.is_spinning=!0;var i=this.spinner.spin(e);return i}},unspin:function(){this.spinner&&(this.is_spinning=!1,this.spinner.stop())},_updateSwitchers:function(e){this.options.switchers.removeClass("active").filter(function(t){return t.get("data-layout")==e}).addClass("active")}}),Files.Grid.Root=new Class({Implements:Files.Template,template:"container",initialize:function(e){this.element=this.render(e)},adopt:function(e,t){t=t||"top";var i=this.element;"table"==this.element.get("tag")&&(i=this.element.getElement("tbody")),e.injectInside||(e.injectInside=e.inject),e.injectInside(i,t)}}),!Files)var Files={};if(function(e){Files.Tree=Koowa.Tree.extend({getDefaults:function(){var t=this,i={initial_response:!1,autoOpen:0,onSelectNode:function(){},dataFilter:function(e){return t.filterData(e)}};return e.extend(!0,{},this.supr(),i)},filterData:function(t){var i=t.entities,n=function(t,i){var o=i&&i.path?i.path+"/":"";if(o+=t.name,t=e.extend(t,{id:o,path:o,url:"#"+o,type:"folder"}),t.children){var s=[];Object.each(t.children,function(e){s.push(n(e,t))}),t.children=s}return t};return t.meta.total&&Object.each(i,function(e,t){n(e)}),this.parseData(i)},parseData:function(e){return[{label:this.options.root.text,url:"#",children:e}]},fromUrl:function(e){var t=this;this.tree("loadDataFromUrl",e,null,function(e){Files.app&&Files.app.hasOwnProperty("active")&&t.selectPath(Files.app.active)})},selectPath:function(e){var t=this.tree("getNodeById",e);if(!t){var i=this.tree("getTree");t=i.children.length?i.children[0]:null}this.tree("selectNode",t)},appendNode:function(t,i){void 0===i&&(i=this.tree("getSelectedNode")),i===!1&&(i=this.tree("getTree").children[0]);var n,o=e.extend(!0,{},t,{path:t.id,url:"#"+t.id,type:"folder"});if(i&&i.children&&i.children.length){var s=o.label.toLowerCase();if(i.children[0].name.toLowerCase()>s)n=this.tree("addNodeBefore",o,i.children[0]);else if(i.children[i.children.length-1].name.toLowerCase()<s)n=this.tree("appendNode",o,i);else{for(var a=0;i.children[a].name.toLowerCase()<s;)a++;n=this.tree("addNodeBefore",o,i.children[a])}}else n=this.tree("appendNode",o,i);return this.tree("selectNode",n),this},removeNode:function(e){var t=this.tree("getNodeById",e);t&&this.tree("removeNode",t)},attachHandlers:function(){this._attachHandlers();var t=this.options,i=this,n=this.options.initial_response;this.element.bind({"tree.init":function(){i.element.on("tree.select",function(o){var s;o.node&&(s=e(o.node.element),i.tree("openNode",o.node),n?n=!1:t.onSelectNode(o.node)),o.node&&!o.node.hasOwnProperty("is_open")&&2===o.node.getLevel()&&i.scrollIntoView(o.node,i.element,300),i.element.one("resize",function(){i.tree("getSelectedNode")&&i.scrollIntoView(i.tree("getSelectedNode"),i.element,900)})})},"tree.open":function(e){i.scrollIntoView(e.node,i.element,300)}})}})}(window.kQuery),!Files)var Files={};if(Files.Row=new Class({Implements:[Options,Events,Files.Template],initialize:function(e,t){this.setOptions(t),Object.each(e,function(e,t){this[t]=e}.bind(this)),"string"!=typeof this.name&&(this.name=""),this.path||(this.path=(e.folder?e.folder+"/":"")+e.name),this.identifier=this.path,this.filepath=(e.folder?this.encodePath(e.folder)+"/":"")+this.encode(e.name)},encodePath:function(e,t){var i=e.split("/");return t||(t=this.encode),i=i.map(function(e){return t(e)}),i.join("/")},encode:function(e){return e},realpath:function(e){return e}}),Files.File=new Class({Extends:Files.Row,type:"file",template:"file",initialize:function(e,t){this.parent(e,t),Files.app&&(this.baseurl=Files.app.baseurl),this.size=new Files.Filesize(this.metadata.size),this.filetype=Files.getFileType(this.metadata.extension)},getModifiedDate:function(e){if(this.metadata.modified_date){var t=new Date;return t.setTime(1e3*this.metadata.modified_date),e?t.getDate()+" "+Koowa.Date.getMonthName(t.getMonth()+1,!0)+" "+t.getFullYear():t}return null},"delete":function(e,t){this.fireEvent("beforeDeleteRow");var i=this,n=new Request.JSON({url:Files.app.createRoute({view:"file",folder:i.folder,name:i.name}),method:"post",data:{_action:"delete",csrf_token:Files.token},onSuccess:function(t){"function"==typeof e&&e(t),i.fireEvent("afterDeleteRow",{status:!0,response:t,request:this})},onFailure:function(e){return 204==e.status||1223==e.status?this.onSuccess():(response=e.responseText,"function"==typeof t?t(e):(response=JSON.decode(e.responseText,!0),error=response&&response.error?response.error:Koowa.translate("An error occurred during request"),alert(error)),void i.fireEvent("afterDeleteRow",{status:!1,response:response,request:this,xhr:e}))}});n.send()}}),Files.Image=new Class({Extends:Files.File,type:"image",template:"image",initialize:function(e,t){this.parent(e,t),this.image=this.baseurl+"/"+this.encodePath(this.filepath,this.realpath),this.client_cache=!1,window.sessionStorage&&sessionStorage[this.image.toString()]&&(this.client_cache=sessionStorage[this.image.toString()])},getThumbnail:function(e,t){var i=this,n=new Request.JSON({url:Files.app.createRoute({view:"thumbnail",filename:i.name,folder:i.folder}),method:"get",onSuccess:function(t,i){"function"==typeof e&&e(t)},onFailure:function(e){response=e.responseText,"function"==typeof t?t(e):(response=JSON.decode(e.responseText,!0),error=response&&response.error?response.error:Koowa.translate("An error occurred during request"),alert(error))}});n.send()}}),Files.Folder=new Class({Extends:Files.Row,type:"folder",template:"folder",add:function(e,t,i){this.fireEvent("beforeAddRow");var n=this;request=new Request.JSON({url:Files.app.createRoute({view:"folder",name:n.name,folder:Files.app.getPath()}),method:"post",data:{_action:"add",csrf_token:Files.token},onSuccess:function(t){"function"==typeof e&&e(t),n.fireEvent("afterAddRow",{status:!0,response:t,request:this})},onFailure:function(e){response=e.responseText,"function"==typeof t?t(e):(response=JSON.decode(e.responseText,!0),error=response&&response.error?response.error:Koowa.translate("An error occurred during request"),alert(error)),n.fireEvent("afterAddRow",{status:!1,response:response,request:this,xhr:e})},onComplete:function(e){"function"==typeof i&&i(e)}}),request.send()},"delete":function(e,t){var i=this,n=new Request.JSON({url:Files.app.createRoute({view:"folder",folder:Files.app.getPath(),name:i.name}),method:"post",data:{_action:"delete",csrf_token:Files.token},onSuccess:function(t){"function"==typeof e&&e(t),i.fireEvent("afterDeleteRow",{status:!0,response:t,request:this})},onFailure:function(e){return 204==e.status||1223==e.status?this.onSuccess():(response=e.responseText,"function"==typeof t?t(e):(response=JSON.decode(e.responseText,!0),error=response&&response.error?response.error:Koowa.translate("An error occurred during request"),alert(error)),void i.fireEvent("afterDeleteRow",{status:!1,response:response,request:this,xhr:e}))}});n.send()}}),Files.Paginator=new Class({Implements:[Options,Events],state:null,values:{total:0,limit:0,offset:0,page_total:0,page_current:0},initialize:function(e,t){t.state&&(this.state=t.state,this.setData(this.state.getData())),this.setOptions(t);var e=document.id(e);this.element=e,this.elements={page_total:e.getElement(".page-total"),page_current:e.getElement(".page-current"),page_start:e.getElement(".start a"),page_next:e.getElement(".next a"),page_prev:e.getElement(".prev a"),page_end:e.getElement(".end a"),page_container:e.getElement(".page"),pages:{},limit_box:e.getElement("select")},this.setValues(),this.element.addEvent("click:relay(a)",function(e){e.stop(),"0"!=e.target.get("data-enabled")&&this.fireEvent("clickPage",e.target)}.bind(this)),this.elements.limit_box.addEvent("change",function(e){e.stop(),this.fireEvent("changeLimit",this.elements.limit_box.get("value"))}.bind(this))},setValues:function(){this.fireEvent("beforeSetValues");var e=this.values,t=this.elements;this.setPageData(t.page_start,{offset:0}),this.setPageData(t.page_end,{offset:(e.page_total-1)*e.limit}),this.setPageData(t.page_prev,{offset:Math.max(0,(e.page_current-2)*e.limit)});var i=Math.min((e.page_total-1)*e.limit,e.page_current*e.limit);this.setPageData(t.page_next,{offset:i}),t.page_container.empty();for(var n=1;n<=e.page_total;){var o=null;n==e.page_current?o=new Element("span",{text:n}):3>n||Math.abs(n-e.page_total)<2||Math.abs(n-e.page_current)<2?o=new Element("a",{href:"#",text:n,"data-limit":e.limit,"data-offset":(n-1)*e.limit}):Math.abs(n-e.page_current)<3&&(o=new Element("span",{html:"&hellip;"})),o&&(t.pages[n]=o,o.inject(t.page_container)),n++}t.page_current.set("text",e.page_current),t.page_total.set("text",e.page_total),t.limit_box.set("value",e.limit),this.fireEvent("afterSetValues")},setPageData:function(e,t){this.fireEvent("beforeSetPageData",{page:e,data:t});var i=t.limit||this.values.limit;e.set("data-limit",i),e.set("data-offset",t.offset);var n=t.offset==this.values.offset?"addClass":"removeClass",o=e;o.getParent()===this.elements.page_container||o.getParent()===this.element||o.getParent().match("ul")||(o=o.getParent(),o.getParent()===this.elements.page_container||o.getParent()===this.element||o.getParent().match("ul")||(o=o.getParent())),o[n]("off disabled"),e.set("data-enabled",(t.offset!=this.values.offset)-0),this.fireEvent("afterSetPageData",{page:e,data:t})},setData:function(e){this.fireEvent("beforeSetData",{data:e});var t=this.values;0==e.total?(t.limit=this.state.get("limit"),t.offset=this.state.get("offset"),t.total=0,t.page_total=1,t.page_current=1):(Object.each(e,function(e,i){t[i]=e}),t.limit=Math.max(t.limit,1),t.offset=Math.max(t.offset,0),t.limit>t.total&&(t.offset=0),t.limit||(t.offset=0,t.limit=t.total),t.page_total=Math.ceil(t.total/t.limit),t.offset>t.total&&(t.offset=(t.page_total-1)*t.limit),t.page_current=Math.floor(t.offset/t.limit)+1),this.fireEvent("afterSetData",{data:e})}}),function(){var e=function(e,t,i,n,o){var s=n-o,a=i[s]||i.max,r=e.getChildren().length-1;e.getChildren().each(function(e,t){t>0&&r>t&&(e.setStyle("width",a[t].value),a[t].value<=48?e.removeClass("overflow-ellipsis"):e.addClass("overflow-ellipsis"))})};this.Files||(this.Files={}),Files.Pathway=new Class({Implements:[Options],element:!1,options:{element:"files-pathway",offset:8},initialize:function(e){this.setOptions(e)},setPath:function(t){this.element||(this.element=document.id(this.options.element)),this.element.getParent().setStyle("position","relative");var i=this.element;i.setStyles({overflow:"visible","text-overflow":"ellipsis","white-space":"nowrap",bottom:0,top:0,left:(i.getPrevious()?i.getPrevious().getSize().x:0)+this.options.offset,right:i.getNext().getSize().x+this.options.offset,position:"absolute"}),i.empty();var n=new Element("ul",{"class":"breadcrumb breadcrumb-resizable"}),o=function(e,t,i,n){var o=new Element("li",{title:t,events:{click:function(){e.navigate(i)}}}),s=new Element("span",{text:t});return o.grab(s),n&&s.grab(new Element("span",{"class":"divider"}),"top"),o},s=o(t," "+t.container.title,"",!1).getElement("span").grab(new Element("i",{"class":"icon-database icon-hdd"}),"top").getParent();n.adopt(s);var a=t.getPath().split("/"),r="";if(a.each(function(e){e.trim()&&(r+=r?"/"+e:e,n.adopt(o(t,e,r,!0)))}),n.getLast().addClass("active"),i.setStyle("visibility","hidden"),i.adopt(n),this.pathway&&(window.removeEvent("resize",this.pathway),this.pathway=!1),n.getChildren().length>2){var l={},d=0,c=n.getFirst().getSize().x+n.getLast().getSize().x;n.getChildren().each(function(e,t){if(!e.match(":first-child")&&!e.match(":last-child")){var i=e.getSize().x;l[t]={key:t,value:i},d+=i}});var f={},p=d;for(f[d]=f.max=l;p>0;){--p;var u={key:null,value:0},h={};for(var m in l)if(l.hasOwnProperty(m)){var g=l[m];g.value>u.value&&(u=g),h[m]={key:g.key,value:g.value}}--h[u.key].value,f[p]=h,l=h}e(n,i,f,i.getSize().x,c),i.setStyle("visibility","visible"),this.pathway=function(){e(n,i,f,i.getSize().x,c)},window.addEvent("resize",this.pathway)}else i.setStyle("visibility","visible")}})}(),!Files)var Files={};if(Files.blank_image="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAMAAAAoyzS7AAAABGdBTUEAALGPC/xhBQAAAAd0SU1FB9MICA0xMTLhM9QAAAADUExURf///6fEG8gAAAABdFJOUwBA5thmAAAACXBIWXMAAAsSAAALEgHS3X78AAAACklEQVQIHWNgAAAAAgABz8g15QAAAABJRU5ErkJggg==",Files.App=new Class({Implements:[Events,Options],_tmpl_cache:{},active:null,title:"",cookie:null,options:{root_text:"Root folder",cookie:{path:"/"},persistent:!0,thumbnails:!0,types:null,container:null,active:null,pathway:{element:"files-pathway"},state:{defaults:{}},tree:{enabled:!0,element:"#files-tree"},grid:{element:"files-grid",batch_delete:"#toolbar-delete a",icon_size:150},paginator:{element:"files-paginator"},folder_dialog:{view:"#files-new-folder-modal",input:"#files-new-folder-input",open_button:"#toolbar-newfolder a",create_button:"#files-new-folder-create",onSubmit:function(){},onCreate:function(e){e.input.set("value",""),e.create_button.removeClass("valid").setProperty("disabled","disabled")},onOpen:function(e){kQuery.magnificPopup.open({items:{src:kQuery(e.view),type:"inline"},callbacks:{open:function(){setTimeout(function(){e.input.focus()},100)}}})},onClose:function(){kQuery.magnificPopup.close()},onInit:function(e){var t=kQuery(e.input),i=kQuery(e.create_button),n=function(){kQuery.trim(kQuery(this).val())?i.addClass("valid").prop("disabled",!1):i.removeClass("valid").prop("disabled",!0)};t.on("change",n),window.addEventListener?t.on("input",n):t.on("keyup",n)}},uploader_dialog:{view:"#files-upload",button:"#toolbar-upload a"},move_dialog:{view:"#files-move-modal",button:".btn-primary",open_button:"#toolbar-move"},copy_dialog:{view:"#files-copy-modal",button:".btn-primary",open_button:"#toolbar-copy"},history:{enabled:!0},router:{defaults:{option:"com_files",view:"files",format:"json"}},initial_response:null,refresh_button:"#toolbar-refresh",onAfterSetGrid:function(){window.addEvent("resize",function(){this.setDimensions(!0)}.bind(this)),this.grid.addEvent("onAfterRenew",function(){this.setDimensions(!0)}.bind(this)),this.addEvent("onUploadFile",function(){this.setDimensions(!0)}.bind(this))},onAfterNavigate:function(e){void 0!==e&&(this.setTitle(this.folder.name||this.container.title),kQuery("#upload-files-to, .upload-files-to").text(e?e:this.container.title))},onBeforeSetContainer:function(e){"undefined"!=typeof e.container&&(e.container.title=this.options.root_text)}},initialize:function(e){if(this.setOptions(e),this.options.persistent&&this.options.container){var t="string"==typeof this.options.container?this.options.container:this.options.container.slug;this.cookie="com.files.container."+t}this.options.pathway&&this.setPathway(),this.setState(),this.setHistory(),this.setGrid(),this.setPaginator();var i=this.getUrl();if(i.getData("container")&&!this.options.container&&(this.options.container=i.getData("container")),i.getData("folder")&&(this.options.active=i.getData("folder")),this.options.thumbnails&&this.addEvent("afterSelect",function(e){this.setThumbnails()}),this.options.uploader_dialog&&this.setUploaderDialog(),this.options.container&&this.setContainer(this.options.container),this.options.refresh_button){var n=document.getElement(this.options.refresh_button),o=this;n&&n.addEvent("click",function(e){e.stop(),o.navigate(void 0,"stateless",!0),o.setTree()})}},setState:function(){if(this.fireEvent("beforeSetState"),this.cookie){var e=Cookie.read(this.cookie+".state"),t=JSON.decode(e,!0);t&&("undefined"==typeof this.getUrl().getData("folder")&&(this.options.active=t.folder),delete t.folder,this.options.state.defaults=Object.merge({},this.options.state.defaults,t))}var i=this.options.state;this.state=new Files.State(i),this.fireEvent("afterSetState")},setHistory:function(){if(this.fireEvent("beforeSetHistory"),this.options.history.enabled){var e=this;this.history=History,window.addEvent("popstate",function(t){t&&t.stop();var i=History.getState(),n=e.state.getData(),o=i.data,s=!1;if(Object.each(n,function(e,t){s!==!0&&o&&o[t]&&e!==o[t]&&(s=!0)}),e.container&&(s||e.active!==i.data.folder)){var a=Object.append({},i.data);["option","view","layout","folder","container"].each(function(e){delete a[e]}),e.state.set(a),e.navigate(i.data.folder,"stateless")}}),this.addEvent("afterNavigate",function(t,i){if("stateless"!==i&&e.history){var n={folder:e.active,container:e.container?e.container.slug:null},o=this.state.getData();Object.each(o,function(e,t){"function"!=typeof e&&"undefined"!=typeof e&&(n[t]=e)});var s="initial"===i?"replaceState":"pushState",a=e.getUrl().setData(n,!0).set("fragment","").toString();e.history[s](n,null,a)}})}this.fireEvent("afterSetHistory")},navigate:function(e,t,i,n){this.fireEvent("beforeNavigate",[e,t]),
void 0!==e&&(this.active&&this.state.set("offset",0),this.active="/"==e?"":e),this.grid.reset(),this.grid.spin();var o=this.active.split("/"),s=o[o.length?o.length-1:0],a=o.slice(0,o.length-1).join("/"),r=this,l=function(e){return i&&(e.revalidate_cache=1),this.createRoute(e)}.bind(this),d=function(e){e&&(e.status!==!1?(Object.each(e.entities,function(e){e.baseurl||(e.baseurl=r.baseurl)}),r.grid.insertRows(e.entities),e.partial||(r.grid.unspin(),r.response=e,r.fireEvent("afterSelect",e))):e.error&&alert(e.error))};if(this.folder=new Files.Folder({folder:a,name:s}),n?(d(n),this.grid.unspin()):this.fetch(this.folder.path,l).done(d).progress(d),this.cookie){var c=kQuery.extend(!0,{},this.state.data);c.folder=this.active,Cookie.write(this.cookie+".state",JSON.encode(c),this.options.cookie)}this.fireEvent("afterNavigate",[e,t])},fetch:function(e,t){var i=this,n=kQuery.Deferred(),o=function(e){var t=JSON.decode(e.responseText,!0);t&&t.error&&alert(t.error)},s=Object.append({view:"nodes",folder:e},this.state.getData());if(this.ajax_cache&&this.ajax_cache.abort(),"undefined"!=typeof s.limit&&0!==s.limit)return this.ajax_cache=kQuery.getJSON(t(s)).fail(o),this.ajax_cache;s.limit=100;var a=function(e){return e&&"undefined"!=typeof e.entities&&"undefined"!=typeof e.meta?void(e.meta.offset+e.entities.length<e.meta.total?(e.partial=!0,n.notify(e),s.offset=e.meta.offset+e.meta.limit,i.ajax_cache=kQuery.getJSON(t(s)).done(a).fail(o)):(e.completed=!0,n.resolve(e))):void n.reject("")};return i.ajax_cache=kQuery.getJSON(t(s)).done(a).fail(o),n.promise()},setContainer:function(e){var t=function(e){if(this.fireEvent("beforeSetContainer",{container:e}),this.container=e,this.baseurl=Files.sitebase+"/"+e.relative_path,this.active="",this.uploader&&(this.container.parameters.allowed_extensions&&(this.uploader.settings.filters=[{title:Koowa.translate("All Files"),extensions:this.container.parameters.allowed_extensions.join(",")}]),this.container.parameters.maximum_size)){this.uploader.settings.max_file_size=this.container.parameters.maximum_size;var t=document.id("upload-max-size");t&&t.set("html",new Files.Filesize(this.container.parameters.maximum_size).humanize())}this.container.parameters.thumbnails!==!0?this.options.thumbnails=!1:this.state.set("thumbnails",!0),null!==this.options.types&&(this.options.grid.types=this.options.types,this.state.set("types",this.options.types)),this.options.folder_dialog&&document.getElement(this.options.folder_dialog.view)&&document.getElement(this.options.folder_dialog.view).getElement("form")&&this.setFolderDialog(),this.options.move_dialog&&(this.move_dialog=new Files.MoveDialog(this.options.move_dialog)),this.options.copy_dialog&&(this.copy_dialog=new Files.CopyDialog(this.options.copy_dialog)),this.fireEvent("afterSetContainer",{container:e}),this.setTree(),this.active=this.options.active||"",this.options.active="","string"==typeof this.options.initial_response&&(this.options.initial_response=JSON.decode(this.options.initial_response)),this.navigate(this.active,"initial",!1,this.options.initial_response)}.bind(this);"string"==typeof e?new Request.JSON({url:this.createRoute({view:"container",slug:e,container:!1}),method:"get",onSuccess:function(e){t(e.entities[0])}.bind(this)}).send():t(e)},setPaginator:function(){this.fireEvent("beforeSetPaginator");var e=this.options.paginator,t=this.state;Object.append(e,{state:t,onClickPage:function(e){this.state.set("limit",e.get("data-limit")),this.state.set("offset",e.get("data-offset")),this.navigate()}.bind(this),onChangeLimit:function(e){this.state.set("limit",e);var t=Files.app.paginator.values.total,i=Files.app.paginator.values.offset;t&&(i=e?Math.floor(i/e*e):0),this.state.set("offset",i),this.navigate()}.bind(this)}),this.paginator=new Files.Paginator(e.element,e);var i=this;i.addEvent("afterSelect",function(e){i.paginator.setData({limit:e.meta.limit,offset:e.meta.offset,total:e.meta.total}),i.paginator.setValues()}),this.fireEvent("afterSetPaginator")},setGrid:function(){this.fireEvent("beforeSetGrid");var e=this,t=this.options.grid,i=this.cookie+".grid.layout";this.cookie&&Cookie.read(i)&&(t.layout=Cookie.read(i)),Object.append(t,{onClickFolder:function(e){var t=document.id(e.target),i=t.getParent(".files-node-shadow")||t.getParent(".files-node"),n=i.retrieve("row").path;n&&this.navigate(n)}.bind(this),onClickImage:function(t){var i=document.id(t.target),n=i.getParent(".files-node-shadow")||i.getParent(".files-node"),o=n.retrieve("row"),s=e.createRoute({view:"file",format:"html",name:o.name,folder:o.folder});s&&kQuery.magnificPopup.open({items:{src:s,type:"image"}})},onClickFile:function(e){var t=document.id(e.target),i=t.getParent(".files-node-shadow")||t.getParent(".files-node"),n=i.retrieve("row"),o=Object.append({},n);o.template="file_preview",o=o.render();var s=kQuery(o);s.addClass("mfp-hide koowa"),kQuery.magnificPopup.open({items:{src:s,type:"inline"}})},onBeforeRenderObject:function(t){var i=t.object;i.download_link=e.createRoute({view:"file",format:"html",name:i.name,folder:i.folder})}.bind(this),onAfterSetLayout:function(t){i&&Cookie.write(i,t.layout,e.options.cookie)},onAfterRender:function(){this.setState(e.state.data)},onSetState:function(e){this.state.set(e),this.navigate()}.bind(this)}),this.grid=new Files.Grid(this.options.grid.element,t),this.fireEvent("afterSetGrid")},setTree:function(){if(this.fireEvent("beforeSetTree"),this.options.tree.enabled){var e=this.options.tree,t=this;e=kQuery.extend(!0,{},{onSelectNode:function(e){if(e.id||e.url){var i=e&&e.id?e.id:"";i!=t.active&&t.navigate(i)}},root:{text:this.options.root_text},initial_response:!!this.options.initial_response},e),this.tree=new Files.Tree(kQuery(e.element),e),this.tree.fromUrl(this.createRoute({view:"folders",tree:"1",limit:"2000"})),this.addEvent("afterNavigate",function(e,i){void 0===e||i&&("initial"==i||"stateless"==i)||t.tree.selectPath(e)}),this.grid&&this.grid.addEvent("afterDeleteNode",function(e){var i=e.node;"folder"==i.type&&t.tree.removeNode(i.path)})}this.fireEvent("afterSetTree")},setFolderDialog:function(){var e=this;this._folder_dialog={view:document.getElement(this.options.folder_dialog.view),input:document.getElement(this.options.folder_dialog.input),open_button:document.getElement(this.options.folder_dialog.open_button),create_button:document.getElement(this.options.folder_dialog.create_button)},this.options.folder_dialog.onInit&&this.options.folder_dialog.onInit.call(this,this._folder_dialog),this._folder_dialog.open_button&&this._folder_dialog.open_button.addEvent("click",function(e){e.stop(),this.hasClass("unauthorized")||Files.app.openFolderDialog()}),this._folder_dialog.view.getElement("form")&&this._folder_dialog.view.getElement("form").addEvent("submit",function(t){t.stop(),e._folder_dialog.create_button.setProperty("disabled","disabled"),e.options.folder_dialog.onSubmit&&e.options.folder_dialog.onSubmit.call(e,e._folder_dialog);var i=e._folder_dialog.input,n=i.get("value").trim();if(n.length>0){var o=new Files.Folder({name:n,folder:Files.app.getPath()});o.add(function(t,i){if(t.status===!1)return alert(t.error);var n=t.entities[0],o=Files[n.type.capitalize()],s=new o(n);Files.app.grid.insert(s),Files.app.tree.appendNode({id:s.path,label:s.name}),e.options.folder_dialog.onCreate&&e.options.folder_dialog.onCreate.call(e,e._folder_dialog),e.closeFolderDialog()},null,function(){e._folder_dialog.create_button.setProperty("disabled",!1)})}})},openFolderDialog:function(){return this.options.folder_dialog&&this.options.folder_dialog.onOpen.call(this,this._folder_dialog),!!this.options.folder_dialog},closeFolderDialog:function(){return this.options.folder_dialog&&this.options.folder_dialog.onClose.call(this,this._folder_dialog),!!this.options.folder_dialog},setUploaderDialog:function(){var e=this,t=document.getElement(this.options.uploader_dialog.button),i=document.getElement(this.options.uploader_dialog.view);i&&(this._tmp_uploader=new Element("div",{style:"display:none"}).inject(document.body),document.getElement(this.options.uploader_dialog.view).getParent().inject(this._tmp_uploader).setStyle("visibility","")),t&&t.addEvent("click",function(t){t.stop(),this.hasClass("unauthorized")||e.openUploaderDialog()})},openUploaderDialog:function(){if(this.uploader){var e=this,t=function(){document.getElement(e.options.uploader_dialog.view).getParent().inject(e._tmp_uploader),SqueezeBox.removeEvent("close",t)};SqueezeBox.addEvent("close",t),SqueezeBox.open(document.getElement(e.options.uploader_dialog.view).getParent(),{handler:"adopt",size:{x:700,y:document.getElement(e.options.uploader_dialog.view).getParent().measure(function(){this.setStyle("width",700);var e=this.getSize().y;return this.setStyle("width",""),e})}}),window.addEvent("QueueChanged",this._changeUploaderDialogHeight.bind(this))}return!!this.uploader},closeUploaderDialog:function(){return this.uploader&&(SqueezeBox.close(),window.removeEvent("QueueChanged",this._changeUploaderDialogHeight)),!!this.uploader},_changeUploaderDialogHeight:function(){var e=document.getElement(this.options.uploader_dialog.view).getParent().scrollHeight;SqueezeBox.resize({x:700,y:e})},getUrl:function(){return new URI(window.location.href)},getPath:function(){return this.active},setThumbnails:function(){this.setDimensions(!0);var e=this.grid.nodes;e.getLength()&&e.each(function(e){if("image"===e.filetype){var t=(e.name,e.element.getElement("img.image-thumbnail"));t&&(t.addEvent("load",function(){this.addClass("loaded")}),t.set("src",e.thumbnail?e.thumbnail:Files.blank_image),(e.element.getElement(".files-node")||e.element).addClass("loaded").removeClass("loading"),window.sessionStorage&&(sessionStorage[e.image.toString()]=t.get("src")))}})},setDimensions:function(e){if(this._cached_grid_width||(this._cached_grid_width=0),this._cached_grid_width!=this.grid.root.element.getSize().x||e){var t=this.grid.root.element.getSize().x,i=t/(this.grid.options.icon_size.toInt()+40),n=Math.min(Math.floor(i),this.grid.nodes.getLength());this.grid.root.element.getElements(".files-node-shadow").each(function(e,t,i){e.setStyle("width",100/n+"%")},this),this._cached_grid_width=this.grid.root.element.getSize().x}},setPathway:function(){this.fireEvent("beforeSetPathway");var e=new Files.Pathway(this.options.pathway);this.addEvent("afterSetTitle",e.setPath.bind(e,this)),this.fireEvent("afterSetPathway")},setTitle:function(e){this.fireEvent("beforeSetTitle",{title:e}),this.title=e,this.fireEvent("afterSetTitle",{title:e})},createRoute:function(e){e=Object.merge({},this.options.router.defaults,e||{}),e.container!==!1&&!e.container&&this.container?e.container=this.container.slug:delete e.container,"html"==e.format&&delete e.format;var t="?"+new Hash(e).filter(function(e,t){return"function"!=typeof e}).toQueryString();return this.options.base_url?this.options.base_url+t:t}}),!Files)var Files={};if(function(e){var t=function(e){document.id("files-upload").addClass("uploader-files-queued").removeClass("uploader-files-empty"),e.refresh(),e.unbind("QueueChanged",t),window.fireEvent("QueueChanged")},i=function(i){var n,o=function(e){e.preventDefault(),e.stopPropagation(),e.originalEvent.dataTransfer.dropEffect="copy"},s=function(t){var i=e('<div class="dropzone-focusring"></div>'),o=e('<div class="alert alert-success">'+Koowa.translate("Drop your files to upload to {folder}").replace("{folder}",Files.app.title)+"</div>");return i.css({display:"none",position:"absolute",backgroundColor:"hsla(0, 0%, 100%, 0.75)",top:0,left:0,bottom:0,right:0,zIndex:65558,borderStyle:"solid",borderWidth:"5px",opacity:0,transition:"opacity 300ms",paddingTop:10,textAlign:"center"}),t.append(i),e("#files-upload").append(o),["border-radius","color","background","border"].forEach(function(e){o.css(e,o.css(e))}),o.css({display:"inline-block",margin:"0 auto"}),i.append(o),i.css("border-color",o.css("color")),function(t){t.preventDefault(),t.originalEvent.dataTransfer.dropEffect="copy","none"==i.css("display")&&(o.text(Koowa.translate("Drop your files to upload to {folder}").replace("{folder}",Files.app.title)),i.css("display","block"),setTimeout(function(){i.css("opacity",1),e("#files-upload").is(":visible")||e("#files-canvas").addClass("dropzone-droppable")},1)),clearTimeout(n),n=setTimeout(function(){e(".dropzone-focusring").css("opacity",0).css("display","none"),e("#files-canvas").removeClass("dropzone-droppable")},300)}},a=function(){return function(e){}},r=function(e){var t,n,o={};for(n=0;n<e.length;n++)t=e[n],o[t.name]||(o[t.name]=!0,i.addFile(t))},l=e("#files-canvas"),d=e(document.body);document.id("files-upload").addClass("uploader-droppable"),e("#files-upload-multi_filelist").bind("drop",function(t){t.stopPropagation(),e(document.body).removeClass("dropzone-dragover")}),d.bind("dragover",s(d)),d.bind("dragleave",a(d)),d.bind("dragenter",o),d.bind("drop",function(t){t.preventDefault(),l.removeClass("dragover");var i=t.originalEvent.dataTransfer;if(i&&i.files&&i.files.length){var n=i.files;e("#files-upload").is(":visible")||document.getElement(Files.app.options.uploader_dialog.button).fireEvent("click","DOMEvent"in window?new DOMEvent:new Event),setTimeout(function(){r(n)},300)}}),d.bind("dragend",function(){e(".dropzone-focusring").css("opacity",0).css("display","none")}),i.bind("QueueChanged",t)},n=function(e,t){for(var i=1,n=e.substr(e.lastIndexOf(".")+1),o=e.substr(0,e.lastIndexOf("."));;){if(e=o+" ("+i+")."+n,!t(e))break;i++}return e};Files.createUploader=function(o){o=e.extend({},{element:"#files-upload-multi",multi_selection:!0,media_path:""},o);var s=e(o.element);if(0!==s.length){var a="mushycode"+Math.floor(1e10*Math.random()+1);e('<div id="'+a+'" class="uploader-flash-container" />').appendTo(e(document.body));var r={runtimes:"html5,flash",container:a,browse_button:"pickfiles",multi_selection:o.multi_selection,dragdrop:!0,unique_names:!1,rename:!0,url:"/",flash_swf_url:o.media_path+"koowa/com_files/js/plupload/Moxie.swf",urlstream_upload:!0,multipart_params:{_action:"add",csrf_token:Files.token},filters:{prevent_duplicates:!0},headers:{"X-Requested-With":"XMLHttpRequest"},preinit:{Error:function(e,t){if(t.code==plupload.INIT_ERROR){var i=Koowa.translate("{html5} or {flash} required for uploading files from your computer.",{html5:'<a href="https://google.com/chrome" target="_blank">'+Koowa.translate("HTML5 enabled browser")+"</a>",flash:'<a href="https://get.adobe.com/flashplayer/" target="_blank">'+Koowa.translate("Flash Player")+"<a/>"});setTimeout(function(){s.append('<div class="alert alert-error warning">'+i+"</div>")},100)}}}};if(Files.app&&Files.app.container){if(Files.app.container.parameters.allowed_extensions){var l=Files.app.state.get("types"),d=Files.app.container.parameters.allowed_extensions;"object"==typeof l&&1===l.length&&"image"===l[0]&&(d=e.grep(Files.app.container.parameters.allowed_extensions,function(t){return-1!==e.inArray(t,Files.FileTypes.map.image)})),r.filters.mime_types=[{title:Koowa.translate("All Files"),extensions:d.join(",")}]}r.preinit.Init=function(e){var t="html5"===e.runtime&&e.features.chunks,i=Files.app.container.parameters.maximum_size,n=Files.app.container.server_upload_limit;if(t){var o=Math.max(1048576,n-1048576);o>33554432&&(o=33554432),e.setOption("chunk_size",o)}else(!i||0==i||i>n)&&(i=n-1048576);if(i>0){e.setOption("max_file_size",i);var s=document.id("upload-max-size");s&&s.set("html",new Files.Filesize(i).humanize())}else document.id("upload-max").setStyle("display","none")}}SqueezeBox.addEvent("open",function(){window.fireEvent("refresh")}),window.addEvent("refresh",function(){c.refresh()}),s.pluploadQueue(r);var c=s.pluploadQueue(),f=e(".plupload_start",s),p=function(t){var i=[];return e.each(t,function(e,t){i.push(t.name)}),i},u=function(){f.hasClass("plupload_disabled")||c.start()},h=function(e){var t="";return 1===e.length?t=Koowa.translate("A file with the same name already exists. Would you like to overwrite it?"):e.length>1&&(t=Koowa.translate("Following files already exist. Would you like to overwrite them? {names}",{names:"\n"+e.join("\n")})),t},m=function(t,i){var o=[];"object"==typeof i.entities&&i.entities.length&&(o=p(i.entities)),e.each(c.files,function(e,i){i.id!==t.id&&o.push(i.name)}),t.name=n(t.name,function(t){return-1!==e.inArray(t,o)}),e("#"+t.id).find("div.plupload_file_name span").text(t.name)},g=function(t){if(c.settings.multipart_params.overwrite=0,"object"==typeof t.entities&&t.entities.length){var i=p(t.entities),n=[];if(confirm(h(i)))return c.settings.multipart_params.overwrite=1,u();e.each(c.files,function(t,o){-1!==e.inArray(o.name,i)&&n.push(e.ajax({type:"GET",url:Files.app.createRoute({view:"files",folder:Files.app.getPath(),limit:100,search:o.name.substr(0,o.name.lastIndexOf("."))+" ("})}).done(function(e){return m(o,e)}))}),n&&e.when.apply(kQuery,n).then(function(){u()})}else u()};if(f.click(function(t){t.preventDefault();var i=[];e.each(c.files,function(e,t){0==t.loaded&&i.push(t.name)}),i.length&&e.ajax({url:Files.app.createRoute({view:"files",limit:100,folder:Files.app.getPath()}),type:"POST",data:{_method:"GET",name:i}}).done(g).fail(u)}),c.bind("FilesAdded",function(e){e.files.length>100&&e.splice(0,e.files.length-100)}),!o.multi_selection){var v=function(t){var i=t.files.length;i>1&&e.each(t.files,function(e,n){e!==i-1&&t.removeFile(n)}),w=!1},w=!1;c.bind("QueueChanged",function(e){w||(w=!0,v(e))})}c.bind("ChunkUploaded",function(t,i,n){var o=e.parseJSON(n.response);o.status===!1&&(i.status=plupload.FAILED,F[i.id]=o.error,t.stop())});var y=window.navigator.userAgent.indexOf("MSIE "),b=window.navigator.userAgent.indexOf("Trident/"),_=y>0||b>0,E=function(){document.id("files-upload").addClass("uploader-nodroppable").setStyle("position","").addClass("uploader-files-queued").removeClass("uploader-files-empty"),c.refresh()};_?E():setTimeout(function(){c.features.dragdrop?i(c):E()},1500),c.bind("BeforeUpload",function(e,t){e.settings.url=Files.app.createRoute({view:"file",plupload:1,folder:Files.app.getPath()})}),c.bind("UploadComplete",function(t){e("li.plupload_delete a,div.plupload_buttons",s).show(),t.disableBrowse(!1),t.refresh()});var F={};c.bind("FileUploaded",function(e,t,i){var n,o,s,a=JSON.decode(i.response,!0)||{};if(a.status){if(o=a.entities[0],s=(o.folder?o.folder+"/":"")+o.name,"undefined"==typeof Files.app.grid.nodes[s]){var r=Files[o.type.capitalize()];n=new r(o),Files.app.grid.insert(n)}else n=Files.app.grid.nodes[s],o.metadata&&(n.metadata=o.metadata,n.size=new Files.Filesize(n.metadata.size));if("image"==n.type&&"icons"==Files.app.grid.layout){var l=n.element.getElement("img");l&&(n.getThumbnail(function(e){e.item.thumbnail&&(l.set("src",e.item.thumbnail).addClass("loaded").removeClass("loading"),n.element.getElement(".files-node").addClass("loaded").removeClass("loading"))}),window.fireEvent("resize"))}Files.app.fireEvent("uploadFile",[n])}else F[t.id]=a.error?a.error:Koowa.translate("Unknown error")}),c.bind("StateChanged",function(t){Object.each(F,function(t,i){icon=e("#"+i).attr("class","plupload_failed").find("a").css("display","block"),t&&icon.attr("title",t)})}),$$(".plupload_clear").addEvent("click",function(e){if(e.stop(),confirm(Koowa.translate("Are you sure you want to clear the upload queue? This cannot be undone!"))){var t=c.files.slice(0);t.each(function(e){c.removeFile(e)})}}),Files.app.uploader=c;var S=function(e){$$(".upload-form").setStyle("display","none"),document.id("files-uploader-"+e).setStyle("display","block"),"computer"==e&&s.length&&!c.files.length&&c.features.dragdrop&&(document.id("files-upload").removeClass("uploader-files-queued").addClass("uploader-files-empty"),document.id("files-upload-multi_browse")&&c.bind("QueueChanged",t)),window.fireEvent("refresh")};$$(".upload-form-toggle").addEvent("click",function(e){var t=this.get("href").split("#")[1];$$(".upload-form-toggle").removeClass("active"),e.preventDefault(),this.addClass("active"),S(t)});var x,k,C=document.id("remoteForm"),z=document.id("remote-name"),P=C.getElement(".remote-submit"),O=P.get("value"),N=function(){C.getElement(".remote-wrap").setStyle("margin-right",P.measure(function(){return this.getSize().x}))},A=document.id("remote-url"),D=new Request.JSON({onRequest:function(){x!=this.options.url&&(P.set("value",O),N(),x=this.options.url)},onSuccess:function(e){if(e.error)return this.fireEvent("failure",this.xhr);var t=e["content-length"].toInt(10);if(t&&t<Files.app.container.parameters.maximum_size){var i=new Files.Filesize(t).humanize();P.addClass("btn-primary").set("value",O+" ("+i+")"),N()}else P.removeClass("btn-primary")},onFailure:function(e){var t=JSON.decode(e.responseText,!0);t.code&&4==parseInt(t.code/100,10)?P.removeClass("btn-primary"):P.addClass("btn-primary")}}),T=function(){var e=this.value.trim(),t=new URI(e).get("host");return e&&t&&e.match(t)?(P.removeProperty("disabled"),!0):(P.setProperty("disabled","disabled"),!1)},R=function(){T.call(this)?(Files.app.container.parameters.maximum_size?D.setOptions({url:Files.app.createRoute({view:"proxy",url:this.value})}).get():P.addClass("btn-primary"),z.get("value")&&z.get("value")!=k||(k=new URI(this.value).get("file"),z.set("value",k))):(P.set("value",O).removeClass("btn-primary"),N())};A.addEvent("focus",function(){this.set("placeholder",this.get("title")).removeClass("success")}),A.addEvent("blur",R),A.addEvent("change",T),window.addEventListener?(A.addEventListener("input",T),A.addEventListener("paste",function(){R.delay(0,this)})):A.addEvent("keyup",T);var j=new Request.JSON({url:Files.app.createRoute({view:"file",folder:Files.app.getPath()}),data:{_action:"add",csrf_token:Files.token,file:""},onRequest:function(){P.setProperty("disabled","disabled")},onSuccess:function(e){if(201==this.status&&e.status){var t=e.entities[0],i=Files[t.type.capitalize()],n=new i(t);if(Files.app.grid.insert(n),"image"==n.type&&"icons"==Files.app.grid.layout){var o=n.element.getElement("img");o&&(n.getThumbnail(function(e){e.item.thumbnail&&(o.set("src",e.item.thumbnail).addClass("loaded").removeClass("loading"),n.element.getElement(".files-node").addClass("loaded").removeClass("loading"))}),window.fireEvent("resize"))}Files.app.fireEvent("uploadFile",[n]),P.removeClass("btn-primary").set("value",O),N(),C.reset(),A.set("placeholder",Koowa.translate("Uploaded successfully!")).addClass("success")}else{var s=e.error?e.error:Koowa.translate("Unknown error");alert(Koowa.translate("An error occurred: {error}",{error:s}))}},onFailure:function(t){P.removeProperty("disabled");var i=e.parseJSON(t.response);i&&i.error?alert(Koowa.translate("An error occurred: {error}",{error:i.error})):alert(Koowa.translate("An error occurred with status code: {code}",{code:t.status}))}});C.addEvent("submit",function(e){e.stop(),j.options.data.file=document.id("remote-url").get("value"),j.options.url=Files.app.createRoute({view:"file",folder:Files.app.getPath(),name:document.id("remote-name").get("value")}),j.send()}),N(),document.id("files-upload").getParent().setStyle("visibility","")}}}(kQuery),!Files)var Files={};!function(e){var t=Koowa.Class.extend({initialize:function(t){this.supr(),t={view:e(t.view),tree:e(t.view).find(".tree-container"),button:e(t.button,t.view),open_button:e(t.open_button)},this.setOptions(t),this.attachEvents()},attachEvents:function(){var e=this;this.options.open_button&&this.options.open_button.click(function(t){t.preventDefault(),e.show()}),this.options.view.find("form")&&this.options.view.find("form").submit(function(t){t.preventDefault(),e.submit()})},show:function(){var t=this.options,i=Object.getLength(this.getSelectedNodes());if(!t.open_button.hasClass("unauthorized")&&i){var n=Files.app.tree.tree("toJson"),o=new Koowa.Tree(t.view.find(".tree-container"),{onCanSelectNode:function(e){return e.path!=Files.app.getPath()}});o.tree("loadData",e.parseJSON(n)),this.getSelectedNodes().each(function(e){var t=o.tree("getNodeById",e.path);t&&o.tree("removeNode",t)}),e.magnificPopup.open({items:{src:e(t.view),type:"inline"}})}},hide:function(){this.options.tree instanceof e&&this.options.tree.empty(),e.magnificPopup.close()},getSelectedNodes:function(){return Files.app.grid.nodes.filter(function(e){return e.checked})},handleError:function(e){var t=JSON.decode(e.responseText,!0);this.hide(),t&&t.error&&alert(t.error)}});Files.CopyDialog=t.extend({submit:function(){var t=this,i=this.getSelectedNodes(),n=Object.values(i.map(function(e){return e.name})),o=this.options.view.find(".tree-container").tree("getSelectedNode").path,s=Files.app.createRoute({view:"nodes",folder:Files.app.getPath()});n.length&&(this.options.button.prop("disabled",!0),e.ajax(s,{type:"POST",data:{name:n,destination_folder:o||"",_action:"copy",csrf_token:Files.token}}).done(function(e){var n=Files.app.tree,o=!1;i.each(function(e){var t=n.tree("getNodeById",e.path);t&&(o=!0)}),o&&Files.app.tree.fromUrl(Files.app.createRoute({view:"folders",tree:"1",limit:"2000"})),t.hide()}).fail(e.proxy(this.handleError,this)).always(function(){t.options.button.prop("disabled",!1)}))}}),Files.MoveDialog=t.extend({submit:function(){var t=this,i=this.getSelectedNodes(),n=Object.values(i.map(function(e){return e.name})),o=this.options.view.find(".tree-container").tree("getSelectedNode").path,s=Files.app.createRoute({view:"nodes",folder:Files.app.getPath()});n.length&&(this.options.button.prop("disabled",!0),e.ajax(s,{type:"POST",data:{name:n,destination_folder:o||"",_action:"move",csrf_token:Files.token}}).done(function(e){var n=Files.app.tree,o=!1;i.each(function(e){e.element&&e.element.dispose(),Files.app.grid.nodes.erase(e.path);var t=n.tree("getNodeById",e.path);t&&(o=!0)}),o&&Files.app.tree.fromUrl(Files.app.createRoute({view:"folders",tree:"1",limit:"2000"})),t.hide()}).fail(e.proxy(this.handleError,this)).always(function(){t.options.button.prop("disabled",!1)}))}})}(window.kQuery);
