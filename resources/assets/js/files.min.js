if(function(e,t){"use strict";var i=e.console||t,n=e.document,o=e.navigator,a=e.sessionStorage||!1,s=e.setTimeout,r=e.clearTimeout,l=e.setInterval,c=e.clearInterval,d=e.JSON,u=e.alert,h=e.History=e.History||{},p=e.history;if(d.stringify=d.stringify||d.encode,d.parse=d.parse||d.decode,void 0!==h.init)throw new Error("History.js Core has already been loaded...");h.init=function(){return void 0!==h.Adapter&&(void 0!==h.initCore&&h.initCore(),void 0!==h.initHtml4&&h.initHtml4(),!0)},h.initCore=function(){if(void 0!==h.initCore.initialized)return!1;if(h.initCore.initialized=!0,h.options=h.options||{},h.options.hashChangeInterval=h.options.hashChangeInterval||100,h.options.safariPollInterval=h.options.safariPollInterval||500,h.options.doubleCheckInterval=h.options.doubleCheckInterval||500,h.options.storeInterval=h.options.storeInterval||1e3,h.options.busyDelay=h.options.busyDelay||250,h.options.debug=h.options.debug||!1,h.options.initialTitle=h.options.initialTitle||n.title,h.intervalList=[],h.clearAllIntervals=function(){var e,t=h.intervalList;if(null!=t){for(e=0;e<t.length;e++)c(t[e]);h.intervalList=null}},h.debug=function(){h.options.debug&&h.log.apply(h,arguments)},h.log=function(){var e,t,o,a,s,r=!(void 0===i||void 0===i.log||void 0===i.log.apply),l=n.getElementById("log");for(r?(e=(a=Array.prototype.slice.call(arguments)).shift(),void 0!==i.debug?i.debug.apply(i,[e,a]):i.log.apply(i,[e,a])):e="\n"+arguments[0]+"\n",t=1,o=arguments.length;t<o;++t){if("object"==typeof(s=arguments[t])&&void 0!==d)try{s=d.stringify(s)}catch(e){}e+="\n"+s+"\n"}return l?(l.value+=e+"\n-----\n",l.scrollTop=l.scrollHeight-l.clientHeight):r||u(e),!0},h.getInternetExplorerMajorVersion=function(){return h.getInternetExplorerMajorVersion.cached=void 0!==h.getInternetExplorerMajorVersion.cached?h.getInternetExplorerMajorVersion.cached:function(){for(var e=3,t=n.createElement("div"),i=t.getElementsByTagName("i");(t.innerHTML="\x3c!--[if gt IE "+ ++e+"]><i></i><![endif]--\x3e")&&i[0];);return e>4&&e}()},h.isInternetExplorer=function(){return h.isInternetExplorer.cached=void 0!==h.isInternetExplorer.cached?h.isInternetExplorer.cached:Boolean(h.getInternetExplorerMajorVersion())},h.emulated={pushState:!Boolean(e.history&&e.history.pushState&&e.history.replaceState&&!(/ Mobile\/([1-7][a-z]|(8([abcde]|f(1[0-8]))))/i.test(o.userAgent)||/AppleWebKit\/5([0-2]|3[0-2])/i.test(o.userAgent))),hashChange:Boolean(!("onhashchange"in e||"onhashchange"in n)||h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<8)},h.enabled=!h.emulated.pushState,h.bugs={setHash:Boolean(!h.emulated.pushState&&"Apple Computer, Inc."===o.vendor&&/AppleWebKit\/5([0-2]|3[0-3])/.test(o.userAgent)),safariPoll:Boolean(!h.emulated.pushState&&"Apple Computer, Inc."===o.vendor&&/AppleWebKit\/5([0-2]|3[0-3])/.test(o.userAgent)),ieDoubleCheck:Boolean(h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<8),hashEscape:Boolean(h.isInternetExplorer()&&h.getInternetExplorerMajorVersion()<7)},h.isEmptyObject=function(e){for(var t in e)return!1;return!0},h.cloneObject=function(e){var t,i;return e?(t=d.stringify(e),i=d.parse(t)):i={},i},h.getRootUrl=function(){var e=n.location.protocol+"//"+(n.location.hostname||n.location.host);return n.location.port&&(e+=":"+n.location.port),e+="/"},h.getBaseHref=function(){var e=n.getElementsByTagName("base"),t="";return 1===e.length&&(t=e[0].href.replace(/[^\/]+$/,"")),(t=t.replace(/\/+$/,""))&&(t+="/"),t},h.getBaseUrl=function(){return h.getBaseHref()||h.getBasePageUrl()||h.getRootUrl()},h.getPageUrl=function(){return((h.getState(!1,!1)||{}).url||n.location.href).replace(/\/+$/,"").replace(/[^\/]+$/,(function(e,t,i){return/\./.test(e)?e:e+"/"}))},h.getBasePageUrl=function(){return n.location.href.replace(/[#\?].*/,"").replace(/[^\/]+$/,(function(e,t,i){return/[^\/]$/.test(e)?"":e})).replace(/\/+$/,"")+"/"},h.getFullUrl=function(e,t){var i=e,n=e.substring(0,1);return t=void 0===t||t,/[a-z]+\:\/\//.test(e)||(i="/"===n?h.getRootUrl()+e.replace(/^\/+/,""):"#"===n?h.getPageUrl().replace(/#.*/,"")+e:"?"===n?h.getPageUrl().replace(/[\?#].*/,"")+e:t?h.getBaseUrl()+e.replace(/^(\.\/)+/,""):h.getBasePageUrl()+e.replace(/^(\.\/)+/,"")),i.replace(/\#$/,"")},h.getShortUrl=function(e){var t=e,i=h.getBaseUrl(),n=h.getRootUrl();return h.emulated.pushState&&(t=t.replace(i,"")),t=t.replace(n,"/"),h.isTraditionalAnchor(t)&&(t="./"+t),t=t.replace(/^(\.\/)+/g,"./").replace(/\#$/,"")},h.store={},h.idToState=h.idToState||{},h.stateToId=h.stateToId||{},h.urlToId=h.urlToId||{},h.storedStates=h.storedStates||[],h.savedStates=h.savedStates||[],h.normalizeStore=function(){h.store.idToState=h.store.idToState||{},h.store.urlToId=h.store.urlToId||{},h.store.stateToId=h.store.stateToId||{}},h.getState=function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!0);var i=h.getLastSavedState();return!i&&t&&(i=h.createStateObject()),e&&((i=h.cloneObject(i)).url=i.cleanUrl||i.url),i},h.getIdByState=function(e){var t,i=h.extractId(e.url);if(!i)if(t=h.getStateString(e),void 0!==h.stateToId[t])i=h.stateToId[t];else if(void 0!==h.store.stateToId[t])i=h.store.stateToId[t];else{for(;i=(new Date).getTime()+String(Math.random()).replace(/\D/g,""),void 0!==h.idToState[i]||void 0!==h.store.idToState[i];);h.stateToId[t]=i,h.idToState[i]=e}return i},h.normalizeState=function(e){var t,i;return e&&"object"==typeof e||(e={}),void 0!==e.normalized?e:(e.data&&"object"==typeof e.data||(e.data={}),(t={}).normalized=!0,t.title=e.title||"",t.url=h.getFullUrl(h.unescapeString(e.url||n.location.href)),t.hash=h.getShortUrl(t.url),t.data=h.cloneObject(e.data),t.id=h.getIdByState(t),t.cleanUrl=t.url.replace(/\??\&_suid.*/,""),t.url=t.cleanUrl,i=!h.isEmptyObject(t.data),(t.title||i)&&(t.hash=h.getShortUrl(t.url).replace(/\??\&_suid.*/,""),/\?/.test(t.hash)||(t.hash+="?"),t.hash+="&_suid="+t.id),t.hashedUrl=h.getFullUrl(t.hash),(h.emulated.pushState||h.bugs.safariPoll)&&h.hasUrlDuplicate(t)&&(t.url=t.hashedUrl),t)},h.createStateObject=function(e,t,i){var n={data:e,title:t,url:i};return n=h.normalizeState(n)},h.getStateById=function(e){return e=String(e),h.idToState[e]||h.store.idToState[e]||t},h.getStateString=function(e){var t;return t={data:h.normalizeState(e).data,title:e.title,url:e.url},d.stringify(t)},h.getStateId=function(e){return h.normalizeState(e).id},h.getHashByState=function(e){return h.normalizeState(e).hash},h.extractId=function(e){var t;return(t=/(.*)\&_suid=([0-9]+)$/.exec(e))&&t[1]||e,(t?String(t[2]||""):"")||!1},h.isTraditionalAnchor=function(e){return!/[\/\?\.]/.test(e)},h.extractState=function(e,t){var i,n,o=null;return t=t||!1,(i=h.extractId(e))&&(o=h.getStateById(i)),o||(n=h.getFullUrl(e),(i=h.getIdByUrl(n)||!1)&&(o=h.getStateById(i)),o||!t||h.isTraditionalAnchor(e)||(o=h.createStateObject(null,null,n))),o},h.getIdByUrl=function(e){return h.urlToId[e]||h.store.urlToId[e]||t},h.getLastSavedState=function(){return h.savedStates[h.savedStates.length-1]||t},h.getLastStoredState=function(){return h.storedStates[h.storedStates.length-1]||t},h.hasUrlDuplicate=function(e){var t;return(t=h.extractState(e.url))&&t.id!==e.id},h.storeState=function(e){return h.urlToId[e.url]=e.id,h.storedStates.push(h.cloneObject(e)),e},h.isLastSavedState=function(e){var t=!1;return h.savedStates.length&&(t=e.id===h.getLastSavedState().id),t},h.saveState=function(e){return!h.isLastSavedState(e)&&(h.savedStates.push(h.cloneObject(e)),!0)},h.getStateByIndex=function(e){return void 0===e?h.savedStates[h.savedStates.length-1]:e<0?h.savedStates[h.savedStates.length+e]:h.savedStates[e]},h.getHash=function(){return h.unescapeHash(n.location.hash)},h.unescapeString=function(t){for(var i,n=t;(i=e.decodeURI(n))!==n;)n=i;return n},h.unescapeHash=function(e){var t=h.normalizeHash(e);return t=h.unescapeString(t)},h.normalizeHash=function(e){return e.replace(/[^#]*#/,"").replace(/#.*/,"")},h.setHash=function(e,t){var i,o,a;return!1!==t&&h.busy()?(h.pushQueue({scope:h,callback:h.setHash,args:arguments,queue:t}),!1):(i=h.escapeHash(e),h.busy(!0),(o=h.extractState(e,!0))&&!h.emulated.pushState?h.pushState(o.data,o.title,o.url,!1):n.location.hash!==i&&(h.bugs.setHash?(a=h.getPageUrl(),h.pushState(null,null,a+"#"+i,!1)):n.location.hash=i),h)},h.escapeHash=function(t){var i=h.normalizeHash(t);return i=e.encodeURI(i),h.bugs.hashEscape||(i=i.replace(/\%21/g,"!").replace(/\%26/g,"&").replace(/\%3D/g,"=").replace(/\%3F/g,"?")),i},h.getHashByUrl=function(e){var t=String(e).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2");return t=h.unescapeHash(t)},h.setTitle=function(e){var t,i=e.title;i||(t=h.getStateByIndex(0))&&t.url===e.url&&(i=t.title||h.options.initialTitle);try{n.getElementsByTagName("title")[0].innerHTML=i.replace("<","&lt;").replace(">","&gt;").replace(" & "," &amp; ")}catch(e){}return n.title=i,h},h.queues=[],h.busy=function(e){if(void 0!==e?h.busy.flag=e:void 0===h.busy.flag&&(h.busy.flag=!1),!h.busy.flag){r(h.busy.timeout);var t=function(){var e,i,n;if(!h.busy.flag)for(e=h.queues.length-1;e>=0;--e)0!==(i=h.queues[e]).length&&(n=i.shift(),h.fireQueueItem(n),h.busy.timeout=s(t,h.options.busyDelay))};h.busy.timeout=s(t,h.options.busyDelay)}return h.busy.flag},h.busy.flag=!1,h.fireQueueItem=function(e){return e.callback.apply(e.scope||h,e.args||[])},h.pushQueue=function(e){return h.queues[e.queue||0]=h.queues[e.queue||0]||[],h.queues[e.queue||0].push(e),h},h.queue=function(e,t){return"function"==typeof e&&(e={callback:e}),void 0!==t&&(e.queue=t),h.busy()?h.pushQueue(e):h.fireQueueItem(e),h},h.clearQueue=function(){return h.busy.flag=!1,h.queues=[],h},h.stateChanged=!1,h.doubleChecker=!1,h.doubleCheckComplete=function(){return h.stateChanged=!0,h.doubleCheckClear(),h},h.doubleCheckClear=function(){return h.doubleChecker&&(r(h.doubleChecker),h.doubleChecker=!1),h},h.doubleCheck=function(e){return h.stateChanged=!1,h.doubleCheckClear(),h.bugs.ieDoubleCheck&&(h.doubleChecker=s((function(){return h.doubleCheckClear(),h.stateChanged||e(),!0}),h.options.doubleCheckInterval)),h},h.safariStatePoll=function(){var t=h.extractState(n.location.href);if(!h.isLastSavedState(t))return t||h.createStateObject(),h.Adapter.trigger(e,"popstate"),h},h.back=function(e){return!1!==e&&h.busy()?(h.pushQueue({scope:h,callback:h.back,args:arguments,queue:e}),!1):(h.busy(!0),h.doubleCheck((function(){h.back(!1)})),p.go(-1),!0)},h.forward=function(e){return!1!==e&&h.busy()?(h.pushQueue({scope:h,callback:h.forward,args:arguments,queue:e}),!1):(h.busy(!0),h.doubleCheck((function(){h.forward(!1)})),p.go(1),!0)},h.go=function(e,t){var i;if(e>0)for(i=1;i<=e;++i)h.forward(t);else{if(!(e<0))throw new Error("History.go: History.go requires a positive or negative integer passed.");for(i=-1;i>=e;--i)h.back(t)}return h},h.emulated.pushState){var f=function(){};h.pushState=h.pushState||f,h.replaceState=h.replaceState||f}else h.onPopState=function(t,i){var o,a,s,r=!1;return h.doubleCheckComplete(),(a=h.getHash())?((s=h.extractState(a||n.location.href,!0))?h.replaceState(s.data,s.title,s.url,!1):(h.Adapter.trigger(e,"anchorchange"),h.busy(!1)),h.expectedStateId=!1,!1):((r=(o=h.Adapter.extractEventData("state",t,i)||!1)?h.getStateById(o):h.expectedStateId?h.getStateById(h.expectedStateId):h.extractState(n.location.href))||(r=h.createStateObject(null,null,n.location.href)),h.expectedStateId=!1,h.isLastSavedState(r)?(h.busy(!1),!1):(h.storeState(r),h.saveState(r),h.setTitle(r),h.Adapter.trigger(e,"statechange"),h.busy(!1),!0))},h.Adapter.bind(e,"popstate",h.onPopState),h.pushState=function(t,i,n,o){if(h.getHashByUrl(n)&&h.emulated.pushState)throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(!1!==o&&h.busy())return h.pushQueue({scope:h,callback:h.pushState,args:arguments,queue:o}),!1;h.busy(!0);var a=h.createStateObject(t,i,n);return h.isLastSavedState(a)?h.busy(!1):(h.storeState(a),h.expectedStateId=a.id,p.pushState(a.id,a.title,a.url),h.Adapter.trigger(e,"popstate")),!0},h.replaceState=function(t,i,n,o){if(h.getHashByUrl(n)&&h.emulated.pushState)throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).");if(!1!==o&&h.busy())return h.pushQueue({scope:h,callback:h.replaceState,args:arguments,queue:o}),!1;h.busy(!0);var a=h.createStateObject(t,i,n);return h.isLastSavedState(a)?h.busy(!1):(h.storeState(a),h.expectedStateId=a.id,p.replaceState(a.id,a.title,a.url),h.Adapter.trigger(e,"popstate")),!0};if(a){try{h.store=d.parse(a.getItem("History.store"))||{}}catch(e){h.store={}}h.normalizeStore()}else h.store={},h.normalizeStore();h.Adapter.bind(e,"beforeunload",h.clearAllIntervals),h.Adapter.bind(e,"unload",h.clearAllIntervals),h.saveState(h.storeState(h.extractState(n.location.href,!0))),a&&(h.onUnload=function(){var e,t;try{e=d.parse(a.getItem("History.store"))||{}}catch(t){e={}}for(t in e.idToState=e.idToState||{},e.urlToId=e.urlToId||{},e.stateToId=e.stateToId||{},h.idToState)h.idToState.hasOwnProperty(t)&&(e.idToState[t]=h.idToState[t]);for(t in h.urlToId)h.urlToId.hasOwnProperty(t)&&(e.urlToId[t]=h.urlToId[t]);for(t in h.stateToId)h.stateToId.hasOwnProperty(t)&&(e.stateToId[t]=h.stateToId[t]);h.store=e,h.normalizeStore(),a.setItem("History.store",d.stringify(e))},h.intervalList.push(l(h.onUnload,h.options.storeInterval)),h.Adapter.bind(e,"beforeunload",h.onUnload),h.Adapter.bind(e,"unload",h.onUnload)),h.emulated.pushState||(h.bugs.safariPoll&&h.intervalList.push(l(h.safariStatePoll,h.options.safariPollInterval)),"Apple Computer, Inc."!==o.vendor&&"Mozilla"!==(o.appCodeName||"")||(h.Adapter.bind(e,"hashchange",(function(){h.Adapter.trigger(e,"popstate")})),h.getHash()&&h.Adapter.onDomLoad((function(){h.Adapter.trigger(e,"hashchange")}))))},h.init()}(window),function(e,t){"use strict";var i=e.History=e.History||{},n=e.MooTools,o=e.Element;if(void 0!==i.Adapter)throw new Error("History.js Adapter has already been loaded...");"1.2"===n.version.substring(0,3)?o.NativeEvents=$extend(o.NativeEvents,{popstate:2,hashchange:2}):Object.append(o.NativeEvents,{popstate:2,hashchange:2}),i.Adapter={bind:function(e,t,i){("string"==typeof e?document.id(e):e).addEvent(t,i)},trigger:function(e,t,i){("string"==typeof e?document.id(e):e).fireEvent(t,i)},extractEventData:function(e,t){return t&&t.event&&t.event[e]||t&&t[e]||undefined},onDomLoad:function(t){e.addEvent("domready",t)}},void 0!==i.init&&i.init()}(window),function(){var rsplit=function(e,t){for(var i,n=t.exec(e),o=new Array;null!=n;)i=n.index,t.lastIndex,0!=i&&(e.substring(0,i),o.push(e.substring(0,i)),e=e.slice(i)),o.push(n[0]),e=e.slice(n[0].length),n=t.exec(e);return""==!e&&o.push(e),o},chop=function(e){return e.substr(0,e.length-1)},extend=function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};EJS=function(e){if(e="string"==typeof e?{view:e}:e,this.set_options(e),e.precompiled)return this.template={},this.template.process=e.precompiled,void EJS.update(this.name,this);if(e.element){if("string"==typeof e.element){var t=e.element;if(e.element=document.getElementById(e.element),null==e.element)throw t+"does not exist!"}e.element.value?this.text=e.element.value:this.text=e.element.innerHTML,this.name=e.element.id,this.type="["}else if(e.url){e.url=EJS.endExt(e.url,this.extMatch),this.name=this.name?this.name:e.url;var i=e.url;if(n=EJS.get(this.name,this.cache))return n;if(n==EJS.INVALID_PATH)return null;try{this.text=EJS.request(i+(this.cache?"":"?"+Math.random()))}catch(e){}if(null==this.text)throw{type:"EJS",message:"There is no template at "+i}}var n;(n=new EJS.Compiler(this.text,this.type)).compile(e,this.name),EJS.update(this.name,this),this.template=n},EJS.prototype={render:function(e,t){e=e||{},this._extra_helpers=t;var i=new EJS.Helpers(e,t||{});return this.template.process.call(e,e,i)},update:function(element,options){if("string"==typeof element&&(element=document.getElementById(element)),null==options)return _template=this,function(e){EJS.prototype.update.call(_template,element,e)};"string"==typeof options?(params={},params.url=options,_template=this,params.onComplete=function(request){var object=eval(request.responseText);EJS.prototype.update.call(_template,element,object)},EJS.ajax_request(params)):element.innerHTML=this.render(options)},out:function(){return this.template.out},set_options:function(e){this.type=e.type||EJS.type,this.cache=null!=e.cache?e.cache:EJS.cache,this.text=e.text||null,this.name=e.name||null,this.ext=e.ext||EJS.ext,this.extMatch=new RegExp(this.ext.replace(/\./,"."))}},EJS.endExt=function(e,t){return e?(t.lastIndex=0,e+(t.test(e)?"":this.ext)):null},EJS.Scanner=function(e,t,i){extend(this,{left_delimiter:t+"%",right_delimiter:"%"+i,double_left:t+"%%",double_right:"%%"+i,left_equal:t+"%=",left_comment:t+"%#"}),this.SplitRegexp="["==t?/(\[%%)|(%%\])|(\[%=)|(\[%#)|(\[%)|(%\]\n)|(%\])|(\n)/:new RegExp("("+this.double_left+")|(%%"+this.double_right+")|("+this.left_equal+")|("+this.left_comment+")|("+this.left_delimiter+")|("+this.right_delimiter+"\n)|("+this.right_delimiter+")|(\n)"),this.source=e,this.stag=null,this.lines=0},EJS.Scanner.to_text=function(e){return null==e||void 0===e?"":e instanceof Date?e.toDateString():e.toString?e.toString():""},EJS.Scanner.prototype={scan:function(e){if(scanline=this.scanline,regex=this.SplitRegexp,""==!this.source)for(var t=rsplit(this.source,/\n/),i=0;i<t.length;i++){var n=t[i];this.scanline(n,regex,e)}},scanline:function(e,t,i){this.lines++;for(var n=rsplit(e,t),o=0;o<n.length;o++){var a=n[o];if(null!=a)try{i(a,this)}catch(e){throw{type:"EJS.Scanner",line:this.lines}}}}},EJS.Buffer=function(e,t){this.line=new Array,this.script="",this.pre_cmd=e,this.post_cmd=t;for(var i=0;i<this.pre_cmd.length;i++)this.push(e[i])},EJS.Buffer.prototype={push:function(e){this.line.push(e)},cr:function(){this.script=this.script+this.line.join("; "),this.line=new Array,this.script=this.script+"\n"},close:function(){if(this.line.length>0){for(var e=0;e<this.post_cmd.length;e++)this.push(pre_cmd[e]);this.script=this.script+this.line.join("; "),line=null}}},EJS.Compiler=function(e,t){this.pre_cmd=["var ___ViewO = [];"],this.post_cmd=new Array,this.source=" ",null!=e&&("string"==typeof e?(e=(e=e.replace(/\r\n/g,"\n")).replace(/\r/g,"\n"),this.source=e):e.innerHTML&&(this.source=e.innerHTML),"string"!=typeof this.source&&(this.source=""));var i=">";switch(t=t||"<"){case"[":i="]";break;case"<":break;default:throw t+" is not a supported deliminator"}this.scanner=new EJS.Scanner(this.source,t,i),this.out=""},EJS.Compiler.prototype={compile:function(options,name){options=options||{},this.out="";var put_cmd="___ViewO.push(",insert_cmd=put_cmd,buff=new EJS.Buffer(this.pre_cmd,this.post_cmd),content="",clean=function(e){return e=(e=(e=e.replace(/\\/g,"\\\\")).replace(/\n/g,"\\n")).replace(/"/g,'\\"')};this.scanner.scan((function(e,t){if(null==t.stag)switch(e){case"\n":content+="\n",buff.push(put_cmd+'"'+clean(content)+'");'),buff.cr(),content="";break;case t.left_delimiter:case t.left_equal:case t.left_comment:t.stag=e,content.length>0&&buff.push(put_cmd+'"'+clean(content)+'")'),content="";break;case t.double_left:content+=t.left_delimiter;break;default:content+=e}else switch(e){case t.right_delimiter:switch(t.stag){case t.left_delimiter:"\n"==content[content.length-1]?(content=chop(content),buff.push(content),buff.cr()):buff.push(content);break;case t.left_equal:buff.push(insert_cmd+"(EJS.Scanner.to_text("+content+")))")}t.stag=null,content="";break;case t.double_right:content+=t.right_delimiter;break;default:content+=e}})),content.length>0&&buff.push(put_cmd+'"'+clean(content)+'")'),buff.close(),this.out=buff.script+";";var to_be_evaled="/*"+name+"*/this.process = function(_CONTEXT,_VIEW) { try { with(_VIEW) { with (_CONTEXT) {"+this.out+" return ___ViewO.join('');}}}catch(e){e.lineNumber=null;throw e;}};";try{eval(to_be_evaled)}catch(e){if("undefined"==typeof JSLINT)throw e;JSLINT(this.out);for(var i=0;i<JSLINT.errors.length;i++){var error=JSLINT.errors[i];if("Unnecessary semicolon."!=error.reason){error.line++;var e=new Error;throw e.lineNumber=error.line,e.message=error.reason,options.view&&(e.fileName=options.view),e}}}}},EJS.config=function(e){EJS.cache=null!=e.cache?e.cache:EJS.cache,EJS.type=null!=e.type?e.type:EJS.type,EJS.ext=null!=e.ext?e.ext:EJS.ext;var t=EJS.templates_directory||{};EJS.templates_directory=t,EJS.get=function(e,i){return 0==i?null:t[e]?t[e]:null},EJS.update=function(e,i){null!=e&&(t[e]=i)},EJS.INVALID_PATH=-1},EJS.config({cache:!0,type:"<",ext:".ejs"}),EJS.Helpers=function(e,t){this._data=e,this._extras=t,extend(this,t)},EJS.Helpers.prototype={view:function(e,t,i){return i||(i=this._extras),t||(t=this._data),new EJS(e).render(t,i)},to_text:function(e,t){return null==e||void 0===e?t||"":e instanceof Date?e.toDateString():e.toString?e.toString().replace(/\n/g,"<br />").replace(/''/g,"'"):""}},EJS.newRequest=function(){for(var e=[function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new XMLHttpRequest},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],t=0;t<e.length;t++)try{var i=e[t]();if(null!=i)return i}catch(e){continue}},EJS.request=function(e){var t=new EJS.newRequest;t.open("GET",e,!1);try{t.send(null)}catch(e){return null}return 404==t.status||2==t.status||0==t.status&&""==t.responseText?null:t.responseText},EJS.ajax_request=function(e){e.method=e.method?e.method:"GET";var t=new EJS.newRequest;t.onreadystatechange=function(){4==t.readyState&&(t.status,e.onComplete(t))},t.open(e.method,e.url),t.send(null)},EJS.Helpers.prototype.date_tag=function(e,t,i){t instanceof Date||(t=new Date);for(var n=["January","February","March","April","May","June","July","August","September","October","November","December"],o=[],a=[],s=[],r=t.getFullYear(),l=t.getMonth(),c=t.getDate(),d=r-15;d<r+15;d++)o.push({value:d,text:d});for(var u=0;u<12;u++)a.push({value:u,text:n[u]});for(var h=0;h<31;h++)s.push({value:h+1,text:h+1});return this.select_tag(e+"[year]",r,o,{id:e+"[year]"})+this.select_tag(e+"[month]",l,a,{id:e+"[month]"})+this.select_tag(e+"[day]",c,s,{id:e+"[day]"})},EJS.Helpers.prototype.form_tag=function(e,t){return(t=t||{}).action=e,1==t.multipart&&(t.method="post",t.enctype="multipart/form-data"),this.start_tag_for("form",t)},EJS.Helpers.prototype.form_tag_end=function(){return this.tag_end("form")},EJS.Helpers.prototype.hidden_field_tag=function(e,t,i){return this.input_field_tag(e,t,"hidden",i)},EJS.Helpers.prototype.input_field_tag=function(e,t,i,n){return(n=n||{}).id=n.id||e,n.value=t||"",n.type=i||"text",n.name=e,this.single_tag_for("input",n)},EJS.Helpers.prototype.is_current_page=function(e){return window.location.href==e||window.location.pathname==e},EJS.Helpers.prototype.link_to=function(e,t,i){if(!e)e="null";if(!i)i={};return i.confirm&&(i.onclick=' var ret_confirm = confirm("'+i.confirm+'"); if(!ret_confirm){ return false;} ',i.confirm=null),i.href=t,this.start_tag_for("a",i)+e+this.tag_end("a")},EJS.Helpers.prototype.submit_link_to=function(e,t,i){if(!e)e="null";if(!i)i={};return i.onclick=i.onclick||"",i.confirm&&(i.onclick=' var ret_confirm = confirm("'+i.confirm+'"); if(!ret_confirm){ return false;} ',i.confirm=null),i.value=e,i.type="submit",i.onclick=i.onclick+(t?this.url_for(t):"")+"return false;",this.start_tag_for("input",i)},EJS.Helpers.prototype.link_to_if=function(e,t,i,n,o,a){return this.link_to_unless(0==e,t,i,n,o,a)},EJS.Helpers.prototype.link_to_unless=function(e,t,i,n,o){return n=n||{},e?o&&"function"==typeof o?o(t,i,n,o):t:this.link_to(t,i,n)},EJS.Helpers.prototype.link_to_unless_current=function(e,t,i,n){return i=i||{},this.link_to_unless(this.is_current_page(t),e,t,i,n)},EJS.Helpers.prototype.password_field_tag=function(e,t,i){return this.input_field_tag(e,t,"password",i)},EJS.Helpers.prototype.select_tag=function(e,t,i,n){(n=n||{}).id=n.id||e,n.value=t,n.name=e;var o="";o+=this.start_tag_for("select",n);for(var a=0;a<i.length;a++){var s=i[a],r={value:s.value};s.value==t&&(r.selected="selected"),o+=this.start_tag_for("option",r)+s.text+this.tag_end("option")}return o+=this.tag_end("select")},EJS.Helpers.prototype.single_tag_for=function(e,t){return this.tag(e,t,"/>")},EJS.Helpers.prototype.start_tag_for=function(e,t){return this.tag(e,t)},EJS.Helpers.prototype.submit_tag=function(e,t){return(t=t||{}).type=t.type||"submit",t.value=e||"Submit",this.single_tag_for("input",t)},EJS.Helpers.prototype.tag=function(e,t,i){if(!i)i=">";var n=" ";for(var o in t){if(null!=t[o])var a=t[o].toString();else a="";"Class"==o&&(o="class"),-1!=a.indexOf("'")?n+=o+'="'+a+'" ':n+=o+"='"+a+"' "}return"<"+e+n+i},EJS.Helpers.prototype.tag_end=function(e){return"</"+e+">"},EJS.Helpers.prototype.text_area_tag=function(e,t,i){return(i=i||{}).id=i.id||e,i.name=i.name||e,t=t||"",i.size&&(i.cols=i.size.split("x")[0],i.rows=i.size.split("x")[1],delete i.size),i.cols=i.cols||50,i.rows=i.rows||4,this.start_tag_for("textarea",i)+t+this.tag_end("textarea")},EJS.Helpers.prototype.text_tag=EJS.Helpers.prototype.text_area_tag,EJS.Helpers.prototype.text_field_tag=function(e,t,i){return this.input_field_tag(e,t,"text",i)},EJS.Helpers.prototype.url_for=function(e){return'window.location="'+e+'";'},EJS.Helpers.prototype.img_tag=function(e,t,i){return(i=i||{}).src=e,i.alt=t,this.single_tag_for("img",i)}}(),function(e,t){e.Koowa||(e.Koowa={}),"object"==typeof exports?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Koowa.Spinner=t()}(this,(function(){"use strict";var e,t=["webkit","Moz","ms","O"],i={};function n(e,t){var i,n=document.createElement(e||"div");for(i in t)n[i]=t[i];return n}function o(e){for(var t=1,i=arguments.length;t<i;t++)e.appendChild(arguments[t]);return e}var a=function(){var e=n("style",{type:"text/css"});return o(document.getElementsByTagName("head")[0],e),e.sheet||e.styleSheet}();function s(t,n,o,s){var r=["opacity",n,~~(100*t),o,s].join("-"),l=.01+o/s*100,c=Math.max(1-(1-t)/n*(100-l),t),d=e.substring(0,e.indexOf("Animation")).toLowerCase(),u=d&&"-"+d+"-"||"";return i[r]||(a.insertRule("@"+u+"keyframes "+r+"{0%{opacity:"+c+"}"+l+"%{opacity:"+t+"}"+(l+.01)+"%{opacity:1}"+(l+n)%100+"%{opacity:"+t+"}100%{opacity:"+c+"}}",a.cssRules.length),i[r]=1),r}function r(e,i){var n,o,a=e.style;for(i=i.charAt(0).toUpperCase()+i.slice(1),o=0;o<t.length;o++)if(void 0!==a[n=t[o]+i])return n;if(void 0!==a[i])return i}function l(e,t){for(var i in t)e.style[r(e,i)||i]=t[i];return e}function c(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)void 0===e[n]&&(e[n]=i[n])}return e}function d(e){for(var t={x:e.offsetLeft,y:e.offsetTop};e=e.offsetParent;)t.x+=e.offsetLeft,t.y+=e.offsetTop;return t}function u(e,t){return"string"==typeof e?e:e[t%e.length]}var h={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:"#000",direction:1,speed:1,trail:100,opacity:1/4,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto",position:"relative"};function p(e){if(void 0===this)return new p(e);this.opts=c(e||{},p.defaults,h)}p.defaults={},c(p.prototype,{spin:function(t){this.stop();var i,o,a=this,s=a.opts,r=a.el=l(n(0,{className:s.className}),{position:s.position,width:0,zIndex:s.zIndex}),c=s.radius+s.length+s.width;if(t&&(t.insertBefore(r,t.firstChild||null),o=d(t),i=d(r),l(r,{left:("auto"==s.left?o.x-i.x+(t.offsetWidth>>1):parseInt(s.left,10)+c)+"px",top:("auto"==s.top?o.y-i.y+(t.offsetHeight>>1):parseInt(s.top,10)+c)+"px"})),r.setAttribute("role","progressbar"),a.lines(r,a.opts),!e){var u,h=0,p=(s.lines-1)*(1-s.direction)/2,f=s.fps,g=f/s.speed,m=(1-s.opacity)/(g*s.trail/100),v=g/s.lines;!function e(){h++;for(var t=0;t<s.lines;t++)u=Math.max(1-(h+(s.lines-t)*v)%g*m,s.opacity),a.opacity(r,t*s.direction+p,u,s);a.timeout=a.el&&setTimeout(e,~~(1e3/f))}()}return a},stop:function(){var e=this.el;return e&&(clearTimeout(this.timeout),e.parentNode&&e.parentNode.removeChild(e),this.el=void 0),this},lines:function(t,i){var a,r=0,c=(i.lines-1)*(1-i.direction)/2;function d(e,t){return l(n(),{position:"absolute",width:i.length+i.width+"px",height:i.width+"px",background:e,boxShadow:t,transformOrigin:"left",transform:"rotate("+~~(360/i.lines*r+i.rotate)+"deg) translate("+i.radius+"px,0)",borderRadius:(i.corners*i.width>>1)+"px"})}for(;r<i.lines;r++)a=l(n(),{position:"absolute",top:1+~(i.width/2)+"px",transform:i.hwaccel?"translate3d(0,0,0)":"",opacity:i.opacity,animation:e&&s(i.opacity,i.trail,c+r*i.direction,i.lines)+" "+1/i.speed+"s linear infinite"}),i.shadow&&o(a,l(d("#000","0 0 4px #000"),{top:"2px"})),o(t,o(a,d(u(i.color,r),"0 0 1px rgba(0,0,0,.1)")));return t},opacity:function(e,t,i){t<e.childNodes.length&&(e.childNodes[t].style.opacity=i)}});var f=l(n("group"),{behavior:"url(#default#VML)"});return!r(f,"transform")&&f.adj?function(){function e(e,t){return n("<"+e+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',t)}a.addRule(".spin-vml","behavior:url(#default#VML)"),p.prototype.lines=function(t,i){var n=i.length+i.width,a=2*n;function s(){return l(e("group",{coordsize:a+" "+a,coordorigin:-n+" "+-n}),{width:a,height:a})}var r,c=2*-(i.width+i.length)+"px",d=l(s(),{position:"absolute",top:c,left:c});function h(t,a,r){o(d,o(l(s(),{rotation:360/i.lines*t+"deg",left:~~a}),o(l(e("roundrect",{arcsize:i.corners}),{width:n,height:i.width,left:i.radius,top:-i.width>>1,filter:r}),e("fill",{color:u(i.color,t),opacity:i.opacity}),e("stroke",{opacity:0}))))}if(i.shadow)for(r=1;r<=i.lines;r++)h(r,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(r=1;r<=i.lines;r++)h(r);return o(t,d)},p.prototype.opacity=function(e,t,i,n){var o=e.firstChild;n=n.shadow&&n.lines||0,o&&t+n<o.childNodes.length&&(o=(o=(o=o.childNodes[t+n])&&o.firstChild)&&o.firstChild)&&(o.opacity=i)}}():e=r(f,"animation"),p})),!Files)var Files={};if(Files.Filesize=function(e){this.size=e},Files.Filesize.prototype.units=["B","KB","MB","GB","TB","PB"],Files.Filesize.prototype.humanize=function(){for(var e=0,t=this.size;t>=1024;)t/=1024,e++;return(0===e||t%1==0?t:t.toFixed(2))+" "+Koowa.translate(this.units[e])},Files.urlEncoder=function(e){e=encodeURI(e);var t={"\\?":"%3F","#":"%23"};for(var i in t){var n=new RegExp(i,"g");e=e.replace(n,t[i])}return e},Files.FileTypes={},Files.FileTypes.map={audio:["aif","aiff","alac","amr","flac","ogg","m3u","m4a","mid","mp3","mpa","wav","wma"],video:["3gp","avi","flv","mkv","mov","mp4","mpg","mpeg","rm","swf","vob","wmv"],image:["bmp","gif","jpg","jpeg","png","psd","tif","tiff"],document:["doc","docx","rtf","txt","xls","xlsx","pdf","ppt","pptx","pps","xml"],archive:["7z","gz","rar","tar","zip"]},Files.getFileType=function(e){var t="document",i=Files.FileTypes.map;for(var n in e=e.toLowerCase(),i){if(i.hasOwnProperty(n))if(-1!=i[n].indexOf(e)){t=n;break}}return t},!Files)var Files={};if(Files.State=new Class({Implements:Options,data:{},defaults:{},options:{defaults:{}},initialize:function(e){this.setOptions(e),this.options.data&&Object.append(this.data,this.options.data),this.options.defaults&&(Object.append(this.defaults,this.options.defaults),Object.append(this.data,this.defaults))},getData:function(){return this.data},setDefaults:function(){return this.set(this.defaults),this},set:function(e,t){return"object"==typeOf(e)?Object.append(this.data,e):this.data[e]=t,this},get:function(e,t){return this.data[e]||t},unset:function(e){delete this.data[e]}}),!Files)var Files={};if(Files.Template=new Class({Implements:[Events],render:function(e){var t=this.template;"default"!==(e=e||"default")&&(t=e+"_"+t),this.fireEvent("beforeRender",{layout:e,template:t});var i=new EJS({element:t}).render(this),n=new(Files.Template[e.capitalize()])(i);return this.fireEvent("afterRender",{layout:e,template:t,result:n}),n}}),Files.Template.Details=new Class({initialize:function(e){var t=new Element("div",{html:e}).getElement("table");return t||new Element("div",{html:"<table><tbody>"+e+"</tbody></table>"}).getElement("tr")}}),Files.Template.Default=new Class({initialize:function(e){return new Element("div",{html:e}).getFirst()}}),Files.Template.Icons=new Class({initialize:function(e){return new Element("div",{html:e}).getFirst()}}),Files.Template.Compact=new Class({initialize:function(e){var t=new Element("div",{html:e}).getElement("div");return t||new Element("div",{html:"<table><tbody>"+e+"</tbody></table>"}).getElement("tr")}}),!Files)var Files={};if(Files.Grid=new Class({Implements:[Events,Options],layout:"icons",options:{onClickFolder:function(){},onClickFile:function(){},onClickImage:function(){},onDeleteNode:function(){},onSwitchLayout:function(){},switchers:".k-js-layout-switcher",layout:!1,spinner_container:".k-loader-container",batch_delete:!1,icon_size:150,types:null},initialize:function(e,t){this.setOptions(t),this.spinner_container=kQuery(this.options.spinner_container),this.nodes=new Hash,this.container=document.id(e),this.options.switchers&&(this.options.switchers=document.getElements(this.options.switchers)),this.options.batch_delete&&(this.options.batch_delete=document.getElement(this.options.batch_delete)),this.options.layout&&this.setLayout(this.options.layout),this.render(),this.attachEvents()},attachEvents:function(){var e=this,t=function(t,i){e.container.addEvent(t,(function(t){t.stop(),e.fireEvent(i,arguments)}))};t("click:relay(.files-folder a.navigate)","clickFolder"),t("click:relay(.files-file a.navigate)","clickFile"),t("click:relay(.files-image a.navigate)","clickImage");var i=function(t){if(!t.target.match("a.navigate")){"input"==t.target.get("tag")&&t.target.setProperty("checked",!t.target.getProperty("checked"));var i=t.target.getParent(".files-node-shadow");i||(i=t.target.match(".files-node")?t.target:t.target.getParent(".files-node")),e.checkNode(i.retrieve("row"))}};this.container.addEvent("click:relay(div.js-select-node)",i.bind(this)),this.container.addEvent("click:relay(input.files-select)",i.bind(this)),this.container.addEvent("click",(function(t){if("details"===e.layout){var i=t.target;if("a"!==i.get("tag")&&"input"!==i.get("tag")&&!("i"===i.get("tag")&&i.hasClass("icon-download")||"span"===i.get("tag")&&"a"===i.getParent().get("tag"))){var n=i.getParent(".files-node-shadow")||i.getParent(".files-node");n&&(row=n.retrieve("row"),row&&e.checkNode(row))}}}));var n=function(e){e.stop&&e.stop();var t=e.target.getParent(".files-node-shadow");t||(t=e.target.match(".files-node")?e.target:e.target.getParent(".files-node")),this.erase(t.retrieve("row").path)}.bind(this);if(this.container.addEvent("click:relay(.delete-node)",n),e.addEvent("afterDeleteNodeFail",(function(e){var t=e.xhr,i=JSON.decode(t.responseText,!0);i&&i.error&&alert(i.error)})),this.options.batch_delete){var o=new Chain,a=function(){o.callChain()};this.addEvent("afterCheckNode",function(){var e=this.container.getElements("input[type=checkbox]:checked");this.options.batch_delete.setProperty("disabled",!e.length)}.bind(this)),this.options.batch_delete.addEvent("click",function(t){t.stop();var i=0,s=[],r=0,l=[],c=this.container.getElements("input[type=checkbox]:checked.files-select").filter((function(e){if(e.checked){var t=(e.getParent(".files-node-shadow")||e.getParent(".files-node")).retrieve("row").name;return e.getParent(".files-node").hasClass("files-folder")?(r++,l.push(t)):(i++,s.push(t)),!0}})),d="";if(i+r===1)d=Koowa.translate("You are deleting {item}. Are you sure?",{item:r?l[0]:s[0]});else{var u=i+r,h=Koowa.translate("{count} files and folders");d=Koowa.translate("You are deleting {items}. Are you sure?"),!r&&i?h=Koowa.translate("{count} files"):r&&!i&&(h=Koowa.translate("{count} folders")),h=h.replace("{count}",u),d=d.replace("{items}",h)}if(!c.length||!confirm(d))return!1;e.addEvent("afterDeleteNode",a),e.addEvent("afterDeleteNodeFail",a),c.each((function(e){e.checked&&o.chain((function(){n({target:e})}))})),o.chain((function(){e.removeEvent("afterDeleteNode",a),e.removeEvent("afterDeleteNodeFail",a),o.clearChain()})),o.callChain()}.bind(this))}if(this.options.switchers&&this.options.switchers.addEvent("click",(function(t){t.stop();var i=this.get("data-layout");e.setLayout(i),e._updateSwitchers(i)})),this.options.icon_size){var s=this.options.icon_size;this.addEvent("beforeRenderObject",(function(e){e.object.icon_size=s}))}this.container.addEvent("click:relay(.k-js-files-sortable)",(function(t){var i=t.target.match("th")?t.target:t.target.getParent("th"),n={sort:i.get("data-name"),direction:"asc"};i.hasClass("k-js-files-sorted")&&(n.direction="desc"),e.setState(n),e.fireEvent("setState",n)}));var r=kQuery(".k-search__field","#files-canvas"),l=kQuery(".k-search__empty"),c=function(t){var i={search:void 0===t?r.val():t};e.setState(i),e.fireEvent("setState",i),i.search&&""!==i.search||l.removeClass("k-is-visible")};r.blur((function(){c()})).on("keypress",(function(e){13===e.which&&(c(),r.blur())})).on("input",(function(e){kQuery(this).val()?l.addClass("k-is-visible"):l.removeClass("k-is-visible")})),r.val()&&l.addClass("k-is-visible"),kQuery(".k-search__empty","#files-canvas").click((function(){event.preventDefault(),r.val()&&(r.val(""),c(""))}))},setState:function(e){if(void 0!==e.search){var t=document.id("files-canvas").getElement(".search_button");t&&t.set("value",e.search)}var i=this.container.getElements(".k-js-files-sortable"),n=i.filter('[data-name="'+e.sort+'"]')[0];if(n){i.removeClass("k-js-files-sorted").removeClass("k-js-files-sorted-desc"),kQuery(".k-js-sort-icon").remove(),n.addClass("k-js-files-sorted"+("asc"===e.direction?"":"-desc"));var o=kQuery('<span class="k-js-sort-icon k-icon-sort-'+("asc"===e.direction?"ascending":"descending")+'" />');kQuery('th[data-name="'+e.sort+'"]').find("a").append(o)}},checkNode:function(e,t){var i=e.element,n=e.element.match(".files-node")?e.element:e.element.getElement(".files-node"),o=i.getElement("input[type=checkbox]");!1!==t&&this.fireEvent("beforeCheckNode",{row:e,checkbox:o});var a=o.getProperty("checked"),s=n.getElement(".k-card");a?(n.removeClass("k-is-selected"),s&&s.removeClass("k-is-selected")):(n.addClass("k-is-selected"),s&&s.addClass("k-is-selected")),e.checked=!a,o.setProperty("checked",!a),!1!==t&&this.fireEvent("afterCheckNode",{row:e,checkbox:o})},erase:function(e){if("string"==typeof e&&(e=this.nodes.get(e)),e){this.fireEvent("beforeDeleteNode",{node:e});var t=function(){e.element&&e.element.dispose(),this.nodes.erase(e.path),this.fireEvent("afterDeleteNode",{node:e})}.bind(this),i=function(t){this.fireEvent("afterDeleteNodeFail",{node:e,xhr:t})}.bind(this);e.delete(t,i)}},render:function(){this.fireEvent("beforeRender"),this.container.empty(),this.root=new Files.Grid.Root(this.layout),this.container.adopt(this.root.element),this.renew(),this.setFootable(),this.fireEvent("afterRender")},setFootable:function(){var e=kQuery(".k-js-responsive-table");e.length&&"details"===this.layout&&(e.hasClass("footable")?e.trigger("footable_redraw"):e.footable({toggleSelector:".footable-toggle",breakpoints:{phone:400,tablet:600,desktop:800}}))},renderObject:function(e,t){if(t=t||"alphabetical",this.fireEvent("beforeRenderObject",{object:e,position:t}),e.element=e.render(this.layout),e.element.store("row",e),"last"==t)this.root.adopt(e.element,"bottom");else if("first"==t)this.root.adopt(e.element);else{var i=this.nodes.filter((function(t){return t.type==e.type})).getKeys();if(0===i.length)if("folder"===e.type){var n=this.nodes.getKeys();if(n.length){var o=this.nodes.get(n[0]);e.element.inject(o.element,"before")}else this.root.adopt(e.element,"bottom")}else this.root.adopt(e.element,"bottom");else{i.push(e.path);var a=(i=i.sort()).indexOf(e.path),s=i.length;if(0===a){o=this.nodes.get(i[1]);e.element.inject(o.element,"before")}else{o=a+1===s?i[s-2]:i[a-1];o=this.nodes.get(o),e.element.inject(o.element,"after")}}}return this.fireEvent("afterRenderObject",{object:e,position:t}),e.element},getCount:function(){return this.nodes.getLength()},reset:function(){this.fireEvent("beforeReset"),this.nodes.each(function(e){e.element&&e.element.dispose(),this.nodes.erase(e.path)}.bind(this)),this.fireEvent("afterReset")},insert:function(e,t){this.fireEvent("beforeInsertNode",{object:e,position:t}),this.options.types&&!this.options.types.contains(e.type)||(this.renderObject(e,t),this.nodes.set(e.path,e),this.fireEvent("afterInsertNode",{node:e,position:t}))},insertRows:function(e){var t={rows:e};this.fireEvent("beforeInsertRows",t),Object.each(t.rows,function(e){var t=new(0,Files[e.type.capitalize()])(e);this.insert(t,"last")}.bind(this)),this.options.icon_size&&this.setIconSize(this.options.icon_size),this.fireEvent("afterInsertRows",t)},renew:function(){this.fireEvent("beforeRenew");var e=this.getFolders(),t=this.getFiles(),i=this,n=function(e){(e=i.nodes.get(e)).element&&e.element.dispose(),i.renderObject(e,"last"),e.checked&&i.checkNode(e,!1)};e.each(n),t.each(n),this.fireEvent("afterRenew")},setLayout:function(e){e&&(this.fireEvent("beforeSetLayout",{layout:e}),this.layout=e,this.options.switchers&&this._updateSwitchers(e),this.fireEvent("afterSetLayout",{layout:e}),this.render())},getFolders:function(){return this.nodes.filter((function(e){return"folder"===e.type})).getKeys().sort()},getFiles:function(){return this.nodes.filter((function(e){return"file"===e.type||"image"==e.type})).getKeys().sort()},setIconSize:function(e){this.fireEvent("beforeSetIconSize",{size:e}),this.options.icon_size=e,this.nodes.getKeys().length&&"icons"==this.layout&&(this.container.getElements(".imgTotal").setStyles({width:e+"px",height:.75*e+"px"}),this.container.getElements(".imgOutline .ellipsis").setStyle("width",e+"px")),this.fireEvent("afterSetIconSize",{size:e})},spin:function(){this.spinner_container.removeClass("k-is-hidden")},unspin:function(){this.spinner_container.addClass("k-is-hidden"),kodekitUI.gallery(),kodekitUI.sidebarToggle()},_updateSwitchers:function(e){this.options.switchers.removeClass("k-is-active").filter((function(t){return t.get("data-layout")==e})).addClass("k-is-active")}}),Files.Grid.Root=new Class({Implements:Files.Template,template:"container",initialize:function(e){this.element=this.render(e)},adopt:function(e,t){t=t||"top";var i=this.element;if("table"==this.element.get("tag")&&(i=this.element.getElement("tbody")),"tr"===e.get("tag")){var n=i.getElement("tbody");n&&(i=n)}e.injectInside||(e.injectInside=e.inject),e.injectInside(i,t)}}),!Files)var Files={};if(function(e){Files.Tree=Koowa.Tree.extend({getDefaults:function(){var t=this,i={initial_response:!1,autoOpen:0,onSelectNode:function(){},dataFilter:function(e){return t.filterData(e)}};return e.extend(!0,{},this.supr(),i)},filterData:function(t){var i=this,n=t.entities,o=function(t,n){var a=!n&&i.options.root_path?i.options.root_path+"/":"";if(a+=n&&n.path?n.path+"/":"",a+=t.name,(t=e.extend(t,{id:a,path:a,url:"#"+a,type:"folder"})).children){var s=[];Object.each(t.children,(function(e){s.push(o(e,t))})),t.children=s}return t};return t.meta.total&&Object.each(n,(function(e,t){o(e)})),this.parseData(n)},parseData:function(e){var t={label:this.options.root.text,url:"#",children:e};return this.options.root_path&&(t.id=this.options.root_path,t.url="#"+t.id),[t]},fromUrl:function(e,t){var i=this;this.tree("loadDataFromUrl",e,null,(function(e){Files.app&&Files.app.hasOwnProperty("active")&&i.selectPath(Files.app.active),t&&t(e)}))},selectPath:function(e){var t=this.tree("getNodeById",e);if(!t){var i=this.tree("getTree");t=i.children.length?i.children[0]:null}this.tree("selectNode",t)},appendNode:function(t,i){void 0===i&&(i=this.tree("getSelectedNode")),!1===i&&(i=this.tree("getTree").children[0]);var n,o=e.extend(!0,{},t,{path:t.id,url:"#"+t.id,type:"folder"});if(i&&i.children&&i.children.length){var a=o.label.toLowerCase();if(i.children[0].name.toLowerCase()>a)n=this.tree("addNodeBefore",o,i.children[0]);else if(i.children[i.children.length-1].name.toLowerCase()<a)n=this.tree("appendNode",o,i);else{for(var s=0;i.children[s].name.toLowerCase()<a;)s++;n=this.tree("addNodeBefore",o,i.children[s])}}else n=this.tree("appendNode",o,i);return this.tree("selectNode",n),this},removeNode:function(e){var t=this.tree("getNodeById",e);t&&this.tree("removeNode",t)},attachHandlers:function(){this._attachHandlers();var t=this.options,i=this,n=this.options.initial_response;this.element.bind({"tree.init":function(){i.element.on("tree.select",(function(o){o.node&&(e(o.node.element),i.tree("openNode",o.node),n?n=!1:t.onSelectNode(o.node)),o.node&&!o.node.hasOwnProperty("is_open")&&2===o.node.getLevel()&&i.scrollIntoView(o.node,i.element,300),i.element.one("resize",(function(){i.tree("getSelectedNode")&&i.scrollIntoView(i.tree("getSelectedNode"),i.element,900)}))}))},"tree.open":function(e){i.scrollIntoView(e.node,i.element,300)}})}})}(window.kQuery),!Files)var Files={};if(Files.Row=new Class({Implements:[Options,Events,Files.Template],initialize:function(e,t){this.setOptions(t),Object.each(e,function(e,t){this[t]=e}.bind(this)),"string"!=typeof this.name&&(this.name=""),this.path||(this.path=(e.folder?e.folder+"/":"")+e.name),this.identifier=this.path,this.filepath=(e.folder?this.encodePath(e.folder)+"/":"")+this.encode(e.name)},encodePath:function(e,t){var i=e.split("/");return t||(t=this.encode),(i=i.map((function(e){return t(e)}))).join("/")},encode:function(e){return e},realpath:function(e){return e}}),Files.File=new Class({Extends:Files.Row,type:"file",template:"file",initialize:function(e,t){this.parent(e,t),Files.app&&(this.baseurl=Files.app.baseurl),this.size=new Files.Filesize(this.metadata.size),this.filetype=Files.getFileType(this.metadata.extension),this.client_cache=!1},getModifiedDate:function(e){if(this.metadata.modified_date){var t=new Date;return t.setTime(1e3*this.metadata.modified_date),e?t.toLocaleString("default",{year:"numeric",month:"short",day:"numeric"}):t}return null},delete:function(e,t){this.fireEvent("beforeDeleteRow");var i=this;new Request.JSON({url:Files.app.createRoute({view:"file",folder:i.folder,name:i.name}),method:"post",data:{_method:"delete",csrf_token:Files.token},onSuccess:function(t){"function"==typeof e&&e(t),i.fireEvent("afterDeleteRow",{status:!0,response:t,request:this})},onFailure:function(e){if(204==e.status||1223==e.status)return this.onSuccess();response=e.responseText,"function"==typeof t?t(e):(response=JSON.decode(e.responseText,!0),error=response&&response.error?response.error:Koowa.translate("An error occurred during request"),alert(error)),i.fireEvent("afterDeleteRow",{status:!1,response:response,request:this,xhr:e})}}).send()}}),Files.Image=new Class({Extends:Files.File,type:"image",template:"image",initialize:function(e,t){this.parent(e,t),this.image=this.baseurl+"/"+this.encodePath(this.filepath,this.realpath),this.client_cache=!1},getThumbnail:function(e,t){new Request.JSON({url:Files.app.createRoute({view:"file",name:this.name,folder:this.folder,thumbnails:Files.app.options.thumbnails}),method:"get",onSuccess:function(t,i){"function"==typeof e&&e(t)},onFailure:function(e){response=e.responseText,"function"==typeof t?t(e):(response=JSON.decode(e.responseText,!0),error=response&&response.error?response.error:Koowa.translate("An error occurred during request"),alert(error))}}).send()}}),Files.Folder=new Class({Extends:Files.Row,type:"folder",template:"folder",add:function(e,t,i){this.fireEvent("beforeAddRow");var n=this;request=new Request.JSON({url:Files.app.createRoute({view:"folder",name:n.name,folder:Files.app.getPath()}),method:"post",data:{_action:"add",csrf_token:Files.token},onSuccess:function(t){"function"==typeof e&&e(t),n.fireEvent("afterAddRow",{status:!0,response:t,request:this})},onFailure:function(e){response=e.responseText,"function"==typeof t?t(e):(response=JSON.decode(e.responseText,!0),error=response&&response.error?response.error:Koowa.translate("An error occurred during request"),alert(error)),n.fireEvent("afterAddRow",{status:!1,response:response,request:this,xhr:e})},onComplete:function(e){"function"==typeof i&&i(e)}}),request.send()},delete:function(e,t){var i=this;new Request.JSON({url:Files.app.createRoute({view:"folder",folder:Files.app.getPath(),name:i.name}),method:"post",data:{_method:"delete",csrf_token:Files.token},onSuccess:function(t){"function"==typeof e&&e(t),i.fireEvent("afterDeleteRow",{status:!0,response:t,request:this})},onFailure:function(e){if(204==e.status||1223==e.status)return this.onSuccess();response=e.responseText,"function"==typeof t?t(e):(response=JSON.decode(e.responseText,!0),error=response&&response.error?response.error:Koowa.translate("An error occurred during request"),alert(error)),i.fireEvent("afterDeleteRow",{status:!1,response:response,request:this,xhr:e})}}).send()}}),Files.Paginator=new Class({Implements:[Options,Events],state:null,values:{total:0,limit:0,offset:0,page_total:0,page_current:0},initialize:function(e,t){t.state&&(this.state=t.state,this.setData(this.state.getData())),this.setOptions(t);e=document.id(e);this.element=e,this.elements={page_total:e.getElement(".page-total"),page_current:e.getElement(".page-current"),page_start:e.getElement(".start a"),page_next:e.getElement(".next a"),page_prev:e.getElement(".prev a"),page_end:e.getElement(".end a"),page_container:e.getElement(".k-pagination__pages"),pages:{},limit_box:e.getElement("select")},this.setValues(),this.element.addEvent("click:relay(a)",function(e){e.stop(),"0"!=e.target.get("data-enabled")&&this.fireEvent("clickPage",e.target)}.bind(this)),this.elements.limit_box.addEvent("change",function(e){e.stop(),this.fireEvent("changeLimit",this.elements.limit_box.get("value"))}.bind(this))},setValues:function(){this.fireEvent("beforeSetValues");var e=this.values,t=this.elements;this.setPageData(t.page_start,{offset:0}),this.setPageData(t.page_end,{offset:(e.page_total-1)*e.limit}),this.setPageData(t.page_prev,{offset:Math.max(0,(e.page_current-2)*e.limit)});var i=Math.min((e.page_total-1)*e.limit,e.page_current*e.limit);this.setPageData(t.page_next,{offset:i}),this.element.getElements(".k-js-page").dispose();for(var n=1;n<=e.page_total;){var o=null,a=!1;if(n==e.page_current?(a=!0,o=new Element("span",{text:n})):n<3||Math.abs(n-e.page_total)<2||Math.abs(n-e.page_current)<2?o=new Element("a",{href:"#",text:n,"data-limit":e.limit,"data-offset":(n-1)*e.limit}):Math.abs(n-e.page_current)<3&&(o=new Element("span",{html:"&hellip;"})),o){var s=new Element("li",{class:"k-js-page "+(a?"k-is-active":"")});o.inject(s),t.pages[n]=o,s.inject(t.page_container),t.page_next.getParent().inject(t.page_container)}n++}t.limit_box.set("value",e.limit),this.fireEvent("afterSetValues")},setPageData:function(e,t){this.fireEvent("beforeSetPageData",{page:e,data:t});var i=t.limit||this.values.limit;e.set("data-limit",i),e.set("data-offset",t.offset);var n=t.offset==this.values.offset?"addClass":"removeClass",o=e;o.getParent()===this.elements.page_container||o.getParent()===this.element||o.getParent().match("ul")||(o=o.getParent()).getParent()===this.elements.page_container||o.getParent()===this.element||o.getParent().match("ul")||(o=o.getParent()),o[n]("off disabled"),e.set("data-enabled",(t.offset!=this.values.offset)-0),this.fireEvent("afterSetPageData",{page:e,data:t})},setData:function(e){this.fireEvent("beforeSetData",{data:e});var t=this.values;0==e.total?(t.limit=this.state.get("limit"),t.offset=this.state.get("offset"),t.total=0,t.page_total=1,t.page_current=1):(Object.each(e,(function(e,i){t[i]=e})),t.limit=Math.max(t.limit,1),t.offset=Math.max(t.offset,0),t.limit>t.total&&(t.offset=0),t.limit||(t.offset=0,t.limit=t.total),t.page_total=Math.ceil(t.total/t.limit),t.offset>t.total&&(t.offset=(t.page_total-1)*t.limit),t.page_current=Math.floor(t.offset/t.limit)+1),this.fireEvent("afterSetData",{data:e})}}),function(){var e=function(e,t,i,n,o){var a=i[n-o]||i.max,s=e.getChildren().length-1;e.getChildren().each((function(e,t){t>0&&t<s&&(a[t].value<=48?e.removeClass("overflow-ellipsis"):e.addClass("overflow-ellipsis"))}))};this.Files||(this.Files={}),Files.Pathway=new Class({Implements:[Options],element:!1,options:{element:"files-pathway",offset:8},initialize:function(e){this.setOptions(e)},setPath:function(t){this.element||(this.element=document.id(this.options.element)),this.element.getParent();var i=this.element;i.empty();var n=new Element("ul"),o=function(e,t,i,n){var o,a;return o=new Element("li",{events:{click:function(){e.navigate(i)}}}),a=new Element("a",{class:"k-breadcrumb__content",html:t}),o.grab(a),o},a="",s="";t.options.root_path&&(a=s=t.options.root_path);var r=o(t,'<span class="k-icon-home" aria-hidden="true"></span><span class="k-visually-hidden">'+t.container.title+"</span>",a).addClass("k-breadcrumb__home").getElement("a").getParent();n.adopt(r);var l=t.getPath();s&&(l=l.replace(s,""));var c=l.split("/");a=s;if(c.each((function(e){e.trim()&&(a+=a?"/"+e:e,n.adopt(o(t,e,a)))})),n.getLast().addClass("k-breadcrumb__active"),i.setStyle("visibility","hidden"),i.adopt(n),this.pathway&&(window.removeEvent("resize",this.pathway),this.pathway=!1),n.getChildren().length>2){var d={},u=0,h=n.getFirst().getSize().x+n.getLast().getSize().x;n.getChildren().each((function(e,t){if(!e.match(":first-child")&&!e.match(":last-child")){var i=e.getSize().x;d[t]={key:t,value:i},u+=i}}));var p={},f=u;for(p[u]=p.max=d;f>0;){--f;var g={key:null,value:0},m={};for(var v in d)if(d.hasOwnProperty(v)){var y=d[v];y.value>g.value&&(g=y),m[v]={key:y.key,value:y.value}}--m[g.key].value,p[f]=m,d=m}e(n,0,p,i.getSize().x,h),i.setStyle("visibility","visible"),this.pathway=function(){e(n,0,p,i.getSize().x,h)},window.addEvent("resize",this.pathway)}else i.setStyle("visibility","visible")}})}(),!Files)var Files={};if(Files.blank_image="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAMAAAAoyzS7AAAABGdBTUEAALGPC/xhBQAAAAd0SU1FB9MICA0xMTLhM9QAAAADUExURf///6fEG8gAAAABdFJOUwBA5thmAAAACXBIWXMAAAsSAAALEgHS3X78AAAACklEQVQIHWNgAAAAAgABz8g15QAAAABJRU5ErkJggg==",Files.App=new Class({Implements:[Events,Options],_tmpl_cache:{},active:null,title:"",cookie:null,options:{root_path:"",root_text:"Root folder",cookie:{name:null,path:"/"},persistent:!0,thumbnails:!0,types:null,container:null,active:null,pathway:{element:"files-pathway"},state:{defaults:{}},tree:{enabled:!0,element:"#files-tree"},grid:{element:"files-grid",batch_delete:"#toolbar-delete",icon_size:150},paginator:{element:"files-paginator"},folder_dialog:{view:"#files-new-folder-modal",input:"#files-new-folder-input",open_button:".js-open-folder-modal",create_button:"#files-new-folder-create",onSubmit:function(){},onCreate:function(e){e.input.set("value",""),e.create_button.removeClass("valid").setProperty("disabled","disabled")},onOpen:function(e){kQuery.magnificPopup.open({items:{src:kQuery(e.view),type:"inline"},callbacks:{open:function(){setTimeout((function(){e.input.focus()}),100)}}})},onClose:function(){kQuery.magnificPopup.close()},onInit:function(e){var t=kQuery(e.input),i=kQuery(e.create_button),n=function(){kQuery.trim(kQuery(this).val())?i.addClass("valid").prop("disabled",!1):i.removeClass("valid").prop("disabled",!0)};t.on("change",n),window.addEventListener?t.on("input",n):t.on("keyup",n)}},uploader_dialog:{view:"#files-upload",button:"#toolbar-upload"},move_dialog:{view:"#files-move-modal",button:".btn-primary",open_button:"#toolbar-move"},copy_dialog:{view:"#files-copy-modal",button:".btn-primary",open_button:"#toolbar-copy"},history:{enabled:!0},router:{defaults:{option:"com_files",view:"files",format:"json"}},initial_response:null,refresh_button:"#toolbar-refresh",onAfterSetGrid:function(){window.addEvent("resize",function(){this.setDimensions(!0)}.bind(this)),this.grid.addEvent("onAfterRenew",function(){this.setDimensions(!0)}.bind(this)),this.addEvent("onUploadFile",function(){this.setDimensions(!0)}.bind(this))},onAfterNavigate:function(e){void 0!==e&&(this.setTitle(this.folder.name||this.container.title),kQuery("#upload-files-to, .upload-files-to").text(e||this.container.title))},onBeforeSetContainer:function(e){void 0!==e.container&&(e.container.title=this.options.root_text)}},initialize:function(e){if(Files.Config&&Object.merge(e,Files.Config),this.setOptions(e),this.fireEvent("onInitialize",this),this.options.cookie.name&&(this.cookie=this.options.cookie.name),null===this.cookie&&this.options.persistent&&this.options.container){var t="string"==typeof this.options.container?this.options.container:this.options.container.slug;this.cookie="com.files.container."+t}this.options.pathway&&this.setPathway(),this.setState(),this.setHistory(),this.setGrid(),this.setPaginator();var i=this.getUrl();if(i.getData("container")&&!this.options.container&&(this.options.container=i.getData("container")),i.getData("folder")&&(this.options.active=i.getData("folder")),this.options.thumbnails&&this.addEvent("afterSelect",(function(e){this.setThumbnails()})),this.options.uploader_dialog&&this.setUploaderDialog(),this.options.container&&this.setContainer(this.options.container),this.options.refresh_button){var n=document.getElement(this.options.refresh_button),o=this;n&&n.addEvent("click",(function(e){e.stop(),o.navigate(void 0,"stateless",!0),o.setTree()}))}},setState:function(){if(this.fireEvent("beforeSetState"),this.cookie&&this.options.persistent){var e=Cookie.read(this.cookie+".state"),t=JSON.decode(e,!0);t&&(void 0===this.getUrl().getData("folder")&&(this.options.active=t.folder),delete t.folder,this.options.state.defaults=Object.merge({},this.options.state.defaults,t))}var i=this.options.state;this.state=new Files.State(i),this.fireEvent("afterSetState")},setHistory:function(){if(this.fireEvent("beforeSetHistory"),this.options.history.enabled){var e=this;this.history=History,window.addEvent("popstate",(function(t){t&&t.stop();var i=History.getState(),n=e.state.getData(),o=i.data,a=!1;if(Object.each(n,(function(e,t){!0!==a&&o&&o[t]&&e!==o[t]&&(a=!0)})),e.container&&(a||e.active!==i.data.folder)){var s=Object.append({},i.data);["option","view","layout","folder","container"].each((function(e){delete s[e]})),e.state.set(s),e.navigate(i.data.folder,"stateless")}})),this.addEvent("afterNavigate",(function(t,i){if("stateless"!==i&&e.history){var n={folder:e.active,container:e.container?e.container.slug:null},o=this.state.getData();Object.each(o,(function(e,t){"function"!=typeof e&&void 0!==e&&(n[t]=e)}));var a="initial"===i?"replaceState":"pushState",s=e.getUrl().setData(n,!0).set("fragment","").toString();e.history[a](n,null,s)}}))}this.fireEvent("afterSetHistory")},navigate:function(e,t,i,n){this.fireEvent("beforeNavigate",[e,t]),void 0!==e&&(this.active&&this.state.set("offset",0),this.active="/"==e?"":e),this.grid.reset(),this.grid.spin();var o=this.active.split("/"),a=o[o.length?o.length-1:0],s=o.slice(0,o.length-1).join("/"),r=this,l=function(e){return i&&(e.revalidate_cache=1),e._=Date.now(),this.createRoute(e)}.bind(this),c=function(e){e&&(!1!==e.status?(Object.each(e.entities,(function(e){e.baseurl||(e.baseurl=r.baseurl)})),r.grid.insertRows(e.entities),e.partial||(r.grid.unspin(),r.response=e,r.fireEvent("afterSelect",e))):e.error&&alert(e.error))};if(this.folder=new Files.Folder({folder:s,name:a}),n?(c(n),this.grid.unspin()):this.fetch(this.folder.path,l).done(c).progress(c),this.cookie){var d=kQuery.extend(!0,{},this.state.data);d.folder=this.active,Cookie.write(this.cookie+".state",JSON.encode(d),this.options.cookie)}this.fireEvent("afterNavigate",[e,t])},fetch:function(e,t){var i=this,n=kQuery.Deferred(),o=function(e){var t=JSON.decode(e.responseText,!0);t&&t.error&&alert(t.error)},a=Object.append({view:"nodes",folder:e},this.state.getData());if(this.ajax_cache&&this.ajax_cache.abort(),void 0!==a.limit&&0!==a.limit)return this.ajax_cache=kQuery.getJSON(t(a)).fail(o),this.ajax_cache;a.limit=100;var s=function(e){e&&void 0!==e.entities&&void 0!==e.meta?e.meta.offset+e.entities.length<e.meta.total?(e.partial=!0,n.notify(e),a.offset=e.meta.offset+e.meta.limit,i.ajax_cache=kQuery.getJSON(t(a)).done(s).fail(o)):(e.completed=!0,n.resolve(e)):n.reject("")};return i.ajax_cache=kQuery.getJSON(t(a)).done(s).fail(o),n.promise()},setContainer:function(e){var t=function(e){if(this.fireEvent("beforeSetContainer",{container:e}),this.container=e,this.baseurl=Files.sitebase+"/"+e.relative_path,this.active="",this.uploader&&(this.container.parameters.allowed_extensions&&(this.uploader.settings.filters=[{title:Koowa.translate("All Files"),extensions:this.container.parameters.allowed_extensions.join(",")}]),this.container.parameters.maximum_size)){this.uploader.settings.max_file_size=this.container.parameters.maximum_size;var t=document.id("upload-max-size");t&&t.set("html",new Files.Filesize(this.container.parameters.maximum_size).humanize())}!0===this.container.parameters.thumbnails?this.state.set("thumbnails",this.options.thumbnails):this.options.thumbnails=!1,null!==this.options.types&&(this.options.grid.types=this.options.types,this.state.set("types",this.options.types)),this.options.folder_dialog&&document.getElement(this.options.folder_dialog.view)&&document.getElement(this.options.folder_dialog.view).getElement("form")&&this.setFolderDialog(),this.options.move_dialog&&(this.move_dialog=new Files.MoveDialog(this.options.move_dialog)),this.options.copy_dialog&&(this.copy_dialog=new Files.CopyDialog(this.options.copy_dialog)),this.fireEvent("afterSetContainer",{container:e}),this.setTree(),this.active=this.options.active||"",this.options.active="","string"==typeof this.options.initial_response&&(this.options.initial_response=JSON.decode(this.options.initial_response)),this.navigate(this.active,"initial",!1,this.options.initial_response)}.bind(this);"string"==typeof e?new Request.JSON({url:this.createRoute({view:"container",slug:e,container:!1}),method:"get",onSuccess:function(e){t(e.entities[0])}.bind(this)}).send():t(e)},setPaginator:function(){this.fireEvent("beforeSetPaginator");var e=this.options.paginator,t=this.state;Object.append(e,{state:t,onClickPage:function(e){this.state.set("limit",e.get("data-limit")),this.state.set("offset",e.get("data-offset")),this.navigate()}.bind(this),onChangeLimit:function(e){this.state.set("limit",e);var t=Files.app.paginator.values.total,i=Files.app.paginator.values.offset;t&&(i=e?Math.floor(i/e*e):0),this.state.set("offset",i),this.navigate()}.bind(this)}),this.paginator=new Files.Paginator(e.element,e);var i=this;i.addEvent("afterSelect",(function(e){i.paginator.setData({limit:e.meta.limit,offset:e.meta.offset,total:e.meta.total}),i.paginator.setValues()})),this.fireEvent("afterSetPaginator")},setGrid:function(){this.fireEvent("beforeSetGrid");var e=this,t=this.options.grid,i=this.cookie+".grid.layout";this.cookie&&Cookie.read(i)&&(t.layout=Cookie.read(i)),Object.append(t,{onClickFolder:function(e){var t=document.id(e.target),i=(t.getParent(".files-node-shadow")||t.getParent(".files-node")).retrieve("row").path;i&&this.navigate(i)}.bind(this),onClickImage:function(t){var i=document.id(t.target),n=(i.getParent(".files-node-shadow")||i.getParent(".files-node")).retrieve("row"),o=e.createRoute({view:"file",format:"html",name:n.name,folder:n.folder});o&&kQuery.magnificPopup.open({items:{src:o,type:"image"}})},onClickFile:function(e){var t=document.id(e.target),i=(t.getParent(".files-node-shadow")||t.getParent(".files-node")).retrieve("row"),n=Object.append({},i);n.template="file_preview",n=n.render();var o=kQuery(n);o.addClass("mfp-hide k-ui-namespace"),kQuery.magnificPopup.open({items:{src:o,type:"inline"}})},onBeforeRenderObject:function(t){var i=t.object;i.download_link=e.createRoute({view:"file",format:"html",name:i.name,folder:i.folder})}.bind(this),onAfterSetLayout:function(t){if("icons"===t.layout||"details"===t.layout){var n="icons"===t.layout?"gallery":"table",o="gallery"===n?"table":"gallery";this.container.removeClass("k-"+o).addClass("k-"+n),kQuery("#files-grid-container").removeClass("k-"+o+"-container").addClass("k-"+n+"-container"),kQuery("#files-paginator-container").removeClass("k-"+o+"-pagination").addClass("k-"+n+"-pagination")}i&&Cookie.write(i,t.layout,e.options.cookie)},onAfterRender:function(){this.setState(e.state.data),e.grid&&(e.setThumbnails(),kodekitUI.gallery())},onSetState:function(e){this.state.set(e),this.navigate()}.bind(this),onAfterInsertRows:function(){this.setFootable()}}),this.grid=new Files.Grid(this.options.grid.element,t),this.fireEvent("afterSetGrid")},setTree:function(){if(this.fireEvent("beforeSetTree"),this.options.tree.enabled){var e=Object.merge({root_path:this.options.root_path},this.options.tree);that=this,e=kQuery.extend(!0,{},{onSelectNode:function(e){if(e.id||e.url){var t=e&&e.id?e.id:"";t!=that.active&&that.navigate(t)}},root:{text:this.options.root_text},initial_response:!!this.options.initial_response},e),this.tree=new Files.Tree(kQuery(e.element),e);var t={view:"folders",tree:"1",limit:"2000"};this.options.root_path&&(t.folder=this.options.root_path),this.tree.fromUrl(this.createRoute(t)),this.addEvent("afterNavigate",(function(e,t){void 0===e||t&&("initial"==t||"stateless"==t)||that.tree.selectPath(e)})),this.grid&&this.grid.addEvent("afterDeleteNode",(function(e){var t=e.node;"folder"==t.type&&that.tree.removeNode(t.path)}))}this.fireEvent("afterSetTree")},setFolderDialog:function(){var e=this;this._folder_dialog={view:document.getElement(this.options.folder_dialog.view),input:document.getElement(this.options.folder_dialog.input),open_button:document.getElement(this.options.folder_dialog.open_button),create_button:document.getElement(this.options.folder_dialog.create_button)},this.options.folder_dialog.onInit&&this.options.folder_dialog.onInit.call(this,this._folder_dialog),this._folder_dialog.open_button&&this._folder_dialog.open_button.addEvent("click",(function(e){e.stop(),this.hasClass("unauthorized")||Files.app.openFolderDialog()})),this._folder_dialog.view.getElement("form")&&this._folder_dialog.view.getElement("form").addEvent("submit",(function(t){t.stop(),e._folder_dialog.create_button.setProperty("disabled","disabled"),e.options.folder_dialog.onSubmit&&e.options.folder_dialog.onSubmit.call(e,e._folder_dialog);var i=e._folder_dialog.input.get("value").trim();i.length>0&&new Files.Folder({name:i,folder:Files.app.getPath()}).add((function(t,i){if(!1===t.status)return alert(t.error);var n=t.entities[0],o=new(0,Files[n.type.capitalize()])(n);Files.app.grid.insert(o),Files.app.tree.appendNode({id:o.path,label:o.name}),e.options.folder_dialog.onCreate&&e.options.folder_dialog.onCreate.call(e,e._folder_dialog),e.closeFolderDialog()}),null,(function(){e._folder_dialog.create_button.setProperty("disabled",!1)}))}))},openFolderDialog:function(){return this.options.folder_dialog&&this.options.folder_dialog.onOpen.call(this,this._folder_dialog),!!this.options.folder_dialog},closeFolderDialog:function(){return this.options.folder_dialog&&this.options.folder_dialog.onClose.call(this,this._folder_dialog),!!this.options.folder_dialog},setUploaderDialog:function(){var e=this,t=document.getElement(this.options.uploader_dialog.button);document.getElement(this.options.uploader_dialog.view)&&(this._tmp_uploader=new Element("div",{style:"display:none"}).inject(document.body),document.getElement(this.options.uploader_dialog.view).getParent().inject(this._tmp_uploader).setStyle("visibility","")),t&&t.addEvent("click",(function(t){t.stop(),this.hasClass("unauthorized")||e.openUploaderDialog()}))},openUploaderDialog:function(){if(this.uploader){var e=this,t=function(){document.getElement(e.options.uploader_dialog.view).getParent().inject(e._tmp_uploader),SqueezeBox.removeEvent("close",t)};SqueezeBox.addEvent("close",t),SqueezeBox.open(document.getElement(e.options.uploader_dialog.view).getParent(),{handler:"adopt",size:{x:700,y:document.getElement(e.options.uploader_dialog.view).getParent().measure((function(){this.setStyle("width",700);var e=this.getSize().y;return this.setStyle("width",""),e}))}}),window.addEvent("QueueChanged",this._changeUploaderDialogHeight.bind(this))}return!!this.uploader},closeUploaderDialog:function(){return this.uploader&&(SqueezeBox.close(),window.removeEvent("QueueChanged",this._changeUploaderDialogHeight)),!!this.uploader},_changeUploaderDialogHeight:function(){var e=document.getElement(this.options.uploader_dialog.view).getParent().scrollHeight;SqueezeBox.resize({x:700,y:e})},getUrl:function(){return new URI(window.location.href)},getPath:function(){return this.active},setThumbnails:function(){this.setDimensions(!0);var e=this.grid.nodes;e.getLength()&&e.each((function(e){var t=e.element.getElement("img.image-thumbnail");if(t){t.addEvent("load",(function(){this.addClass("loaded")}));var i=Files.blank_image;e.thumbnail?i=Files.sitebase+"/"+e.encodePath(e.thumbnail.relative_path,Files.urlEncoder):e.download_link&&(i=e.download_link),t.set("src",i),(e.element.getElement(".files-node")||e.element).addClass("loaded").removeClass("loading")}}))},setDimensions:function(e){if(this._cached_grid_width||(this._cached_grid_width=0),this._cached_grid_width!=this.grid.root.element.getSize().x||e){var t=this.grid.root.element.getSize().x/(this.grid.options.icon_size.toInt()+40),i=Math.min(Math.floor(t),this.grid.nodes.getLength());this.grid.root.element.getElements(".files-node-shadow").each((function(e,t,n){e.setStyle("width",100/i+"%")}),this),this._cached_grid_width=this.grid.root.element.getSize().x}},setPathway:function(){this.fireEvent("beforeSetPathway");var e=new Files.Pathway(this.options.pathway);this.addEvent("afterSetTitle",e.setPath.bind(e,this)),this.fireEvent("afterSetPathway")},setTitle:function(e){this.fireEvent("beforeSetTitle",{title:e}),this.title=e,this.fireEvent("afterSetTitle",{title:e})},createRoute:function(e){!1!==(e=Object.merge({},this.options.router.defaults,e||{})).container&&!e.container&&this.container?e.container=this.container.slug:delete e.container,"html"==e.format&&delete e.format;var t="?"+new Hash(e).filter((function(e,t){return"function"!=typeof e})).toQueryString();return this.options.base_url?this.options.base_url+t:t}}),Files||(Files={}),Files.Compact={},Files.Compact.App=new Class({Extends:Files.App,Implements:[Events,Options],cookie:null,options:{persistent:!1,types:["file","image"],editor:null,preview:"files-preview",state:{defaults:{limit:0,offset:0}},grid:{layout:"compact",batch_delete:!1},history:{enabled:!1},uploader_dialog:!1,folder_dialog:!1,copy_dialog:!1,move_dialog:!1},initialize:function(e){this.parent(e),this.editor=this.options.editor,this.preview=document.id(this.options.preview)},setPaginator:function(){},setGrid:function(){var e=this.options.grid,t=this;Object.append(e,{onClickImage:function(e){var i=document.id(e.target),n=i.getParent(".files-node-shadow")||i.getParent(".files-node");n.getParent().getChildren().removeClass("active"),n.addClass("active");var o=n.retrieve("row"),a=Object.append({},o);a.template="details_image",t.preview.empty(),a.render("compact").inject(t.preview),t.preview.getElement("img").set("src",a.image).setStyle("display","block")},onClickFile:function(e){var i=document.id(e.target),n=i.getParent(".files-node-shadow")||i.getParent(".files-node");n.getParent().getChildren().removeClass("active"),n.addClass("active");var o=n.retrieve("row"),a=Object.append({},o);a.template="details_file",t.preview.empty(),a.render("compact").inject(t.preview)},onAfterRender:function(){this.setState(t.state.data)},onSetState:function(e){this.state.set(e),this.navigate()}.bind(this)}),this.grid=new Files.Grid(this.options.grid.element,e)}}),Files.Attachments||(Files.Attachments={}),Files.Attachments.App=new Class({Extends:Files.App,Implements:[Events,Options],cookie:!1,attachments:{},options:{url:null,pathway:!1,persistent:!1,types:["file","image"],preview:"files-preview",state:{defaults:{limit:0,offset:0}},grid:{cookie:!1,layout:"attachments",element:"attachments-container"},history:{enabled:!1},uploader_dialog:!1,folder_dialog:!1,copy_dialog:!1,move_dialog:!1,onAfterNavigate:function(e){}},initialize:function(e){this.url=e.url,this.parent(e),this.preview=document.id(this.options.preview);(callback=e.callback)&&"function"==typeof window.parent[callback]&&window.parent[callback](this)},navigate:function(e,t,i,n){this.fireEvent("beforeNavigate",[e,t]);var o=this;if(this.url){var a=this.url;a+="&_"+Date.now(),o.grid.reset(),this.grid.spin(),new Request.JSON({url:a,method:"get",onSuccess:function(e){o.grid.insertRows(e.entities),o.grid.unspin()}}).send()}this.fireEvent("afterNavigate",[e,t])},setPaginator:function(){},setGrid:function(){var e=this.options.grid,t=this;Object.append(e,{onClickAttachment:function(e){var i=document.id(e.target),n=i.getParent(".files-node-shadow")||i.getParent(".files-node");n.getParent().getChildren().removeClass("active"),n.addClass("active");var o=n.retrieve("row"),a=Object.append({},o);a.template="details_attachment",t.preview.empty(),a.render("attachments").inject(t.preview),"image"==a.file.type&&(a.file.thumbnail?t.preview.getElement("img").set("src",Files.sitebase+"/"+o.encodePath(a.file.thumbnail.relative_path,Files.urlEncoder)).setStyle("display","block"):t.preview.getElement("img").set("src",t.createRoute({view:"file",format:"html",name:a.file.name,routed:1}))),t.grid.selected=o.name}}),this.grid=new Files.Attachments.Grid(this.options.grid.element,e)}}),Files.Attachments.Grid=new Class({Extends:Files.Grid,select:function(e){"string"==typeof e&&(e=this.nodes.get(e));var t="click"+e.type.capitalize();this.fireEvent(t,{target:e.element.getElement("a.navigate")})},unselect:function(){this.container.getElements(".files-node").removeClass("active"),this.selected=null},attachEvents:function(){var e=this;this.container.addEvent("click:relay(.files-attachment a.navigate)",(function(t){t.stop(),e.fireEvent("clickAttachment",arguments)}))},insertRows:function(e){this.fireEvent("beforeInsertRows",{rows:e}),Object.each(e,function(e){var t=new Files.Attachment(e);this.insert(t,"last")}.bind(this)),this.options.icon_size&&this.setIconSize(this.options.icon_size),this.fireEvent("afterInsertRows",{rows:e})}}),Files.Template.Attachments=new Class({initialize:function(e){var t=new Element("div",{html:e}).getFirst();return t.getElement(".template-item")&&(t=t.getElement(".template-item").getFirst()),t}}),Files.Attachment=new Class({Extends:Files.Row,type:"attachment",template:"attachment",initialize:function(e,t){this.parent(e,t),this.size=new Files.Filesize(this.file.metadata.size),this.filetype=Files.getFileType(this.file.metadata.extension)},delete:function(e,t){"function"==typeof e&&e()},getAttachedDate:function(e){if(this.attached_on_timestamp){var t=new Date;return t.setTime(1e3*this.attached_on_timestamp),e?t.toLocaleString("default",{year:"numeric",month:"short",day:"numeric"}):t}return null}}),!Files)var Files={};if(function(e){Files.createUploader=function(t){t=e.extend({},{element:"#files-upload-multi",container:Files.app.container,multi_selection:!0,url:Files.app.createRoute({view:"file",plupload:1,thumbnails:Files.app.options.thumbnails}),multipart_params:{_action:"add",csrf_token:Files.token,folder:Files.app.getPath()},check_duplicates:!0,chunking:!0,autostart:!0,uploaded:function(e,t){var i,n,o,a=t.result.response;if(a.status&&void 0!==Files.app){if(o=((i=a.entities[0]).folder?i.folder+"/":"")+i.name,void 0===Files.app.grid.nodes[o])n=new(0,Files[i.type.capitalize()])(i),Files.app.grid.insert(n);else n=Files.app.grid.nodes[o],i.metadata&&(n.metadata=i.metadata,n.size=new Files.Filesize(n.metadata.size));if("image"==n.type){var s=n.element.getElement("img");if(s){!function(e){var t=Files.blank_image;e.thumbnail?t=Files.sitebase+"/"+e.encodePath(e.thumbnail.relative_path,Files.urlEncoder):e.download_link&&(t=e.download_link),s.set("src",t).addClass("loaded").removeClass("loading");var i=e.element.getElement(".files-node");i&&i.addClass("loaded").removeClass("loading")}(n),window.fireEvent("resize")}}Files.app.fireEvent("uploadFile",[n])}}},t);var i=kQuery(t.element);delete t.element,0!==i.length&&(i.uploader(t),Files.app.uploader=i.uploader("instance").getUploader(),Files.app.addEvent("afterNavigate",(function(e,t){void 0!==Files.app.uploader&&(Files.app.uploader.settings.multipart_params.folder=Files.app.getPath())})))}}(kQuery),!Files)var Files={};!function(e){var t=Koowa.Class.extend({initialize:function(t){this.supr(),t={view:e(t.view),tree:e(t.view).find(".k-js-tree-container"),button:e(t.button,t.view),open_button:e(t.open_button)},this.setOptions(t),this.attachEvents()},setTree:function(t){var i=Files.app;if(i.tree)t.tree("loadData",e.parseJSON(i.tree.tree("toJson")));else{var n={root_path:i.options.root_path,root:{text:i.options.root_text},element:e("<div></div>"),initial_response:!!this.options.initial_response};i.tree=new Files.Tree(n.element,n);var o={view:"folders",tree:"1",limit:"2000"};i.options.root_path&&(o.folder=i.options.root_path),i.tree.fromUrl(i.createRoute(o),(function(){t.tree("loadData",e.parseJSON(i.tree.tree("toJson")))})),i.addEvent("afterNavigate",(function(e,t){void 0===e||t&&("initial"==t||"stateless"==t)||i.tree.selectPath(e)})),i.grid&&i.grid.addEvent("afterDeleteNode",(function(e){var t=e.node;"folder"==t.type&&i.tree.removeNode(t.path)}))}return i.tree},attachEvents:function(){var e=this;this.options.open_button&&this.options.open_button.click((function(t){t.preventDefault(),e.show()})),this.options.view.find("form")&&this.options.view.find("form").submit((function(t){t.preventDefault(),e.submit()}))},show:function(){var t=this.options,i=Object.getLength(this.getSelectedNodes());if(!t.open_button.hasClass("unauthorized")&&i){var n=new Koowa.Tree(this.options.tree,{onCanSelectNode:function(e){return e.path!=Files.app.getPath()}});this.setTree(n),this.getSelectedNodes().each((function(e){var t=n.tree("getNodeById",e.path);t&&n.tree("removeNode",t)})),e.magnificPopup.open({items:{src:e(t.view),type:"inline"}})}},hide:function(){this.options.tree instanceof e&&this.options.tree.empty(),e.magnificPopup.close()},getSelectedNodes:function(){return Files.app.grid.nodes.filter((function(e){return e.checked}))},handleError:function(e){var t=JSON.decode(e.responseText,!0);this.hide(),t&&t.error&&alert(t.error)}});Files.CopyDialog=t.extend({submit:function(){var t=this,i=this.getSelectedNodes(),n=Object.values(i.map((function(e){return e.name}))),o=this.options.view.find(".k-js-tree-container").tree("getSelectedNode").path,a=Files.app.createRoute({view:"nodes",folder:Files.app.getPath()});n.length&&(this.options.button.prop("disabled",!0),Files.app.grid.fireEvent("beforeCopyNodes",{nodes:i}),e.ajax(a,{type:"POST",data:{name:n,destination_folder:o||"",_action:"copy",csrf_token:Files.token}}).done((function(e){var n=Files.app.tree,o=!1;i.each((function(e){n.tree("getNodeById",e.path)&&(o=!0)})),Files.app.grid.fireEvent("afterCopyNodes",{nodes:i}),o&&n.fromUrl(Files.app.createRoute({view:"folders",tree:"1",limit:"2000"})),t.hide()})).fail(e.proxy(this.handleError,this)).always((function(){t.options.button.prop("disabled",!1)})))}}),Files.MoveDialog=t.extend({submit:function(){var t=this,i=this.getSelectedNodes(),n=Object.values(i.map((function(e){return e.name}))),o=this.options.view.find(".k-js-tree-container").tree("getSelectedNode").path,a=Files.app.createRoute({view:"nodes",folder:Files.app.getPath()});n.length&&(this.options.button.prop("disabled",!0),Files.app.grid.fireEvent("beforeMoveNodes",{nodes:i}),e.ajax(a,{type:"POST",data:{name:n,destination_folder:o||"",_action:"move",csrf_token:Files.token}}).done((function(e){var n=Files.app.tree,o=!1;i.each((function(e){e.element&&e.element.dispose(),Files.app.grid.nodes.erase(e.path),n.tree("getNodeById",e.path)&&(o=!0)})),Files.app.grid.fireEvent("afterMoveNodes",{nodes:i}),o&&n.fromUrl(Files.app.createRoute({view:"folders",tree:"1",limit:"2000"})),t.hide()})).fail(e.proxy(this.handleError,this)).always((function(){t.options.button.prop("disabled",!1)})))}})}(window.kQuery);